// Generated with grunt. Do not edit!


angular.$=angular.element,angular.$.prototype.parent=function(e){if(!e)return angular.$(this[0].parentNode);for(var t,n=[].slice.call(document.querySelectorAll(e)),i=this[0];"HTML"!==i.nodeName;){i=i.parentNode,-1===n.indexOf(i)||(t=i,i=document.documentElement)}return angular.$(t)};"use strict";var debug=!0;angular.module("seroApp.services",[]),angular.module("seroApp.directives",[]),angular.module("seroApp.controllers",[]),angular.module("pax.validations",[]);var seroApp=angular.module("seroApp",["ngRoute","ngResource","ngAnimate","ngMessages","ngSanitize","ui.bootstrap","ui.select2","ngFileUpload","ui.grid","ui.grid.edit","ui.grid.rowEdit","ui.grid.cellNav","ui.grid.resizeColumns","ui.grid.moveColumns","ui.grid.selection","seroApp.services","seroApp.directives","seroApp.controllers","pax.validations"]).config(["$routeProvider",function(e){var t={templateUrl:"partials/projectTabs.html",controller:"ProjectTabsController"};e.when("/",{templateUrl:"partials/home.html",controller:"HomeController"}),e.when("/projects",{templateUrl:"partials/projects.html",controller:"ProjectsController"}),e.when("/projects/:projectId",t),e.when("/projects/:projectId/eiaspermits",t),e.when("/projects/:projectId/eiaspermits/:eiapermitId",t),e.when("/projects/:projectId/eiaspermits/:eiapermitId/documents",t),e.when("/projects/:projectId/eiaspermits/:eiapermitId/documents/:documentId",t),e.when("/projects/:projectId/eiaspermits/:eiapermitId/documents/:documentId/hearings",t),e.when("/projects/:projectId/eiaspermits/:eiapermitId/documents/:documentId/hearings/:hearingId",t),e.when("/projects/:projectId/externalaudits",t),e.when("/projects/:projectId/externalaudits/:externalauditId",t),e.when("/projects/:projectId/externalaudits/:externalauditId/documents",t),e.when("/projects/:projectId/externalaudits/:externalauditId/documents/:documentId",t),e.when("/projects/:projectId/auditsinspections",t),e.when("/projects/:projectId/auditsinspections/:auditinspectionId",t),e.when("/projects/:projectId/permitslicenses",t),e.when("/projects/:projectId/permitslicenses/:permitlicenseId",t);var n={templateUrl:"partials/searchTabs.html",controller:"SearchTabsController"};e.when("/search",{redirectTo:"/search/projects"}),e.when("/search/projects",n),e.when("/search/eiaspermits",n),e.when("/search/permitslicenses",n),e.when("/search/auditsinspections",n),e.when("/search/externalaudits",n);e.when("/statistics",{redirectTo:"/statistics/projects"}),e.when("/statistics/projects",{templateUrl:"partials/statisticsTabs.html",controller:"StatisticsTabsController"}),e.when("/advanced/codes",{templateUrl:"partials/advancedCodes.html",controller:"AdvancedCodesController"}),e.when("/advanced/users",{templateUrl:"partials/advancedUsers.html",controller:"AdvancedUsersController"}),e.when("/advanced/leadagencies",{templateUrl:"partials/advancedLeadAgency.html",controller:"AdvancedLeadAgenciesController"}),e.when("/advanced/pirking/statusEIA",{templateUrl:"partials/eiapermit-pirking.html",controller:"EiapermitPirkingController"}),e.when("/advanced/pirking/statusEA",{templateUrl:"partials/externalAudit-pirking.html",controller:"ExternalAudiPirkingController"}),e.when("/advanced/pirking/statusAI",{templateUrl:"partials/auditInspection-pirking.html",controller:"AuditInspecitionPirkingController"}),e.when("/about",{templateUrl:"partials/about.html"}),e.when("/login",{templateUrl:"partials/login.html",controller:"UserController"}),e.when("/password/send",{templateUrl:"partials/passwordSend.html",controller:"LoginController"}),e.when("/password/reset/:token",{templateUrl:"partials/passwordReset.html",controller:"LoginController"}),e.when("/user",{templateUrl:"partials/user.html",controller:"UserController"}),e.when("/practitioners",{templateUrl:"partials/practitioners.html",controller:"PractitionersController"}),e.otherwise({redirectTo:"/"})}]).factory("authHttpResponseInterceptor",["$q","$location",function(t,n){return{responseError:function(e){return 0==n.path().indexOf("/password/reset/")||401===e.status&&n.path("/login"),t.reject(e)}}}]).config(["$httpProvider",function(e){e.interceptors.push("authHttpResponseInterceptor")}]),SavingStateEnum={None:"None",LoadingNew:"Loading new",Loading:"Loading",Loaded:"Loaded",SavingStarted:"Saving started",SavingFinished:"Saving finished",SavingFailed:"Saving failed",Invalid:"Form not valid",MissingDependency:"Missing dependency in other form"},DisplayStateEnum={Show:!0,Hide:!1},ProjectTabEnum={Project:"Project",EiasPermits:"EIAS",PermitsLicenses:"Permits and Licenses",AuditsInspections:"Audits and Inspections",ExternalAudits:"External audits"},EiasPermitsTabEnum={EiaPermit:"EIA",Documents:"Documents",Hearings:"Hearings"},ExternalAuditsTabEnum={ExternalAudit:"External audit",Documents:"Documents",Hearings:"Hearings"},SearchTabEnum={Projects:"Projects",EiasPermits:"EIAS",PermitsLicenses:"Permits and Licenses",AuditsInspections:"Audits and Inspections",ExternalAudits:"External audits"},StatisticsTabEnum={Projects:"Projects",EiasPermits:"EIAS",AuditsInspections:"Audits and Inspections"},DocumentTagEnum={PermitLicenseApplicationForm:"Application form",PermitLicensePermitLicense:"Permit or license",PermitLicenseAttachments:"Attachment to the application"},fileUploadPattern="image/*,application/pdf,application/vnd.openxmlformats*,application/msword,text/plain,text/csv,application/octet-stream,binary/octet-stream",fileUploadNgfPattern="'image/*,application/pdf,application/vnd.openxmlformats*,application/msword,text/plain,text/csv,application/octet-stream,binary/octet-stream'",fileUploadMaxSize="20MB",exportObj={};function so(){console.log("ca")}function isCoordinateWithinUganda(e,t,n){if(!e||!t)return n(!1,{error:"undefined coordinates"});fetch("https://nominatim.openstreetmap.org/reverse?format=json&lat="+e+"&lon="+t,{headers:{"content-type":"application/json"},method:"GET",mode:"cors"}).then(function(e){return e.json()}).then(function(e){return e.address&&"ug"==e.address.country_code?n(!0,e):n(!1,e)}).catch(function(){return n(!1,{error:"network"})})}exportObj.exportMetaData={},exportObj.exportData=function(e,t){var n=this.exportMetaData[t];excelExport(e,n,t)},exportObj.exportMetaData.auditAndInspection={fieldmap:{auditinspection_code:"Control number",auditinspection_status:"Audit and inspection status",auditinspection_year:"Year",auditinspection_type:"Activity",auditinspection_reason:"Type",lead_officer_name:"Lead officer",other_officer_name:"Other officers",auditinspection_date_carried_out:"Date carried out",auditinspection_days:"Number of days",auditinspection_external_participants:"Participants from lead agencies, facilities etc.",auditinspection_coordinated:"Multisectoral",lead_agency_name:"Lead agencies",auditinspection_date_action_taken:"Date of response",auditinspection_action_taken:"Response",auditinspection_advance_notice:"Advanced notice",auditinspection_findings:"Description of findings",auditinspection_performance_level:"Performance level",auditinspection_recommendations:"Recommendations",auditinspection_date_deadline:"Follow-up date",auditinspection_date_closing:"Activity ended",auditinspection_remarks:"Remarks",project_id:"Project ID",project_title:"Project name",category_description:"Category",district_district:"District",organisation_id:"Developer ID",developer_name:"Developer name"},dateFields:["auditinspection_date_carried_out","auditinspection_date_deadline","auditinspection_date_closing","auditinspection_date_action_taken"]},exportObj.exportMetaData.project={fieldmap:{project_id:"Project ID",project_title:"Project name",category_description:"Category",district_district:"District",project_location:"Location",project_longitude:"Longitude",project_latitude:"Latitude",project_has_industrial_waste_water:"Industrial waste water?",project_risk_level:"Risk level",project_contact_person:"Contact person",project_remarks:"Project remarks",organization_id:"Developer ID",developer_name:"Developer name",developer_id:"TIN",organization_visiting_address:"Visiting address",organization_physical_address:"Physical address",organization_box_no:"PO box",organization_city:"City",organization_phone:"Phone",organization_fax:"Fax",organization_email:"Email",organization_remarks:"Developer remarks"},dateFields:[]},exportObj.exportMetaData.exportPermitsLicenses={fieldmap:{permitlicense_id:"Permit and license ID",permitlicense_regulation:"Regulation",permitlicense_date_submitted:"Date of submission",permitlicense_waste_license_type:"Waste license type",permitlicense_ecosystem:"Ecosystem",permitlicense_regulation_activity:"Regulation activity",permitlicense_area:"Area",permitlicense_unit:"Unit",permitlicense_approved_by_the_lc1:"LC1 approved",permitlicense_approved_by_the_dec:"DEC approved",permitlicense_application_number:"Application number",permitlicense_application_fee_receipt_number:"Application fee receipt number",permitlicense_date_feedback_to_applicants:"Date feedback to applicants",permitlicense_date_sent_officer:"Date feedback to applicants",permitlicense_date_sent_to_director:"Date sent to Director",permitlicense_date_sent_from_dep:"Date sent to team leader from dep",permitlicense_date_sent_officer:"Date sent to the officer",permitlicense_officer_assigned:"Team leader",permitlicense_handling_officer:"Officers to handle",permitlicense_officer_evaluation:"Application evaluation by officer",permitlicense_date_of_evaluation:"Date of evaluation",permitlicense_folio_no:"File and foliono.",permitlicense_inspection_recommended:"Inspection before decision ?",permitlicense_date_inspection:"Date of inspection",permitlicense_officer_recommend:"Recommendations by reviewer",permitlicense_fee_receipt_no:"Permit/license fee receipt number",permitlicense_date_fee_payed:"Date permit / license fee paid",permitlicense_date_sent_for_decision:"Date sent for decision",permitlicense_decision:"Decision taken",permitlicense_signature_on_permit_license:"Signature on permit / license",permitlicense_date_permit_license:"Date on the permit / licence",permitlicense_permit_license_no:"Permit / license number",permitlicense_date_permit_license_expired:"Date permit / license expired",permitlicense_documentation_files:"Soft copy",project_id:"Project ID",project_title:"Project name",category_name:"Category",district_district:"District",organisation_id:"Developer ID",organisation_name:"Developer name"},dateFields:["permitlicense_date_submitted","permitlicense_date_sent_to_director","permitlicense_date_sent_from_dep","permitlicense_date_sent_officer","permitlicense_date_of_evaluation","permitlicense_date_inspection","permitlicense_date_fee_payed","permitlicense_date_sent_for_decision","permitlicense_date_permit_license","permitlicense_date_permit_license_expired","permitlicense_date_feedback_to_applicants"]},exportObj.exportMetaData.eiaspermits={fieldmap:{eiapermit_id:"EIA and permit ID",eiapermit_status:"EIA status",practitioner_teamleader:"Practitioner team leader",cost:"Cost of the proposed development",eiapermit_cost_currency:"Cost currency",eiapermit_expected_jobs_created:"Expected jobs created",team_leader_name:"Team leader",personnel_officers_name:"Officers to handle",eias_permits_inspection_recommendation:"Inspection before decision?",eiapermit_date_inspection:"Date of inspection",eiapermit_officer_recommend:"Recommendations by reviewer",eiapermit_fee:"Expected fees",eiapermit_fee_currency:"Fee currency",eiapermit_date_sent_ded_approval:"Date sent for approval",eiapermit_decision:"Decision taken",eiapermit_date_decision:"Date for decision",eiapermit_date_fee_notification:"Date of invoicing",eiapermit_date_fee_payed:"Date invoice is payed",eiapermit_fee_receipt_no:"Fee receipt number",eiapermit_designation:"Signature on certificate",eiapermit_date_certificate:"Date on the certificate",eiapermit_certificate_no:"Certificate number",eiapermit_date_cancelled:"Certificate canceled date",eiapermit_remarks:"Remarks",file_metadata:"Soft copy of certificate",document_codes:"Documents",project_id:"Project ID",project_title:"Project name",category_description:"Category",district_district:"District",developer_id:"Developer ID",developer_name:"Developer name"},dateFields:["eiapermit_date_inspection","eiapermit_date_sent_ded_approval","eiapermit_date_decision","eiapermit_date_fee_notification","eiapermit_date_fee_payed","eiapermit_date_certificate","eiapermit_date_cancelled"]},exportObj.exportMetaData.externalAudit={fieldmap:{externalaudit_id:"External audit ID",project_id:"Project ID",ea_type:"Type of external audit",team_leader:"Team leader",handling_officers:"Officers to handle",verification_inspection:"Verification inspection?",date_inspection:"Date of inspection",date_response:"Date of response",file_metadata_response_id:"Response letter",review_findings:"Review findings",response:"Response",date_deadline_compliance:"Date for complete compliance",doc_code:"Documents",project_project_name:"Project name",category_name:"Category",district_district:"District",organisation_id:"Developer ID",organisation_name:"Developer name"},dateFields:["date_inspection","date_response"]};var regexIso8601=/^(\d{4}-\d{2}-\d{2} \d{2}\:\d{2}\:\d{2})$/;function convertDateStringsToDates(e){if("object"!=typeof e)return e;for(var t in e)if(e.hasOwnProperty(t)){var n,i=e[t];if("string"==typeof i&&(n=i.match(regexIso8601))){var r=n[0].replace(" ","T");r+="Z",e[t]=new Date(r)}else"object"==typeof i&&convertDateStringsToDates(i)}}seroApp.config(["$httpProvider",function(e){e.defaults.transformResponse.push(function(e){return convertDateStringsToDates(e),e})}]);var uploadFile=function(e,t,n,i,r,a){i.$setValidity("serverError",!0);var o=e.defer();return r&&!r.$error?(r.upload=n.upload({url:"/file/v1/upload",file:r,fields:{tag:a}}),r.upload.then(function(e){t(function(){r.result=e.data,o.resolve(r)})},function(e){0<e.status&&(i.$setValidity("serverError",!1),r.progress=0,r.error=e.status+": "+e.data.message,o.reject(r.error))}),r.upload.progress(function(e){r.progress=Math.min(100,parseInt(100*e.loaded/e.total))})):o.reject("Validation error."),o.promise};function addDays(e,t){var n=new Date(e);return n.setDate(n.getDate()+t),n}function updateExternalAuditStatus(e,t){var r=null,n=_.groupBy(t,function(e){return e.type});if(e.date_deadline_compliance)return e.status=147,!0;if(e.date_response)return e.status=146,!0;if(t.length){if(n[12])var i=n[12][0],a={date_submitted:142,date_sent_director:143,date_sent_from_dep:144,date_sent_officer:145};else if(n[11])i=n[11][0],a={date_submitted:137,date_sent_director:138,date_sent_from_dep:139,date_sent_officer:140,date_conclusion:141};return function(e,t){for(var n=Object.keys(t),i=0;i<n.length;i++)e[n[i]]&&(r=t[n[i]])}(i,a),e.status=r,!0}return!1}function updateAuditInspectionStatus(e){return e.date_closing?e.status=75:e.date_received?e.status=74:e.date_deadline&&e.date_deadline<new Date?e.status=73:e.action_taken?e.status=72:e.date_carried_out&&(e.status=71),!![71,72,73,74,75].includes(e.status)}function updateEiaPermitStatus(e,t){var n=e.status,i=null;if(e.date_cancelled)i=37;else if(e.certificate_no)i=36;else if(e.fee_receipt_no)i=35;else if(e.date_fee_notification)i=34;else if(e.date_decision)i=33;else if(e.date_sent_ded_approval)i=32;else{var r=_.groupBy(t,function(e){return e.type}),a=0,o={13:{conclusion:59,date_dispatched:58,date_sent_officer:57,date_sent_from_dep:56,date_sent_director:55,date_submitted:54},10:{date_dispatched:31,date_sent_officer:30,date_sent_from_dep:29,date_sent_director:28,date_submitted:27},9:{conclusion:26,date_dispatched:25,date_sent_officer:24,date_sent_from_dep:23,date_sent_director:22,date_submitted:21},8:{conclusion:20,date_dispatched:19,date_sent_officer:18,date_sent_from_dep:17,date_sent_director:16,date_submitted:15}};_.forEach([13,10,9,8],function(t){var e=r[t];if(e){var n=0;return _.forEach(e,function(e){e.conclusion&&_.includes([78,79],e.conclusion)&&o[t].conclusion?n=o[t].conclusion:e.date_sent_officer?n=o[t].date_sent_officer:e.date_sent_from_dep?n=o[t].date_sent_from_dep:e.date_sent_director?n=o[t].date_sent_director:e.date_submitted&&(n=o[t].date_submitted),a<n&&(a=n)}),!1}}),0<a&&(i=a)}return n!=i&&(e.status=i,!0)}(controllers=angular.module("seroApp.controllers")).controller("DatePickerController",["$scope",function(t){t.open=function(e){e.preventDefault(),e.stopPropagation(),t.opened=!0},t.datepickerOptions={startingDay:1}}]),controllers.controller("DatePickerSearchController",["$scope",function(t){t.open=function(e){e.preventDefault(),e.stopPropagation(),t.opened=!0},t.datepickerOptions={startingDay:1}}]),controllers.controller("NavBarController",["$scope","$location","UserInfo","EnvInfo",function(t,n,e,i){t.userinfo=e,i(function(e){t.envinfo=e.env}),t.isActive=function(e){return e===n.path()},t.isAdvancedActive=function(e){return 0==n.path().indexOf(e)}}]),controllers.controller("HomeController",["$scope","GeneralStatistics",function(t,e){t.counts={},e.get({},function(e){t.counts=e.counts})}]),controllers.controller("UserController",["$scope","UserInfo",function(e,t){e.userinfo=t,e.userid_to_impersonate=null,e.impersonate=function(){e.userinfo.impersonate(e.userid_to_impersonate)}}]),controllers.controller("PractitionersController",["$scope","$filter","$animate","UserInfo","Practitioner","Valuelists",function(r,a,e,t,n,i){r.certificateYearMin=2e3,r.certificateYearMax=(new Date).getFullYear()+1,r.certificateYearValid=(new Date).getFullYear(),r.current=null,r.currentForm=null,r.userinfo=t,r.valuelists=i,n.query(function(e){r.practitioners=e});function o(e,t,n,i){return!!e&&0<a("filter")(e,function(e){return e.cert_type==t&&(e.year===n&&(!(0<i&&e.conditions!=i)&&(!e.is_deleted&&!e.is_cancelled)))},!0).length}r.hasEiaTL=function(e){var t=o(e.practitioner_certificates,50,r.certificateYearValid,38);return e.cert_eia=t?"eia":null,t},r.hasEiaTM=function(e){var t=o(e.practitioner_certificates,50,r.certificateYearValid,39);return e.cert_eia=t?"eia":null,t},r.hasAuditTL=function(e){var t=o(e.practitioner_certificates,51,r.certificateYearValid,38);return e.cert_au=t?"audit":null,t},r.hasAuditTM=function(e){var t=o(e.practitioner_certificates,51,r.certificateYearValid,39);return e.cert_au=t?"audit":null,t},r.hasPartnershipEia=function(e){var t=o(e.practitioner_certificates,52,r.certificateYearValid,53);return e.cert_ep=t?"partnership":null,t},r.hasPartnershipEa=function(e){var t=o(e.practitioner_certificates,52,r.certificateYearValid,97);return e.cert_ep=t?"partnership":null,t},r.newPractitioner=function(){if(r.currentForm&&r.currentForm.$invalid)alert("Current form not valid. Can't create new practitioner.");else{var e=new n({practitioner_certificates:[],is_new:!0});r.practitioners.unshift(e),r.toggleRow(e)}},r.deletePractitioner=function(e,t){r.current=null,t.is_new||t.$delete(),r.practitioners.splice(e,1)},r.deleteCertificate=function(e,t,n){n.is_new?t.practitioner_certificates.splice(e,1):(n.is_deleted=!0,r.currentForm.$setDirty(),r.toggleRow(t,!0))},r.newCertificate=function(e){var t={year:r.certificateYearValid,date_of_entry:new Date,is_new:!0};t.cert_no=r.certificateNumber(t),e.practitioner_certificates.unshift(t)},r.calculateCertificateNumber=function(e){e.cert_no=r.certificateNumber(e)},r.canSave=function(){return r.userinfo.info.role_6};r.toggleRow=function(t,e){if(!r.loading){if(r.canSave()&&r.current){var n=r.current,i=r.currentForm;if(i.$invalid)return void alert("Form not valid. Can't save.");i.$dirty&&(function(e){r.canSave()&&(e.is_new?e.$save({},function(e){s()}):e.$update({},function(e){console.log("save pract called",e),s()}))}(n),i.$setPristine())}r.current!=t||e?t.is_new?r.current=t:(r.loading=t).$get({},function(e){r.loading=null,r.current=t}):r.current=null}},r.setCurrentForm=function(e){r.currentForm=e},r.certificateNumber=function(e){var t="E",n=_.find(r.valuelists.practitionertype,{id:+e.cert_type});return n&&(t=n.description1),"CC/"+t+"/"+(e.number?("00"+e.number).slice(-3):"000")+"/"+(e.year?e.year.toString().substr(2):"00")},r.changeNumericBoolean=function(e){return 0===e?1:0};var s=function(){};r.practitionerOrderBy=function(e){return e.person.trim().substring(e.person.trim().lastIndexOf(" "))}}]);var controllers,testy1="x",paginationCount=20,projectPagerOffset=0;controllers.controller("ProjectsController",["$scope","$location","$filter","Project","UserInfo",function(n,t,e,i,r){n.projectSearchTxt="Search",n.loadMoreProjectsTxt="Load more",n.projects=i.query({count:20}),n.projectsCount=0,i.query({countOnly:1},function(e){n.projectsCount=e[0]}),n.userinfo=r,n.goto=function(e){t.path(e)},n.canSave=function(){return n.userinfo.info.role_1},n.loadMoreProjects=function(){n.loadMoreProjectsTxt="Loading..",projectPagerOffset+=20,i.query({count:20,offset:projectPagerOffset,searchWord:n.searchWord},function(e){if(0!=e.length){var t=n.projects.concat(e);n.projects=t,n.loadMoreProjectsTxt="Load more"}else n.hideProjectLoader=!0})},n.searchProjects=function(){n.projectSearchTxt="Searching...",i.query({count:20,searchWord:n.searchWord},function(e){n.hideProjectLoader=!1,n.projects=e,n.projectSearchTxt="Search"})}}]),controllers.controller("ProjectTabsController",["$scope","$routeParams","$location","$q","$timeout","ProjectFactory","UserInfo","Valuelists",function(a,e,t,o,n,s,i,r){a.SavingStateEnum=SavingStateEnum,a.ProjectTabEnum=ProjectTabEnum,a.routeParams=e,a.userinfo=i,a.valuelists=r,a.data=s,a.loadMoreBtnTxt="Load more",a.searchBtnTxt="search",a.organisations=[];var c;a.tab=(c=t.path(),_.contains(c,"eiaspermits")?ProjectTabEnum.EiasPermits:_.contains(c,"auditsinspections")?ProjectTabEnum.AuditsInspections:_.contains(c,"externalaudits")?ProjectTabEnum.ExternalAudits:_.contains(c,"permitslicenses")?ProjectTabEnum.PermitsLicenses:ProjectTabEnum.Project),a.goto=function(e){n(function(){t.path(e)})},a.auth={},a.auth.canSave=function(){return!1},a.saveCurrent=function(t,e,n){if(n=void 0!==n&&n,t.saveInProgress&&t.isNew)return(i=o.defer()).reject(),i.promise;t.saveInProgress=!0;var i=o.defer();if(t.form.$pristine&&!n)t.saveInProgress=!1,i.reject();else if(!t.form.$invalid&&!this.coordinateError||t.isNew&&n){t.state=t.isNew?SavingStateEnum.LoadingNew:SavingStateEnum.SavingStarted;var r=a.routeParams;n&&(r=_.omit(r,"auditinspectionId"),r=_.omit(r,"eiapermitId"),r=_.omit(r,"externalauditId")),s.save(r,e).then(function(e){_.isUndefined(t.form)||(t.state=t.isNew?SavingStateEnum.LoadingNew:SavingStateEnum.SavingFinished,t.form.$setPristine(),t.saveInProgress=!1,i.resolve(e))},function(e){console&&console.log("Error on server:",e),t.state=SavingStateEnum.SavingFailed,t.saveInProgress=!1})}else t.state=SavingStateEnum.Invalid,t.saveInProgress=!1,i.reject();return i.promise}}]),controllers.controller("ProjectController",["$scope","$q","ProjectFactory","Organisation","$timeout",function(a,e,t,r,n){function o(e){var t=_.find(a.valuelists.district,"id",parseInt(a.data.project.district_id));return console.log(t,a.data.project.district_id),t.description1.toLowerCase()!=e.address.state.toLowerCase()?(a.districtState.isError=DisplayStateEnum.Show,a.districtState.suggestion=e.address.state,!1):(a.districtState.isError=DisplayStateEnum.Hide,!0)}if(a.selectOrganisationMode=!1,a.isNewProject=!1,a.coordinateError=DisplayStateEnum.Hide,a.districtState={isError:DisplayStateEnum.Hide,suggestion:""},a.currentCoordinateObject={},a.coordinateNetworkIssues=DisplayStateEnum.Hide,a.checkingCoordinates=!1,a.currentLong="",a.currentLat="",a.parts={project:{form:null,state:SavingStateEnum.Loading},organisation:{form:null,state:SavingStateEnum.Loading}},a.newProjectExisitingOrganisation=function(e){a.selectOrganisationMode=!1,t.setOrganisation(e).then(function(e){a.parts.organisation.state=SavingStateEnum.Loaded}),0<t.project.id?(t.project.organisation_id=e.id,n(function(){a.saveCurrentProject(!0)})):t.createNewProject(e),a.parts.project.state=SavingStateEnum.Loaded},a.newProjectNewOganisation=function(){a.selectOrganisationMode=!1,t.createNewOrganisation(),0<t.project.id||t.createNewProject(a.data.organisation),a.parts.project.state=SavingStateEnum.Loaded,a.parts.organisation.state=SavingStateEnum.Loaded,a.parts.organisation.isNew=!0},a.loadMoreDevelopers=function(e){a.loadMoreBtnTxt="Loading...",paginationCount+=20;var t=a.data.searchWord,n=r.query({offset:paginationCount,searchWord:t}),i=a.organisations;n.$promise.then(function(e){var t=e[0].organisations,n=i.concat(t);a.organisations=n.sort(a.projectSortScript),a.currentCount=e[0].properties.currentCount,a.loadMoreBtnTxt="Load more"})},a.search=function(){a.searchBtnTxt="searching...";var e=a.data.searchWord;paginationCount=0,r.query({searchWord:e}).$promise.then(function(e){var t=e[0].organisations.sort(a.projectSortScript);a.organisations=t,a.totalCount=e[0].properties.totalCount,a.currentCount=e[0].properties.currentCount,a.searchBtnTxt="search"})},a.saveCurrentProject=function(e){if(e=void 0!==e&&e,a.isNewProject)a.saveNewProjectAndNewOrganisation();else{var t=a.data.project;a.saveCurrent(a.parts.project,t,e).then(function(e){})}},a.saveCurrentOrganisation=function(){if(a.isNewProject)a.saveNewProjectAndNewOrganisation();else{var t=a.data.project,e=a.data.organisation;a.saveCurrent(a.parts.organisation,e).then(function(e){e.id!==t.organisation_id&&(t.organisation_id=e.id,a.saveCurrentProject(!0))})}},a.saveNewProjectAndNewOrganisation=function(){var t=a.parts.project,e=a.parts.organisation;if(t.form.$invalid||this.coordinateError)return a.parts.project.state=SavingStateEnum.Invalid,void(e.form.$dirty&&(a.parts.organisation.state=SavingStateEnum.MissingDependency));if(t.form.$valid&&e.form.$invalid)return a.parts.project.state=SavingStateEnum.MissingDependency,void(a.parts.organisation.state=SavingStateEnum.Invalid);if(t.form.$valid&&e.form.$valid){var n=a.data.project,i=a.data.organisation;e.form.$pristine?(n.organisation_id=i.id,a.saveCurrent(t,n).then(function(e){a.goto("/projects/"+e.id)})):a.saveCurrent(e,i).then(function(e){n.organisation_id=e.id,a.saveCurrent(t,n).then(function(e){a.goto("/projects/"+e.id)})})}},a.auth.canSave=function(e){switch(e){case"has_industrial_waste_water":return a.userinfo.info.role_3;default:return a.userinfo.info.role_1}},a.auth.canDelete=function(){return!a.isNewProject&&(a.parts.project.state!=SavingStateEnum.Loading&&(!(0<a.data.eiaspermits.length||0<a.data.auditsinspections.length)&&a.auth.canSave()))},a.deleteProject=function(){t.deleteProject(a.routeParams).then(function(){a.goto("/projects")})},a.changeDeveloper=function(){a.selectOrganisationMode=!0,r.query().$promise.then(function(e){a.organisations=e[0].organisations.sort(a.projectSortScript),a.totalCount=e[0].totalCount,a.currentCount=e[0].currentCount})},a.verifyCoordinates=function(e,t){if(!t||a.parts.project.state!=SavingStateEnum.Loading){var n=a.data.project.latitude?a.data.project.latitude.trim():a.data.project.latitude,i=a.data.project.longitude?a.data.project.longitude.trim():a.data.project.longitude;a.data.project.latitude=n,a.data.project.longitude=i,!a.isNewProject||n||i?a.parts.project.state!=SavingStateEnum.Loading&&(a.currentLong==i&&a.currentLat==n||(n||i?(a.currentLat=n,a.currentLong=i,r(!0),isCoordinateWithinUganda(n,i,function(e,t){a.$apply(function(){e?(a.currentCoordinateObject=t,a.coordinateError=DisplayStateEnum.Hide,o(t),a.saveCurrentProject()):(document.getElementById("latitude").classList.remove("ng-valid"),document.getElementById("longitude").classList.remove("ng-valid"),a.coordinateError=DisplayStateEnum.Show,"network"==t.error?a.coordinateNetworkIssues=DisplayStateEnum.Show:a.coordinateNetworkIssues=DisplayStateEnum.Hide),r(!1)})})):a.coordinateError=DisplayStateEnum.Hide)):a.coordinateError=DisplayStateEnum.Hide}function r(e){e&&(a.coordinateError=e),a.checkingCoordinates=e}},a.onDistrictChange=function(){console.log(a.currentCoordinateObject),o(a.currentCoordinateObject),a.saveCurrentProject()},a.splitCoordinates=function(t){setTimeout(function(){var e=document.getElementById(t).value.split(",");e.length<2||(a.data.project.latitude=e[0],a.data.project.longitude=e[1])},0)},"new"==a.routeParams.projectId){a.selectOrganisationMode=!0,a.isNewProject=!0,a.parts.project.isNew=!0,t.empty(),r.query().$promise.then(function(e){a.organisations=e[0].organisations.sort(a.projectSortScript),a.totalCount=e[0].properties.totalCount,a.currentCount=e[0].properties.currentCount})}else{var i=t.retrieveProjectData(a.routeParams);i[0].then(function(){a.parts.project.state=SavingStateEnum.Loaded}),i[1].then(function(){a.parts.organisation.state=SavingStateEnum.Loaded})}a.projectSortScript=function(e,t){return e.projectCount<t.projectCount?1:e.projectCount>t.projectCount?-1:0}}]),controllers.controller("EiasPermitsTabsController",["$scope","$location","ProjectFactory",function(n,e,t){n.fileUploadPattern=fileUploadPattern,n.fileUploadNgfPattern=fileUploadNgfPattern,n.fileUploadMaxSize=fileUploadMaxSize,n.EiasPermitsTabEnum=EiasPermitsTabEnum,n.parts={eiapermits:{state:SavingStateEnum.None},eiapermit:{form:null,state:SavingStateEnum.None},documents:{state:SavingStateEnum.None},document:{form:null,state:SavingStateEnum.None},hearings:{state:SavingStateEnum.None},hearing:{form:null,state:SavingStateEnum.None}};var i;n.eptab=(i=e.path(),_.contains(i,"hearings")?EiasPermitsTabEnum.Hearings:_.contains(i,"documents")?EiasPermitsTabEnum.Documents:EiasPermitsTabEnum.EiaPermit),n.preventClickIfDisabled=function(e,t){e&&t.preventDefault()},n.stopPropagation=function(e){e.stopPropagation()},n.openEiapermit=function(e,t){n.routeParams.eiapermitId==e?n.goto("/projects/"+n.data.project.id+"/eiaspermits"):n.routeParams.eiapermitId||n.goto("/projects/"+n.data.project.id+"/eiaspermits/"+e)},n.openEiapermitDocument=function(e,t){n.routeParams.documentId==e?n.goto("/projects/"+n.data.project.id+"/eiaspermits/"+n.data.eiapermit.id+"/documents"):n.routeParams.documentId||n.goto("/projects/"+n.data.project.id+"/eiaspermits/"+n.data.eiapermit.id+"/documents/"+e)},n.openEiapermitDocumentHearing=function(e,t){n.routeParams.hearingId==e?n.goto("/projects/"+n.data.project.id+"/eiaspermits/"+n.data.eiapermit.id+"/documents/"+n.data.document.id+"/hearings"):n.routeParams.hearingId||n.goto("/projects/"+n.data.project.id+"/eiaspermits/"+n.data.eiapermit.id+"/documents/"+n.data.document.id+"/hearings/"+e)},n.isDocumentsDisabled=function(e){return!!n.isDisabled(e)||n.parts.documents.state==SavingStateEnum.Loading},n.isHearingsDisabled=function(e){return!!n.isDisabled(e)||n.parts.hearings.state==SavingStateEnum.Loading},n.isDisabled=function(e){return _.isUndefined(e)},n.downloadFileUrl=function(e){return"/file/v1/download/"+e},n.updateStatus=function(e){var t=updateEiaPermitStatus(e,n.data.documents);return t&&n.parts.eiapermit.form&&n.parts.eiapermit.form.$setDirty(),t},n.loadEiaPermitWithDocuments=function(){n.parts.eiapermit.state=SavingStateEnum.Loading,n.parts.documents.state=SavingStateEnum.Loading;var e=t.retrieveEiaPermit(n.routeParams);e[0].then(function(e){n.parts.eiapermit.state=SavingStateEnum.Loaded}),e[1].then(function(e){n.parts.documents.state=SavingStateEnum.Loaded})},n.parts.eiapermits.state=SavingStateEnum.Loading,t.retrieveProjectData(n.routeParams)[2].then(function(e){n.parts.eiapermits.state=SavingStateEnum.Loaded,_.isUndefined(n.routeParams.eiapermitId)||n.loadEiaPermitWithDocuments()})}]),controllers.controller("EiasPermitsController",["$scope","ProjectFactory","$timeout","Upload","$q","$location",function(n,e,t,i,r,a){n.showUploadingCertificate=!1,n.shouldShowEiaPermit=function(e){return n.parts.eiapermit.state!=SavingStateEnum.Loading&&n.routeParams.eiapermitId==e.id},n.saveCurrentEiaPermit=function(e){var t=e.is_new;t||n.updateStatus(e),n.saveCurrent(n.parts.eiapermit,e,t).then(function(e){t&&n.goto("/projects/"+n.data.project.id+"/eiaspermits/"+e.id)})},n.newEiaPermit=function(){n.parts.eiapermit.state=SavingStateEnum.LoadingNew,e.createNewEiaPermit(n.data.project)},n.deleteEiaPermit=function(){e.deleteEiaPermit(n.routeParams),n.goto("/projects/"+n.data.project.id+"/eiaspermits")},n.uploadCertificate=function(e){e&&(n.showUploadingCertificate=!0,n.certificateFile=e[0],uploadFile(r,t,i,n.parts.eiapermit.form.certificate,n.certificateFile).then(function(e){n.data.eiapermit.file_metadata_id=e.result.id,n.parts.eiapermit.form.certificate.$setDirty(),n.saveCurrentEiaPermit(n.data.eiapermit)},function(e){}))},n.deleteCertificate=function(){n.showUploadingCertificate=!1,n.data.eiapermit.file_metadata_id=null,n.parts.eiapermit.form.certificate.$setDirty(),n.saveCurrentEiaPermit(n.data.eiapermit)},n.criteriaMatchOfficer1=function(e){return function(e){return!0}},n.criteriaMatchOfficer=function(e){return function(e){return!0}},n.auth.canSave=function(e){if(n.data.eiapermit.is_new&&n.parts.eiapermit.state==SavingStateEnum.SavingStarted)return!1;switch(e){case"new":case"delete":return n.userinfo.info.role_1;case"teamleader_id":case"practitioner_id":case"cost":case"cost_currency":case"expected_jobs_created":return n.userinfo.info.role_1;case"personnel":return n.userinfo.info.role_2;case"inspection_recommended":case"date_inspection":case"officer_recommend":case"fee":case"fee_currency":case"remarks":return n.userinfo.info.role_3;case"date_fee_notification":case"date_fee_payed":case"fee_receipt_no":return n.userinfo.info.role_4;case"decision":case"date_decision":case"designation":case"date_certificate":case"certificate_no":case"date_cancelled":case"user_id":case"date_sent_ded_approval":return n.userinfo.info.role_5;case"status":default:return!1}}}]),controllers.controller("EiasPermitsDocumentsController",["$scope","ProjectFactory","$timeout","Upload","$q","$location","EiaPermitSearch",function(r,a,t,n,i,e,o){r.shouldShowDocument=function(e){return r.parts.document.state!=SavingStateEnum.Loading&&r.routeParams.documentId==e.id},r.moveButton={},r.moveDocument=function(){r.moveButton.error="",o.query({eiapermit_id:r.moveButton.id},function(e){if(1<=e.length){var t=e[0].project_id,n=e[0].eiapermit_id,i=r.data.document.id;a.moveDocument(r.routeParams,r.moveButton.id).then(function(){r.updateStatusBasedOnDocument(),r.goto("/projects/"+t+"/eiaspermits/"+n+"/documents/"+i)})}else r.moveButton.error="Not a valid EIA ID."})},r.updateStatusBasedOnDocument=function(){r.updateStatus(r.data.eiapermit)&&r.data.eiapermit.$update(r.routeParams,function(e){},function(){})},r.saveCurrentDocument=function(e){var t=e.is_new;r.saveCurrent(r.parts.document,e).then(function(e){r.updateStatusBasedOnDocument(),t&&r.goto("/projects/"+r.data.project.id+"/eiaspermits/"+r.data.eiapermit.id+"/documents/"+e.id)})},r.newDocument=function(){r.parts.document.state=SavingStateEnum.LoadingNew,a.createNewDocument(r.data.eiapermit)},r.deleteDocument=function(){a.deleteDocument(r.routeParams).then(function(){r.updateStatusBasedOnDocument(),r.goto("/projects/"+r.data.project.id+"/eiaspermits/"+r.data.eiapermit.id+"/documents")})},r.uploadAttachment=function(e){e&&(r.showUploadingAttachment=!0,r.attachmentFile=e[0],uploadFile(i,t,n,r.parts.document.form.attachment,r.attachmentFile).then(function(e){r.data.document.file_metadata_id=e.result.id,r.parts.document.form.attachment.$setDirty(),r.saveCurrentDocument(r.data.document)},function(e){}))},r.uploadResponseDocument=function(e){e&&(r.showUploadingResponseDocument=!0,r.responseDocumentFile=e[0],uploadFile(i,t,n,r.parts.document.form.response_document,r.responseDocumentFile).then(function(e){r.data.document.file_metadata_response_id=e.result.id,r.parts.document.form.response_document.$setDirty(),r.saveCurrentDocument(r.data.document)},function(e){}))},r.deleteAttachment=function(){r.showUploadingAttachment=!1,r.data.document.file_metadata_id=null,r.parts.document.form.attachment.$setDirty(),r.saveCurrentDocument(r.data.document)},r.deleteResponseDocument=function(){r.showUploadingResponseDocument=!1,r.data.document.file_metadata_response_id=null,r.parts.document.form.response_document.$setDirty(),r.saveCurrentDocument(r.data.document)},r.calculateNumberOfCopiesOfDocument=function(){r.data.document.director_copy_no=1,r.data.document.coordinator_copy_no=r.data.document.sub_copy_no-1},r.calculateDocumentCode=function(){var e=_.find(r.valuelists.documenttype,{id:parseInt(r.data.document.type)}),t=e?e.description1:"",n=r.data.document.number?r.data.document.number:"";r.data.document.code=t+n},r.setDefaultDocumentConclusion=function(){0<=_.indexOf(["8","9"],r.data.document.type)?r.data.document.conclusion=80:r.data.document.conclusion=81},r.isDisabledBasedOnRule=function(e){switch(e){case"document.conclusion":return 81==r.data.document.conclusion;case"document.type":return 10==r.data.document.type;default:return!1}},r.auth.canSave=function(e){if(r.data.document.is_new&&r.parts.document.state==SavingStateEnum.SavingStarted)return!1;switch(e){case"new":case"delete":return r.userinfo.info.role_1;case"document.date_submitted":case"document.sub_copy_no":case"document.title":case"document.type":case"document.number":case"document.code":case"document.consultent":case"document.director_copy_no":case"document.date_sent_director":case"document.coordinator_copy_no":case"document.date_copies_coordinator":case"document.date_next_appointment":case"document.folio_no":return r.userinfo.info.role_1;case"document.date_sent_officer":return r.userinfo.info.role_2;case"document.file_metadata_response_id":case"document.conclusion":case"document.date_conclusion":case"document.remarks":case"document.remarks_director":case"document.remarks_team_leader":return r.userinfo.info.role_3;case"document.date_sent_from_dep":return r.userinfo.info.role_5;case"move":return r.userinfo.info.role_8;default:return!1}},r.loadDocumentWithHearings=function(){r.parts.document.state=SavingStateEnum.Loading,r.parts.hearings.state=SavingStateEnum.Loading;var e=a.retrieveDocument(r.routeParams);e[0].then(function(e){r.parts.document.state=SavingStateEnum.Loaded}),e[1].then(function(e){r.parts.hearings.state=SavingStateEnum.Loaded})},r.parts.document,SavingStateEnum.Loading,a.retrieveProjectData(r.routeParams)[2].then(function(e){a.retrieveEiaPermit(r.routeParams)[1].then(function(e){r.parts.documents.state=SavingStateEnum.Loaded,_.isUndefined(r.routeParams.documentId)||r.loadDocumentWithHearings()})})}]),controllers.controller("EiasPermitsHearingsController",["$scope","ProjectFactory","$timeout","Upload","$q","$location",function(n,t,i,r,a,e){n.shouldShowHearing=function(e){return n.parts.hearing.state!=SavingStateEnum.Loading&&n.routeParams.hearingId==e.id},n.saveCurrentHearing=function(e){var t=e.is_new;n.saveCurrent(n.parts.hearing,e).then(function(e){t&&n.goto("/projects/"+n.data.project.id+"/eiaspermits/"+n.data.eiapermit.id+"/documents/"+n.data.document.id+"/hearings/"+e.id)})},n.newHearing=function(){n.parts.hearing.state=SavingStateEnum.LoadingNew,t.createNewHearing(n.data.document)},n.deleteHearing=function(){t.deleteHearing(n.routeParams).then(function(){n.goto("/projects/"+n.data.project.id+"/eiaspermits/"+n.data.eiapermit.id+"/documents/"+n.data.document.id)})},n.uploadAttachment=function(e){e&&(n.showUploadingAttachment=!0,n.attachmentFile=e[0],uploadFile(a,i,r,n.parts.hearing.form.attachment,n.attachmentFile).then(function(e){n.data.hearing.file_metadata_id=e.result.id,n.parts.hearing.form.attachment.$setDirty(),n.saveCurrentHearing(n.data.hearing)},function(e){}))},n.deleteAttachment=function(){n.showUploadingAttachment=!1,n.data.hearing.file_metadata_id=null,n.parts.hearing.form.attachment.$setDirty(),n.saveCurrentHearing(n.data.hearing)},n.isDisabledBasedOnRule=function(e){switch(e){case"hearing.district_id":return 7!=n.data.hearing.lead_agency&&8!=n.data.hearing.lead_agency&&!(n.data.hearing.district_id=null);default:return!1}},n.auth.canSave=function(e){if(n.data.hearing.is_new&&n.parts.hearing.state==SavingStateEnum.SavingStarted)return!1;switch(e){case"new":case"delete":case"hearing.date_dispatched":case"hearing.lead_agency":case"hearing.district_id":case"hearing.date_expected":case"hearing.date_received":case"hearing.recommendations":case"hearing.document_id":return n.userinfo.info.role_1;case"hearing.remarks":return n.userinfo.info.role_3;default:return!1}},n.loadHearing=function(){n.parts.hearing.state=SavingStateEnum.Loading,t.retrieveHearing(n.routeParams)[0].then(function(e){n.parts.hearing.state=SavingStateEnum.Loaded})},n.loadDocumentWithHearings=function(){n.parts.document.state=SavingStateEnum.Loading,n.parts.hearings.state=SavingStateEnum.Loading;var e=t.retrieveDocument(n.routeParams);e[0].then(function(e){n.parts.document.state=SavingStateEnum.Loaded}),e[1].then(function(e){n.parts.hearings.state=SavingStateEnum.Loaded,_.isUndefined(n.routeParams.hearingId)||n.loadHearing()})},t.retrieveProjectData(n.routeParams)[2].then(function(e){t.retrieveEiaPermit(n.routeParams)[1].then(function(e){n.parts.documents.state=SavingStateEnum.Loaded,_.isUndefined(n.routeParams.documentId)||n.loadDocumentWithHearings()})})}]),controllers.controller("ExternalAuditsTabsController",["$scope","$location","ProjectFactory",function(n,e,t){n.fileUploadPattern=fileUploadPattern,n.fileUploadNgfPattern=fileUploadNgfPattern,n.fileUploadMaxSize=fileUploadMaxSize,n.ExternalAuditsTabEnum=ExternalAuditsTabEnum,n.parts={externalaudits:{state:SavingStateEnum.None},externalaudit:{form:null,state:SavingStateEnum.None},documents:{state:SavingStateEnum.None},document:{form:null,state:SavingStateEnum.None},hearings:{state:SavingStateEnum.None},hearing:{form:null,state:SavingStateEnum.None}};var i;n.eatab=(i=e.path(),_.contains(i,"hearings")?EiasPermitsTabEnum.Hearings:_.contains(i,"documents")?ExternalAuditsTabEnum.Documents:ExternalAuditsTabEnum.ExternalAudit),n.openExternalaudit=function(e,t){n.routeParams.externalauditId==e?n.goto("/projects/"+n.data.project.id+"/externalaudits"):n.routeParams.externalauditId||n.goto("/projects/"+n.data.project.id+"/externalaudits/"+e)},n.openExternalauditDocument=function(e,t){n.routeParams.documentId==e?n.goto("/projects/"+n.data.project.id+"/externalaudits/"+n.data.externalaudit.id+"/documents"):n.routeParams.documentId||n.goto("/projects/"+n.data.project.id+"/externalaudits/"+n.data.externalaudit.id+"/documents/"+e)},n.preventClickIfDisabled=function(e,t){e&&t.preventDefault()},n.stopPropagation=function(e){e.stopPropagation()},n.isDocumentsDisabled=function(e){return!!n.isDisabled(e)||n.parts.documents.state==SavingStateEnum.Loading},n.isHearingsDisabled=function(e){return!!n.isDisabled(e)||n.parts.hearings.state==SavingStateEnum.Loading},n.isDisabled=function(e){return _.isUndefined(e)},n.downloadFileUrl=function(e){return"/file/v1/download/"+e},n.updateStatus=function(e){var t=updateExternalAuditStatus(e,n.data.documents_ea);return t&&n.parts.externalaudit.form&&n.parts.externalaudit.form.$setDirty(),t},n.loadExternalAuditWithDocuments=function(){n.parts.externalaudit.state=SavingStateEnum.Loading,n.parts.documents.state=SavingStateEnum.Loading;var e=t.retrieveExternalAudit(n.routeParams);e[0].then(function(e){n.parts.externalaudit.state=SavingStateEnum.Loaded}),e[1].then(function(e){n.parts.documents.state=SavingStateEnum.Loaded})},n.parts.externalaudits.state=SavingStateEnum.Loading,t.retrieveProjectData(n.routeParams)[5].then(function(e){n.parts.externalaudits.state=SavingStateEnum.Loaded,_.isUndefined(n.routeParams.externalauditId)||n.loadExternalAuditWithDocuments()})}]),controllers.controller("ExternalAuditsController",["$scope","ProjectFactory","$timeout","Upload","$q","$location",function(n,e,t,i,r,a){n.showUploadingResponseDocument=!1,n.shouldShowExternalAudit=function(e){return n.parts.externalaudit.state!=SavingStateEnum.Loading&&n.routeParams.externalauditId==e.id},n.saveCurrentExternalAudit=function(e){var t=e.is_new;t||n.updateStatus(e),n.saveCurrent(n.parts.externalaudit,e,t).then(function(e){t&&n.goto("/projects/"+n.data.project.id+"/externalaudits/"+e.id)})},n.newExternalAudit=function(){n.parts.externalaudit.state=SavingStateEnum.LoadingNew,e.createNewExternalAudit(n.data.project)},n.deleteExternalAudit=function(){e.deleteExternalAudit(n.routeParams),n.goto("/projects/"+n.data.project.id+"/externalaudits")},n.uploadResponseDocument=function(e){e&&(n.showUploadingResponseDocument=!0,n.responseDocumentFile=e[0],uploadFile(r,t,i,n.parts.externalaudit.form.response_document,n.responseDocumentFile).then(function(e){n.data.externalaudit.file_metadata_response_id=e.result.id,n.parts.externalaudit.form.response_document.$setDirty(),n.saveCurrentExternalAudit(n.data.externalaudit)},function(e){}))},n.deleteResponseDocument=function(){n.showUploadingResponseDocument=!1,n.data.externalaudit.file_metadata_response_id=null,n.parts.externalaudit.form.response_document.$setDirty(),n.saveCurrentExternalAudit(n.data.externalaudit)},n.criteriaMatchOfficer1=function(e){return function(e){return!0}},n.criteriaMatchOfficer=function(e){return function(e){return!0}},n.auth.canSave=function(e){if(n.data.externalaudit.is_new&&n.parts.externalaudit.state==SavingStateEnum.SavingStarted)return!1;switch(e){case"new":return n.userinfo.info.role_1;case"teamleader_id":case"practitioner_id":case"type":return n.userinfo.info.role_1;case"personnel":return n.userinfo.info.role_2;case"verification_inspection":case"date_inspection":case"date_response":case"fee":case"fee_currency":case"remarks":case"review_findings":case"response":case"date_deadline_compliance":case"delete":case"upload_documentation_response_letter":case"delete_documentation_response_letter":return n.userinfo.info.role_3;case"user_id":return n.userinfo.info.role_5;case"status":default:return!1}},n.filterByDateSubmission=function(e){if(e.length||e[0].documents)return e.sort(function(e,t){return console.log(),(e.documents&&e.documents[0]?e.documents[0].date_submitted:"")<(t.documents&&t.documents[0]?t.documents[0].date_submitted:"")?-1:1}),e.reverse()}}]),controllers.controller("ExternalAuditsDocumentsController",["$scope","ProjectFactory","$timeout","Upload","$q","$location","ExternalAuditSearch",function(r,a,t,n,i,e,o){r.shouldShowDocument=function(e){return r.parts.document.state!=SavingStateEnum.Loading&&r.routeParams.documentId==e.id},r.moveButton={},r.moveDocument=function(){r.moveButton.error="",o.query({externalaudit_id:r.moveButton.id},function(e){if(1<=e.length){var t=e[0].project_id,n=e[0].externalaudit_id,i=r.data.document_ea.id;console.log(t,n,i),a.moveDocumentEA(r.routeParams,r.moveButton.id).then(function(){r.updateStatusBasedOnDocument(),r.goto("/projects/"+t+"/externalaudits/"+n+"/documents/"+i)})}else r.moveButton.error="Not a valid EA ID."})},r.updateStatusBasedOnDocument=function(){r.updateStatus(r.data.externalaudit)&&r.data.externalaudit.$update(r.routeParams,function(e){},function(){})},r.saveCurrentDocument=function(e){var t=e.is_new;r.saveCurrent(r.parts.document,e).then(function(e){r.updateStatusBasedOnDocument(),t&&r.goto("/projects/"+r.data.project.id+"/externalaudits/"+r.data.externalaudit.id+"/documents/"+e.id)})},r.newDocument=function(){r.parts.document.state=SavingStateEnum.LoadingNew,a.createNewDocumentEA(r.data.externalaudit)},r.deleteDocument=function(){a.deleteDocumentEA(r.routeParams).then(function(){r.updateStatusBasedOnDocument(),r.goto("/projects/"+r.data.project.id+"/externalaudits/"+r.data.externalaudit.id+"/documents")})},r.uploadAttachment=function(e){e&&(r.showUploadingAttachment=!0,r.attachmentFile=e[0],uploadFile(i,t,n,r.parts.document.form.attachment,r.attachmentFile).then(function(e){r.data.document_ea.file_metadata_id=e.result.id,r.parts.document.form.attachment.$setDirty(),r.saveCurrentDocument(r.data.document_ea)},function(e){}))},r.uploadResponseDocument=function(e){e&&(r.showUploadingResponseDocument=!0,r.responseDocumentFile=e[0],uploadFile(i,t,n,r.parts.document.form.response_document,r.responseDocumentFile).then(function(e){r.data.document_ea.file_metadata_response_id=e.result.id,r.parts.document.form.response_document.$setDirty(),r.saveCurrentDocument(r.data.document_ea)},function(e){}))},r.deleteAttachment=function(){r.showUploadingAttachment=!1,r.data.document_ea.file_metadata_id=null,r.parts.document.form.attachment.$setDirty(),r.saveCurrentDocument(r.data.document_ea)},r.deleteResponseDocument=function(){r.showUploadingResponseDocument=!1,r.data.document_ea.file_metadata_response_id=null,r.parts.document.form.response_document.$setDirty(),r.saveCurrentDocument(r.data.document_ea)},r.calculateNumberOfCopiesOfDocument=function(){r.data.document_ea.director_copy_no=1,r.data.document_ea.coordinator_copy_no=r.data.document_ea.sub_copy_no-1},r.calculateDocumentCode=function(){var e=_.find(r.valuelists.documenttypeexternalaudits,{id:parseInt(r.data.document_ea.type)}),t=e?e.description1:"",n=r.data.document_ea.number?r.data.document_ea.number:"";r.data.document_ea.code=t+n},r.setDefaultDocumentConclusion=function(){0<=_.indexOf(["11"],r.data.document_ea.type)?r.data.document_ea.conclusion=80:r.data.document_ea.conclusion=81},r.isDisabledBasedOnRule=function(e){switch(e){case"document.conclusion":return 81==r.data.document_ea.conclusion;case"document.type":return 12==r.data.document_ea.type;default:return!1}},r.auth.canSave=function(e){if(r.data.document_ea.is_new&&r.parts.document.state==SavingStateEnum.SavingStarted)return!1;switch(e){case"new":case"delete":return r.userinfo.info.role_1;case"document.date_submitted":case"document.sub_copy_no":case"document.title":case"document.type":case"document.number":case"document.code":case"document.consultent":case"document.director_copy_no":case"document.date_sent_director":case"document.coordinator_copy_no":case"document.date_copies_coordinator":case"document.date_next_appointment":case"document.folio_no":case"document.remarks":return r.userinfo.info.role_1;case"document.date_sent_officer":return r.userinfo.info.role_2;case"document.file_metadata_response_id":case"document.conclusion":case"document.date_conclusion":return r.userinfo.info.role_3;case"document.date_sent_from_dep":return r.userinfo.info.role_5;case"move":return r.userinfo.info.role_8;default:return!1}},r.loadDocument=function(){r.parts.document.state=SavingStateEnum.Loading,a.retrieveDocumentEA(r.routeParams)[0].then(function(e){r.parts.document.state=SavingStateEnum.Loaded})},r.parts.document,SavingStateEnum.Loading,a.retrieveProjectData(r.routeParams)[5].then(function(e){a.retrieveExternalAudit(r.routeParams)[1].then(function(e){r.parts.documents.state=SavingStateEnum.Loaded,_.isUndefined(r.routeParams.documentId)||r.loadDocument()})})}]),(controllers=angular.module("seroApp.controllers")).controller("AuditsInspectionsController",["$scope","ProjectFactory","$timeout","Upload","$q",function(n,e,t,i,r){n.parts={auditsinspections:{state:SavingStateEnum.None},auditinspection:{form:null,state:SavingStateEnum.None}},n.newButton={},n.newButton.year=(new Date).getFullYear(),n.fileUploadPattern=fileUploadPattern,n.fileUploadNgfPattern=fileUploadNgfPattern,n.fileUploadMaxSize=fileUploadMaxSize,n.shouldShowAuditInspection=function(e){return n.parts.auditinspection.state!=SavingStateEnum.Loading&&n.routeParams.auditinspectionId==e.id},n.criteriaMatchOfficer1=function(e){return function(e){return!0}},n.criteriaMatchOfficer=function(e){return function(e){return!0}},n.isLoading=function(){return n.parts.auditinspection.state==SavingStateEnum.Loading?!!n.hasAuditInspection():n.parts.auditinspection.state==SavingStateEnum.LoadingNew},n.hasAuditInspection=function(){return!_.isEmpty(n.data.auditinspection)},n.updateStatus=function(e){updateAuditInspectionStatus(e)},n.openAuditInspection=function(e,t){n.routeParams.auditinspectionId==e?n.goto("/projects/"+n.data.project.id+"/auditsinspections"):n.routeParams.auditinspectionId||n.goto("/projects/"+n.data.project.id+"/auditsinspections/"+e)},n.stopPropagation=function(e){e.stopPropagation()},n.saveCurrentAuditInspection=function(){n.data.auditinspection.year=new Date(n.data.auditinspection.date_carried_out).getFullYear();var e=n.data.auditinspection;console.log(e,"about to save");var t=e.is_new;t||n.updateStatus(e),n.saveCurrent(n.parts.auditinspection,e,t).then(function(e){t&&n.goto("/projects/"+n.data.project.id+"/auditsinspections/"+e.id)})},n.newAuditInspection=function(){n.parts.auditinspection.state=SavingStateEnum.LoadingNew,n.newButton.isopen=!1,n.newButton.year=new Date(n.newButton.date_carried_out).getFullYear(),e.createNewAuditInspection(n.data.project,n.newButton.year,n.newButton.type,n.newButton.reason,n.newButton.date_carried_out),n.parts.auditinspection.isNew=!0,n.saveCurrentAuditInspection()},n.deleteAuditInspection=function(){e.deleteAuditInspection(n.routeParams),n.goto("/projects/"+n.data.project.id+"/auditsinspections/")},n.auth.canSave=function(e){return"new"==e?n.userinfo.info.role_7:!!n.userinfo.info.role_8||"lead_officer"!=e&&n.userinfo.info.id===n.data.auditinspection.lead_officer},n.uploadActionTakenLetter=function(e){e&&(n.showUploadingFileActionTakenLetter=!0,n.actionTakenLetterFile=e[0],uploadFile(r,t,i,n.parts.auditinspection.form.action_taken_letter,n.actionTakenLetterFile).then(function(e){n.data.auditinspection.file_metadata_id=e.result.id,n.parts.auditinspection.form.action_taken_letter.$setDirty(),n.saveCurrentAuditInspection(),t(function(){n.showUploadingFileActionTakenLetter=!1},3e3)},function(e){}))},n.uploadReport=function(e){e&&(n.showUploadingFileReport=!0,n.reportFile=e[0],uploadFile(r,t,i,n.parts.auditinspection.form.report,n.reportFile).then(function(e){n.data.auditinspection.file_metadata_report_id=e.result.id,n.parts.auditinspection.form.report.$setDirty(),n.saveCurrentAuditInspection(),t(function(){n.showUploadingFileReport=!1},3e3)},function(e){}))},n.uploadDocumentation=function(e){e&&(n.showUploadingFileDocumentation=!0,n.documentationFile=e[0],uploadFile(r,t,i,n.parts.auditinspection.form.documentation,n.documentationFile).then(function(e){n.data.auditinspection.documentation_ids.push(e.result.id),n.parts.auditinspection.form.documentation.$setDirty(),n.saveCurrentAuditInspection(),t(function(){n.showUploadingFileDocumentation=!1},3e3)},function(e){}))},n.downloadFileUrl=function(e){return"/file/v1/download/"+e},n.deleteActionTakenLetter=function(){n.data.auditinspection.file_metadata_id=null,n.parts.auditinspection.form.action_taken_letter.$setDirty(),n.saveCurrentAuditInspection()},n.deleteReport=function(){n.data.auditinspection.file_metadata_report_id=null,n.parts.auditinspection.form.report.$setDirty(),n.saveCurrentAuditInspection()},n.deleteDocumentation=function(t){_.remove(n.data.auditinspection.documentation_ids,function(e){return e===t}),n.parts.auditinspection.form.documentation.$setDirty(),n.saveCurrentAuditInspection()},n.loadAuditInspection=function(){n.parts.auditinspection.state=SavingStateEnum.Loading,e.retrieveAuditInspection(n.routeParams)[0].then(function(e){n.parts.auditinspection.state=SavingStateEnum.Loaded})},n.parts.auditinspection.state=SavingStateEnum.Loading,e.retrieveProjectData(n.routeParams)[3].then(function(e){n.parts.auditsinspections.state=SavingStateEnum.Loaded,_.isUndefined(n.routeParams.auditinspectionId)||n.loadAuditInspection()})}]),controllers.controller("PermitsLicensesController",["$scope","ProjectFactory","$timeout","Upload","$q","$location",function(i,t,r,a,o,e){i.parts={permitslicenses:{state:SavingStateEnum.None},permitlicense:{form:null,state:SavingStateEnum.None}},i.newButton={},i.newButton.approved_by_the_lc1=!1,i.newButton.approved_by_the_dec=!1,i.fileUploadPattern=fileUploadPattern,i.fileUploadNgfPattern=fileUploadNgfPattern,i.fileUploadMaxSize=fileUploadMaxSize,i.DocumentTagEnum=DocumentTagEnum,i.documentationData={ApplicationForm:{formField:"documentation_applicationform",tag:DocumentTagEnum.PermitLicenseApplicationForm},PermitLicense:{formField:"documentation_permitlicense",tag:DocumentTagEnum.PermitLicensePermitLicense},Attachments:{formField:"documentation_attachments",tag:DocumentTagEnum.PermitLicenseAttachments}},i.idPermit=118,i.idLicense=119,i.idWetland=123,i.isEcosystemWetland=function(e){return e.ecosystem==i.idWetland},i.shouldShowPermitLicense=function(e){return i.parts.permitlicense.state!=SavingStateEnum.Loading&&i.routeParams.permitlicenseId==e.id},i.notOkToEditOrCreateNew=function(){return!!i.routeParams.permitlicenseId||!!i.data.permitlicense.is_new},i.preventClickIfDisabled=function(e,t){e&&t.preventDefault()},i.openPermitLicense=function(e,t){console.log(i.routeParams.permitlicenseId,e),i.data.permitlicense.is_new||(i.routeParams.permitlicenseId==e?i.goto("/projects/"+i.data.project.id+"/permitslicenses"):i.routeParams.permitlicenseId&&i.routeParamspermitlicenseId!=e?i.goto("/projects/"+i.data.project.id+"/permitslicenses/"+e):i.routeParams.permitlicenseId||(console.log("it says its not set"),i.goto("/projects/"+i.data.project.id+"/permitslicenses/"+e)))},i.saveCurrentPermitLicense=function(e){var t=e.is_new;i.isEcosystemWetland(e)||(e.regulation_activity=null),t||i.updateStatus(e),i.saveCurrent(i.parts.permitlicense,e,t).then(function(e){t&&i.goto("/projects/"+i.data.project.id+"/permitslicenses/"+e.id)})},i.updateStatus=function(e){},i.newPermitLicense=function(){i.parts.permitlicense.state=SavingStateEnum.LoadingNew,i.newButton.isopen=!1;var e=null;i.isEcosystemWetland(i.newButton)&&(e=i.newButton.regulation_activity),t.createNewPermitLicense(i.data.project,i.newButton.regulation,i.newButton.ecosystem,e,i.newButton.area,i.newButton.unit,i.newButton.approved_by_the_lc1,i.newButton.approved_by_the_dec,i.newButton.waste_license_type)},i.deletePermitLicense=function(){t.deletePermitLicense(i.routeParams),i.goto("/projects/"+i.data.project.id+"/permitslicenses")},i.calculateDateFeedbackToApplicants=function(){i.data.permitlicense.date_feedback_to_applicants=addDays(i.data.permitlicense.date_submitted,21)},i.uploadDocumentation=function(t,n,e){e&&(n.showUploading=!0,n.file=e[0],uploadFile(o,r,a,i.parts.permitlicense.form[n.formField],n.file,n.tag).then(function(e){t.documentation_ids.push(e.result.id),i.parts.permitlicense.form[n.formField].$setDirty(),i.saveCurrentPermitLicense(t),r(function(){n.showUploading=!1},3e3)},function(e){}))},i.deleteDocumentation=function(e,t,n){_.remove(e.documentation_ids,function(e){return e===t}),i.parts.permitlicense.form[n.formField].$setDirty(),i.saveCurrentPermitLicense(e)},i.hasDocumentationTag=function(e,t){var n=!1;return _.forEach(e,function(e){e.tag==t&&(n=!0)}),n},i.downloadFileUrl=function(e){return"/file/v1/download/"+e},i.auth.canSave=function(e){if(i.data.permitlicense.is_new&&i.parts.permitlicense.state==SavingStateEnum.SavingStarted)return!1;switch(e){case"new":case"delete":case"regulation":case"date_submitted":case"waste_license_type":case"ecosystem":case"regulation_activity":case"area":case"unit":case"approved_by_the_lc1":case"approved_by_the_dec":case"application_number":case"application_fee_receipt_number":case"date_feedback_to_applicants":case"date_sent_to_director":case"date_sent_from_dep":case"date_sent_officer":case"folio_no":return i.userinfo.info.role_1;case"personnel":return i.userinfo.info.role_2;case"application_evaluation_by_officer":case"date_of_evaluation":case"inspection_recommended":case"date_inspection":case"officer_recommend":case"date_sent_for_decision":return i.userinfo.info.role_3;case"fee_receipt_no":case"date_fee_payed":return i.userinfo.info.role_4;case"user_id":case"decision":case"date_decision":case"signature_on_permit_license":case"date_permit_license":case"permit_license_no":case"date_permit_license_expired":case"upload_documentation_permit_license":case"delete_documentation_permit_license":return i.userinfo.info.role_5;case"status":default:return!1}},i.loadPermitLicense=function(){i.parts.permitlicense.state=SavingStateEnum.Loading,t.retrievePermitLicense(i.routeParams)[0].then(function(e){i.parts.permitlicense.state=SavingStateEnum.Loaded})},i.parts.permitlicense.state=SavingStateEnum.Loading,t.retrieveProjectData(i.routeParams)[4].then(function(e){i.parts.permitslicenses.state=SavingStateEnum.Loaded,_.isUndefined(i.routeParams.permitlicenseId)||i.loadPermitLicense()})}]),controllers.controller("SearchTabsController",["$scope","$routeParams","$location","$q","$timeout","ProjectFactory","Valuelists","UserInfo",function(e,t,n,i,r,a,o,s){e.SearchTabEnum=SearchTabEnum,e.routeParams=t,e.userinfo=s,e.valuelists=o;var c;e.tab=(c=n.path(),_.contains(c,"projects")?SearchTabEnum.Projects:_.contains(c,"eiaspermits")?SearchTabEnum.EiasPermits:_.contains(c,"permitslicenses")?SearchTabEnum.PermitsLicenses:_.contains(c,"auditsinspections")?SearchTabEnum.AuditsInspections:_.contains(c,"externalaudits")?SearchTabEnum.ExternalAudits:null),e.goto=function(e){r(function(){n.path(e)})}}]),controllers.controller("SearchAuditsInspectionsController",["$scope","$routeParams","$location","$q","$timeout","AuditInspectionSearch","UserInfo","Valuelists","SearchService",function(t,e,n,i,r,a,o,s,c){t.isSearching=!1,t.showResultGrid=!1,t.gridOptions={},t.gridOptions.enableHorizontalScrollbar=0,t.gridOptions.showGridFooter=!0,t.gridOptions.minRowsToShow=10,t.gridOptions.enableColumnMenus=!1,t.gridOptions.enableRowSelection=!0,t.gridOptions.enableRowHeaderSelection=!1,t.gridOptions.multiSelect=!1,t.gridOptions.noUnselect=!0,t.gridOptions.enableFooterTotalSelected=!1,t.gridOptions.appScopeProvider={onDblClick:function(e){t.goto("/projects/"+e.project_id+"/auditsinspections/"+e.auditinspection_id)}},t.gridOptions.rowTemplate='<div ng-dblclick="grid.appScope.onDblClick(row.entity)" ng-repeat="(colRenderIndex, col) in colContainer.renderedColumns track by col.colDef.name" class="ui-grid-cell" ng-class="{ \'ui-grid-row-header-cell\': col.isRowHeader }" ui-grid-cell ></div>',t.gridOptions.columnDefs=[{name:"auditinspection_code",displayName:"Number",width:80,cellTooltip:!0,headerTooltip:!0},{name:"project_title",displayName:"Project name",cellTooltip:!0,headerTooltip:!0},{name:"developer_name",displayName:"Developer name",cellTooltip:!0,headerTooltip:!0},{name:"developer_tin",displayName:"TIN",type:"number",width:90,cellTooltip:!0,headerTooltip:!0},{name:"district_district",displayName:"District",cellTooltip:!0,headerTooltip:!0},{name:"auditinspection_type",displayName:"Activity",cellTooltip:!0,headerTooltip:!0},{name:"category_description",displayName:"Category of project",width:150,cellTooltip:!0,headerTooltip:!0},{name:"auditinspection_action_taken",displayName:"Response",cellTooltip:!0,headerTooltip:!0},{name:"auditinspection_performance_level",displayName:"Performance",width:110,cellTooltip:!0,headerTooltip:!0},{name:"auditinspection_date_deadline",displayName:"Deadline for complete compliance",width:90,type:"date",cellFilter:'date:"d MMM yyyy"',headerTooltip:!0}],t.gridOptions.onRegisterApi=function(e){t.gridApi=e},t.setSearchUrl=function(){_.isEmpty(t.criteria)||(_.isEqual(c.criteria,t.criteria)?(c.allowCache=!1,t.search()):n.search(t.criteria))},t.search=function(){t.isSearching=!0,t.showResultGrid=!1,c.search(t.criteria).then(function(e){t.gridOptions.data=e,t.isSearching=!1,t.showResultGrid=!0})},t.reset=function(){t.criteria={},c.criteria={},t.gridOptions.data=[],t.showResultGrid=!1},t.exportAuditAndInspectionResults=function(e){exportObj.exportData(e,"auditAndInspection")},t.criteria=n.search(),_.isEmpty(t.criteria)&&!_.isEmpty(c.criteria)?n.search(c.criteria):_.isEmpty(t.criteria)||t.search()}]),controllers.controller("SearchProjectsController",["$scope","$routeParams","$location","$q","$timeout","ProjectSearch","UserInfo","Valuelists","ProjectSearchService",function(t,e,n,i,r,a,o,s,c){t.isSearching=!1,t.showResultGrid=!1,t.gridOptions={},t.gridOptions.enableHorizontalScrollbar=0,t.gridOptions.showGridFooter=!0,t.gridOptions.minRowsToShow=10,t.gridOptions.enableColumnMenus=!1,t.gridOptions.enableRowSelection=!0,t.gridOptions.enableRowHeaderSelection=!1,t.gridOptions.multiSelect=!1,t.gridOptions.noUnselect=!0,t.gridOptions.enableFooterTotalSelected=!1,t.gridOptions.appScopeProvider={onDblClick:function(e){t.goto("/projects/"+e.project_id)}},t.gridOptions.rowTemplate='<div ng-dblclick="grid.appScope.onDblClick(row.entity)" ng-repeat="(colRenderIndex, col) in colContainer.renderedColumns track by col.colDef.name" class="ui-grid-cell" ng-class="{ \'ui-grid-row-header-cell\': col.isRowHeader }" ui-grid-cell ></div>',t.gridOptions.columnDefs=[{name:"project_id",displayName:"Id",type:"number",width:50,cellTooltip:!0,headerTooltip:!0},{name:"project_title",displayName:"Name",cellTooltip:!0,headerTooltip:!0},{name:"project_location",displayName:"Location",cellTooltip:!0,headerTooltip:!0},{name:"district_district",displayName:"District",cellTooltip:!0,headerTooltip:!0},{name:"category_description",displayName:"Category",cellTooltip:!0,headerTooltip:!0},{name:"developer_name",displayName:"Developer name",cellTooltip:!0,headerTooltip:!0},{name:"developer_tin",displayName:"TIN",type:"number",width:90,cellTooltip:!0,headerTooltip:!0}],t.gridOptions.onRegisterApi=function(e){t.gridApi=e},t.setSearchUrl=function(){_.isEmpty(t.criteria)||(_.isEqual(c.criteria,t.criteria)?(c.allowCache=!1,t.search()):n.search(t.criteria))},t.search=function(){t.isSearching=!0,t.showResultGrid=!1,c.search(t.criteria).then(function(e){t.gridOptions.data=e,localStorage.projectData=JSON.stringify(e),t.isSearching=!1,t.showResultGrid=!0})},t.reset=function(){t.criteria={},c.criteria={},t.gridOptions.data=[],t.showResultGrid=!1},t.criteria=n.search(),_.isEmpty(t.criteria)&&!_.isEmpty(c.criteria)?n.search(c.criteria):_.isEmpty(t.criteria)||t.search(),t.exportProjects=function(e){exportObj.exportData(e,"project")}}]),controllers.controller("SearchEiasPermitsController",["$scope","$routeParams","$location","$q","$timeout","EiaPermitSearch","UserInfo","Valuelists","EiaPermitSearchService",function(n,e,t,i,r,a,o,s,c){n.isSearching=!1,n.showResultGrid=!1,n.gridOptions={},n.gridOptions.enableHorizontalScrollbar=0,n.gridOptions.showGridFooter=!0,n.gridOptions.minRowsToShow=10,n.gridOptions.enableColumnMenus=!1,n.gridOptions.enableRowSelection=!0,n.gridOptions.enableRowHeaderSelection=!1,n.gridOptions.multiSelect=!1,n.gridOptions.noUnselect=!0,n.gridOptions.enableFooterTotalSelected=!1,n.gridOptions.appScopeProvider={onDblClick:function(e){n.goto("/projects/"+e.project_id+"/eiaspermits/"+e.eiapermit_id)}},n.gridOptions.rowTemplate='<div ng-dblclick="grid.appScope.onDblClick(row.entity)" ng-repeat="(colRenderIndex, col) in colContainer.renderedColumns track by col.colDef.name" class="ui-grid-cell" ng-class="{ \'ui-grid-row-header-cell\': col.isRowHeader }" ui-grid-cell ></div>',n.gridOptions.columnDefs=[{name:"eiapermit_id",displayName:"EIA Id",type:"number",width:80,cellTooltip:!0,headerTooltip:!0},{name:"eiapermit_status",displayName:"Status",cellTooltip:!0,headerTooltip:!0},{name:"eiapermit_officer_assigned",displayName:"Team leader",cellTooltip:!0,headerTooltip:!0},{name:"project_title",displayName:"Project name",cellTooltip:!0,headerTooltip:!0},{name:"eiapermit_certificate_no",displayName:"Certificate No.",cellTooltip:!0,headerTooltip:!0}],n.gridOptions.onRegisterApi=function(e){n.gridApi=e},n.setSearchUrl=function(){_.forOwn(n.dateCriteria,function(e,t){e instanceof Date&&(e.setHours(12),n.criteria[t]=e.toJSON().substr(0,10))}),_.isEmpty(n.criteria)||(_.isEqual(c.criteria,n.criteria)?(c.allowCache=!1,n.search()):t.search(n.criteria))},n.search=function(){n.isSearching=!0,n.showResultGrid=!1,c.search(n.criteria).then(function(e){n.gridOptions.data=e,n.isSearching=!1,n.showResultGrid=!0})},n.reset=function(){n.criteria={},n.dateCriteria={},c.criteria={},n.gridOptions.data=[],n.showResultGrid=!1},n.exportEiasPermits=function(e){exportObj.exportData(e,"eiaspermits")},n.criteria=t.search(),n.dateCriteria={},n.criteria.eiapermit_date_submission_from&&(n.dateCriteria.eiapermit_date_submission_from=new Date(n.criteria.eiapermit_date_submission_from)),n.criteria.eiapermit_date_submission_to&&(n.dateCriteria.eiapermit_date_submission_to=new Date(n.criteria.eiapermit_date_submission_to)),_.isEmpty(n.criteria)&&!_.isEmpty(c.criteria)?t.search(c.criteria):_.isEmpty(n.criteria)||n.search()}]),controllers.controller("SearchPermitsLicensesController",["$scope","$routeParams","$location","$q","$timeout","PermitLicenseSearch","UserInfo","Valuelists","PermitLicenseSearchService",function(n,e,t,i,r,a,o,s,c){n.isSearching=!1,n.showResultGrid=!1,n.gridOptions={},n.gridOptions.enableHorizontalScrollbar=0,n.gridOptions.showGridFooter=!0,n.gridOptions.minRowsToShow=10,n.gridOptions.enableColumnMenus=!1,n.gridOptions.enableRowSelection=!0,n.gridOptions.enableRowHeaderSelection=!1,n.gridOptions.multiSelect=!1,n.gridOptions.noUnselect=!0,n.gridOptions.enableFooterTotalSelected=!1,n.gridOptions.appScopeProvider={onDblClick:function(e){n.goto("/projects/"+e.project_id+"/permitslicenses/"+e.permitlicense_id)}},n.gridOptions.rowTemplate='<div ng-dblclick="grid.appScope.onDblClick(row.entity)" ng-repeat="(colRenderIndex, col) in colContainer.renderedColumns track by col.colDef.name" class="ui-grid-cell" ng-class="{ \'ui-grid-row-header-cell\': col.isRowHeader }" ui-grid-cell ></div>',n.gridOptions.columnDefs=[{name:"permitlicense_id",displayName:"PL Id",type:"number",width:80,cellTooltip:!0,headerTooltip:!0},{name:"permitlicense_date_submitted",displayName:"Date of submission",width:130,type:"date",cellFilter:'date:"d MMM yyyy"',headerTooltip:!0},{name:"permitlicense_regulation",displayName:"Regulation",width:80,cellTooltip:!0,headerTooltip:!0},{name:"permitlicense_officer_assigned",displayName:"Team leader",cellTooltip:!0,headerTooltip:!0},{name:"project_title",displayName:"Project name",cellTooltip:!0,headerTooltip:!0}],n.idPermit=118,n.idLicense=119,n.idWetland=123,n.idRB=124,n.idLS=125,n.isDisabled=function(e){switch(e){case"permitlicense_ecosystem":return n.criteria.permitlicense_regulation==n.idLicense;case"permitlicense_waste_license_type":return n.criteria.permitlicense_regulation==n.idPermit;case"permitlicense_regulation_activity":return n.criteria.permitlicense_regulation==n.idLicense||n.criteria.permitlicense_ecosystem==n.idRB||n.criteria.permitlicense_ecosystem==n.idLS;default:return!1}},n.gridOptions.onRegisterApi=function(e){n.gridApi=e},n.setSearchUrl=function(){n.removeDisabledSearchCriteria(),_.forOwn(n.dateCriteria,function(e,t){e instanceof Date&&(e.setHours(12),n.criteria[t]=e.toJSON().substr(0,10))}),_.isEmpty(n.criteria)||(_.isEqual(c.criteria,n.criteria)?(c.allowCache=!1,n.search()):t.search(n.criteria))},n.removeDisabledSearchCriteria=function(){_.forOwn(n.criteria,function(e,t){n.isDisabled(t)&&(n.criteria[t]=null)})},n.search=function(){n.isSearching=!0,n.showResultGrid=!1,c.search(n.criteria).then(function(e){n.gridOptions.data=e,n.isSearching=!1,n.showResultGrid=!0})},n.reset=function(){n.criteria={},n.dateCriteria={},c.criteria={},n.gridOptions.data=[],n.showResultGrid=!1},n.exportPermitsLicensesResults=function(e){exportObj.exportData(e,"exportPermitsLicenses")},n.criteria=t.search(),n.dateCriteria={},n.criteria.permitlicense_date_submission_from&&(n.dateCriteria.permitlicense_date_submission_from=new Date(n.criteria.permitlicense_date_submission_from)),n.criteria.permitlicense_date_submission_to&&(n.dateCriteria.permitlicense_date_submission_to=new Date(n.criteria.permitlicense_date_submission_to)),_.isEmpty(n.criteria)&&!_.isEmpty(c.criteria)?t.search(c.criteria):_.isEmpty(n.criteria)||n.search()}]),controllers.controller("StatisticsTabsController",["$scope","$routeParams","$location","$q","$timeout","ProjectFactory","Valuelists","StatisticsService",function(e,t,n,i,r,a,o,s){e.routeParams=t,e.valuelists=o,e.StatisticsService=s,e.StatisticsTabEnum=StatisticsTabEnum;var c;e.tab=(c=n.path(),_.contains(c,"projects")?StatisticsTabEnum.Projects:_.contains(c,"eiaspermits")?StatisticsTabEnum.EiasPermits:_.contains(c,"auditsinspections")?StatisticsTabEnum.AuditsInspections:null),e.goto=function(e){r(function(){n.path(e)})}}]),controllers.controller("StatisticsProjectsController",["$scope","$routeParams","$location","$q","$timeout","ProjectStatistics","UserInfo","Valuelists","StatisticsService",function(t,e,n,i,r,a,o,s,c){t.data={},t.isLoadingData=!0,c.getProjectData().then(function(e){t.data=e,t.isLoadingData=!1})}]),controllers.controller("SearchExternalAuditsController",["$scope","$routeParams","$location","$q","$timeout","ExternalAuditSearch","UserInfo","Valuelists","ExternalAuditSearchService",function(n,e,t,i,r,a,o,s,c){n.isSearching=!1,n.showResultGrid=!1,n.gridOptions={},n.gridOptions.enableHorizontalScrollbar=0,n.gridOptions.showGridFooter=!0,n.gridOptions.minRowsToShow=10,n.gridOptions.enableColumnMenus=!1,n.gridOptions.enableRowSelection=!0,n.gridOptions.enableRowHeaderSelection=!1,n.gridOptions.multiSelect=!1,n.gridOptions.noUnselect=!0,n.gridOptions.enableFooterTotalSelected=!1,n.gridOptions.appScopeProvider={onDblClick:function(e){n.goto("/projects/"+e.project_id+"/externalaudits/"+e.externalaudit_id)}},n.gridOptions.rowTemplate='<div ng-dblclick="grid.appScope.onDblClick(row.entity)" ng-repeat="(colRenderIndex, col) in colContainer.renderedColumns track by col.colDef.name" class="ui-grid-cell" ng-class="{ \'ui-grid-row-header-cell\': col.isRowHeader }" ui-grid-cell ></div>',n.gridOptions.columnDefs=[{name:"externalaudit_id",displayName:"EA Id",type:"number",width:80,cellTooltip:!0,headerTooltip:!0},{name:"verification_inspection",displayName:"Verification inspection",cellTooltip:!0,headerTooltip:!0},{name:"response",displayName:"Response",cellTooltip:!0,headerTooltip:!0},{name:"externalaudit_officer_assigned",displayName:"Team leader",cellTooltip:!0,headerTooltip:!0},{name:"project_title",displayName:"Project name",cellTooltip:!0,headerTooltip:!0}],n.gridOptions.onRegisterApi=function(e){n.gridApi=e},n.setSearchUrl=function(){_.forOwn(n.dateCriteria,function(e,t){e instanceof Date&&(e.setHours(12),n.criteria[t]=e.toJSON().substr(0,10))}),_.isEmpty(n.criteria)||(_.isEqual(c.criteria,n.criteria)?(c.allowCache=!1,n.search()):t.search(n.criteria))},n.search=function(){n.isSearching=!0,n.showResultGrid=!1,c.search(n.criteria).then(function(e){n.gridOptions.data=e,n.isSearching=!1,n.showResultGrid=!0})},n.exportExternalAuditResults=function(e){exportObj.exportData(e,"externalAudit")},n.reset=function(){n.criteria={},n.dateCriteria={},c.criteria={},n.gridOptions.data=[],n.showResultGrid=!1},n.criteria=t.search(),n.dateCriteria={},n.criteria.externalaudit_date_submission_from&&(n.dateCriteria.externalaudit_date_submission_from=new Date(n.criteria.externalaudit_date_submission_from)),n.criteria.externalaudit_date_submission_to&&(n.dateCriteria.externalaudit_date_submission_to=new Date(n.criteria.externalaudit_date_submission_to)),_.isEmpty(n.criteria)&&!_.isEmpty(c.criteria)?t.search(c.criteria):_.isEmpty(n.criteria)||n.search()}]),controllers.controller("AdvancedCodesController",["$scope","$routeParams","EditCode","$timeout","$q","$interval","uiGridConstants",function(n,e,t,i,r,a,o){n.routeParams=e,n.parts={code:{form:null,state:SavingStateEnum.Loading}},n.gridOptions={},n.gridOptions.enableCellEditOnFocus=!0,n.gridOptions.showGridFooter=!0,n.gridOptions.minRowsToShow=15,n.gridOptions.rowEditWaitInterval=1e3,n.gridOptions.enableFiltering=!0,n.gridOptions.columnDefs=[{name:"id",type:"number",enableCellEdit:!1,width:60},{name:"description1",cellTooltip:!0,width:"*"},{name:"description2",cellTooltip:!0,width:150},{name:"value1",type:"number",width:100},{name:"dropdown_list",cellTooltip:!0,width:150},{name:"updated_by",enableCellEdit:!1,width:120},{name:"updated_at",enableCellEdit:!1,enableFiltering:!1,type:"date",cellFilter:'date:"d MMM yyyy HH:mm:ss"',width:160},{name:"delete",displayName:"",enableSorting:!1,enableCellEdit:!1,enableFiltering:!1,enableColumnMenu:!1,width:80,cellTemplate:'<div><button ng-show="row.entity.deleted_at" ng-click="grid.appScope.undeleteRow(row.entity)" class="btn undelete btn-sm btn-link">undelete</button><button ng-hide="row.entity.deleted_at" ng-click="grid.appScope.deleteRow(row.entity)" class="btn delete btn-sm btn-link">delete</button></div>'}],n.saveRow=function(e){var t=e.$update();n.gridApi.rowEdit.setSavePromise(e,t)},n.deleteRow=function(e){var t=e.$delete({});n.gridApi.rowEdit.setSavePromise(e,t)},n.undeleteRow=function(e){e.deleted_at=null,n.saveRow(e)},n.addRow=function(){(new t).$save().then(function(e){n.gridOptions.data.push(e),i(function(){n.gridApi.cellNav.scrollToFocus(e,n.gridOptions.columnDefs[0])})})},n.gridOptions.onRegisterApi=function(e){(n.gridApi=e).rowEdit.on.saveRow(n,n.saveRow)},t.query({},function(e){n.gridOptions.data=e})}]),controllers.controller("AdvancedUsersController",["$scope","$routeParams","EditUser","$timeout","$q","$interval","uiGridConstants",function(n,e,t,i,r,a,o){n.routeParams=e,n.parts={code:{form:null,state:SavingStateEnum.Loading}},n.gridOptions={},n.gridOptions.enableCellEditOnFocus=!0,n.gridOptions.showGridFooter=!0,n.gridOptions.minRowsToShow=15,n.gridOptions.rowEditWaitInterval=1e3,n.gridOptions.enableFiltering=!0,n.gridOptions.columnDefs=[{name:"id",type:"number",enableCellEdit:!1,width:60},{name:"initials",cellTooltip:!0,width:80},{name:"name",cellTooltip:!0,width:"*"},{name:"job_position_code",cellTooltip:!0,width:80},{name:"job_position_name",cellTooltip:!0,width:100},{name:"email",cellTooltip:!0,width:100},{name:"password",cellTooltip:!0,width:80},{name:"is_passive",type:"number",width:90},{name:"role_ids",enableCellEdit:!0,width:90},{name:"updated_by",enableCellEdit:!1,width:120},{name:"updated_at",enableCellEdit:!1,enableFiltering:!1,type:"date",cellFilter:'date:"d MMM yyyy HH:mm:ss"',width:160},{name:"delete",displayName:"",enableSorting:!1,enableCellEdit:!1,enableFiltering:!1,enableColumnMenu:!1,width:80,cellTemplate:'<div><button ng-show="row.entity.deleted_at" ng-click="grid.appScope.undeleteRow(row.entity)" class="btn undelete btn-sm btn-link">undelete</button><button ng-hide="row.entity.deleted_at" ng-click="grid.appScope.deleteRow(row.entity)" class="btn delete btn-sm btn-link">delete</button></div>'}],n.saveRow=function(e){var t=e.$update();n.gridApi.rowEdit.setSavePromise(e,t)},n.deleteRow=function(e){var t=e.$delete({});n.gridApi.rowEdit.setSavePromise(e,t)},n.undeleteRow=function(e){e.deleted_at=null,n.saveRow(e)},n.addRow=function(){(new t).$save().then(function(e){n.gridOptions.data.push(e),i(function(){n.gridApi.cellNav.scrollToFocus(e,n.gridOptions.columnDefs[0])})})},n.gridOptions.onRegisterApi=function(e){(n.gridApi=e).rowEdit.on.saveRow(n,n.saveRow)},t.query({},function(e){n.gridOptions.data=e})}]),controllers.controller("AdvancedLeadAgenciesController",["$scope","$routeParams","EditLeadAgency","$timeout","$q","$interval","uiGridConstants",function(n,e,t,i,r,a,o){n.routeParams=e,n.parts={code:{form:null,state:SavingStateEnum.Loading}},n.gridOptions={},n.gridOptions.enableCellEditOnFocus=!0,n.gridOptions.showGridFooter=!0,n.gridOptions.minRowsToShow=15,n.gridOptions.rowEditWaitInterval=1e3,n.gridOptions.enableFiltering=!0,n.gridOptions.columnDefs=[{name:"id",type:"number",enableCellEdit:!1,width:60},{name:"short_name",cellTooltip:!0,width:150},{name:"long_name",cellTooltip:!0,width:"*"},{name:"updated_by",enableCellEdit:!1,width:120},{name:"updated_at",enableCellEdit:!1,enableFiltering:!1,type:"date",cellFilter:'date:"d MMM yyyy HH:mm:ss"',width:160},{name:"delete",displayName:"",enableSorting:!1,enableCellEdit:!1,enableFiltering:!1,enableColumnMenu:!1,width:80,cellTemplate:'<div><button ng-show="row.entity.deleted_at" ng-click="grid.appScope.undeleteRow(row.entity)" class="btn undelete btn-sm btn-link">undelete</button><button ng-hide="row.entity.deleted_at" ng-click="grid.appScope.deleteRow(row.entity)" class="btn delete btn-sm btn-link">delete</button></div>'}],n.saveRow=function(e){var t=e.$update();n.gridApi.rowEdit.setSavePromise(e,t)},n.deleteRow=function(e){var t=e.$delete({});n.gridApi.rowEdit.setSavePromise(e,t)},n.undeleteRow=function(e){e.deleted_at=null,n.saveRow(e)},n.addRow=function(){(new t).$save().then(function(e){n.gridOptions.data.push(e),i(function(){n.gridApi.cellNav.scrollToFocus(e,n.gridOptions.columnDefs[0])})})},n.gridOptions.onRegisterApi=function(e){(n.gridApi=e).rowEdit.on.saveRow(n,n.saveRow)},t.query({},function(e){n.gridOptions.data=e})}]),controllers.controller("LoginController",["$scope","$http","$routeParams","$location","UserInfo","$timeout",function(r,e,t,a,o,n){r.loginData={},r.sendData={},r.resetData={},r.loginMessages=[],r.sendMessages=[],r.resetMessages=[],r.loginFormDisabled=!1,r.sendFormDisabled=!1,r.resetFormDisabled=!1,r.forgot=function(){console.debug("/password/email")};function s(e){return _.flatten(_.values(e))}r.login=function(){r.loginForm.$invalid||(r.loginFormDisabled=!0,e.post("/auth/login",r.loginData).success(function(e,t,n,i){r.loginMessages=s(e),o.reTry(),a.path("/")}).error(function(e,t,n,i){r.loginMessages=s(e),r.loginFormDisabled=!1}))},r.send=function(){r.sendForm.$invalid||(r.sendFormDisabled=!0,e.post("/password/email",r.sendData).success(function(e,t,n,i){r.sendMessages=s(e)}).error(function(e,t,n,i){r.sendMessages=s(e),r.sendFormDisabled=!1}))},r.reset=function(){r.resetForm.$invalid||(r.resetFormDisabled=!0,r.resetData.token=t.token,e.post("/password/reset",r.resetData).success(function(e,t,n,i){r.resetMessages=s(e),o.reTry(),a.path("/user")}).error(function(e,t,n,i){r.resetMessages=s(e),r.resetFormDisabled=!1}))},n(function(){})}]),(controllers=angular.module("seroApp.controllers")).controller("EiapermitPirkingController",["$scope","$http","EiaPermit","Document","Valuelists","$q",function(o,e,s,c,d,u){o.lastId="..",o.criteria={},o.dryrun=!0,o.eiaspermits=[],o.working=!1,o.info={error:0,nochange:0,changed:0,finished:function(){return this.error+this.nochange+this.changed},progress:function(){return 0==o.eiaspermits.length?0:Math.round(100*this.finished()/o.eiaspermits.length)}},o.beginPirking=function(){o.info.error=0,o.info.nochange=0,o.info.changed=0,console.log("beginPirking"),console.log("dryrun:",o.dryrun),o.working=!0,e({method:"GET",url:"/pirking/v1/eiaspermits",params:o.criteria}).then(function(e){o.eiaspermits=e.data,console.log("beginPirking finished"),o.beginUpdate()},function(e){console.log("oh noes")})};o.beginUpdate=function(){function n(i){i.updating=!0;var r={projectId:i.project_id,eiapermitId:i.eiapermit_id},e=s.get(r).$promise,t=c.query(r).$promise,a=u.defer();return u.all([e,t]).then(function(e){var t=e[0],n=updateEiaPermitStatus(t,e[1]);i.status_id_new=t.status,i.status_description_new=function(e){var t=_.find(d.eiastatus,{id:e});return t?t.description1:""}(t.status),n?o.dryrun?(i.changed=!0,i.result="CHANGED",o.info.changed+=1,i.updating=!1,a.resolve()):(t.pirking=!0,t.$update(r,function(e){i.changed=!0,i.result="CHANGED",o.info.changed+=1,i.updating=!1,i.eiapermit_updated_at=e.updated_at,a.resolve()})):(i.nochange=!0,i.result="NO CHANGE",o.info.nochange+=1,i.updating=!1,a.resolve())},function(e){i.updating=!1,i.error=!0,i.result="ERROR",o.info.error+=1,a.reject("Server Error")}),a.promise}console.log("beginUpdate"),o.eiaspermits.reduce(function(e,t){return e.then(function(){return n(t)}).catch(function(e){console.log("ERROR:",e)})},u.when()).then(function(){console.log("beginUpdate finished"),o.working=!1})}}]),controllers.controller("ExternalAudiPirkingController",["$scope","$http","ProjectFactory","Document","Valuelists","$q",function(o,e,t,n,s,c){o.lastId="..",o.criteria={},o.dryrun=!0,o.EaData=[],o.working=!1,o.info={error:0,nochange:0,changed:0,finished:function(){return this.error+this.nochange+this.changed},progress:function(){return 0==o.EaData.length?0:Math.round(100*this.finished()/o.EaData.length)}},o.beginPirking=function(){o.info.error=0,o.info.nochange=0,o.info.changed=0,console.log("beginPirking"),console.log("dryrun:",o.dryrun),o.working=!0,e({method:"GET",url:"/pirking/v1/externalAuditList",params:o.criteria}).then(function(e){o.EaData=e.data,console.log("beginPirking finished"),o.beginUpdate()},function(e){console.log("oh noes")})};o.beginUpdate=function(){function n(i){i.updating=!0;var r={projectId:i.project_id,externalauditId:i.externalaudit_id},e=t.retrieveProjectData(r),a=c.defer();return c.all([e[5]]).then(function(e){var t=e[0][0];console.log(i,"data");var n=updateExternalAuditStatus(t,t.documents);i.status_id_new=t.status,i.status_description_new=function(e){var t=_.find(s.eastatus,{id:e});return t?t.description1:""}(t.status),console.log(i,t,"data"),n&&parseInt(i.status_id_new)!=parseInt(i.status_id)?o.dryrun?(i.changed=!0,i.result="CHANGED",o.info.changed+=1,i.updating=!1,a.resolve()):(t.pirking=!0,t.$update(r,function(e){i.changed=!0,i.result="CHANGED",o.info.changed+=1,i.updating=!1,i.externalaudit_updated_at=e.updated_at,a.resolve()})):(i.nochange=!0,i.result="NO CHANGE",o.info.nochange+=1,i.updating=!1,a.resolve())},function(e){i.updating=!1,i.error=!0,i.result="ERROR",o.info.error+=1,a.reject("Server Error")}),console.log(a),a.promise}console.log("beginUpdate"),o.EaData.reduce(function(e,t){return e.then(function(){var e=n(t);return console.log(e,"ray"),e}).catch(function(e){console.log("ERROR:",e)})},c.when()).then(function(){console.log("beginUpdate finished"),o.working=!1})}}]),controllers.controller("AuditInspecitionPirkingController",["$scope","$http","ProjectFactory","Valuelists","$q",function(o,e,t,s,c){o.lastId="..",o.criteria={},o.dryrun=!0,o.aiData=[],o.working=!1,o.info={error:0,nochange:0,changed:0,finished:function(){return this.error+this.nochange+this.changed},progress:function(){return 0==o.aiData.length?0:Math.round(100*this.finished()/o.aiData.length)}},o.beginPirking=function(){o.info.error=0,o.info.nochange=0,o.info.changed=0,console.log("beginPirking"),console.log("dryrun:",o.dryrun),o.working=!0,e({method:"GET",url:"/pirking/v1/auditInspection",params:o.criteria}).then(function(e){o.aiData=e.data,console.log("beginPirking finished"),o.beginUpdate()},function(e){console.log("oh noes")})};o.beginUpdate=function(){function n(i){i.updating=!0;var r={projectId:i.project_id,auditinspectionId:i.auditsInspections_id},e=t.retrieveProjectData(r),a=c.defer();return c.all([e[3]]).then(function(e){var t=e[0][0],n=updateAuditInspectionStatus(t);i.status_id_new=t.status,i.status_description_new=function(e){var t=_.find(s.auditinspectionstatus,{id:e});return t?t.description1:""}(t.status),console.log(i,t,"data"),n&&parseInt(i.status_id_new)!=parseInt(i.status_id)?o.dryrun?(i.changed=!0,i.result="CHANGED",o.info.changed+=1,i.updating=!1,a.resolve()):(t.pirking=!0,t.$update(r,function(e){i.changed=!0,i.result="CHANGED",o.info.changed+=1,i.updating=!1,i.externalaudit_updated_at=e.updated_at,a.resolve()})):(i.nochange=!0,i.result="NO CHANGE",o.info.nochange+=1,i.updating=!1,a.resolve())},function(e){i.updating=!1,i.error=!0,i.result="ERROR",o.info.error+=1,a.reject("Server Error")}),console.log(a),a.promise}console.log("beginUpdate"),o.aiData.reduce(function(e,t){return e.then(function(){return n(t)}).catch(function(e){console.log("ERROR:",e)})},c.when()).then(function(){console.log("beginUpdate finished"),o.working=!1})}}]);var directives=angular.module("seroApp.directives").directive("appVersion",["version",function(i){return function(e,t,n){t.text(i.replace(/\.0$/,"").replace(/\.00$/,".0").replace(/\.([1-9])$/,".0$1"))}}]);directives.directive("addPractitionerButton",["Practitioner",function(i){return{restrict:"A",link:function(e,t,n){t.bind("click",function(){new i({person:"Gunnar Nymann",city:"Oslo"}).$save()})}}}]),directives.directive("animateNewElement",["$animate",function(r){return function(e,i,t){e.$watch(t.animateNewElement,function(e,t){if(!0===e){console.log(i);var n="new-element";r.addClass(i,n,function(){r.removeClass(i,n)})}})}}]),directives.directive("hoverOnParent",[function(){return{restrict:"A",link:function(e,t,n){var i=n.hoverOnParent;t.parent(i).bind("mouseenter",function(){t.addClass("btn-link-hover")}),t.parent(i).bind("mouseleave",function(){t.removeClass("btn-link-hover")})}}}]),directives.directive("coordinatePasting",function(){return{require:"ngModel",link:function(e,t,n,i){i.$setViewValue("0.12104"),i.$render()}}}),directives.directive("setFocus",["$timeout",function(i){return{restrict:"A",link:function(e,t,n){i(function(){i(function(){t[0].focus()})})}}}]),directives.directive("statisticsPanel",function(){return{restrict:"E",scope:{part:"="},templateUrl:"partials/statisticsTablePanel.html"}}),angular.module("seroApp.directives").directive("seroDeleteButton",["$sce",function(e){return{restrict:"E",scope:{onYes:"&",text:"=",warning:"=",buttonClass:"="},templateUrl:"partials/directives.deleteButton.html"}}]),seroApp.filter("myDateFormat",function(n){return function(e){if(!e)return"tom";var t=new Date(e.replace(/-/g,"/"));return n("date")(t,"MMM-dd-yyyy")}});var version={version:"4.77.0"},services=angular.module("seroApp.services");services.value("version",version.version),services.factory("Practitioner",["$resource",function(e){return e("/api/v1/practitioner/:id",{id:"@id"},{update:{method:"PUT",isArray:!1}})}]),services.factory("Project",["$resource",function(e){return e("/api/v1/project/:projectId",{projectId:"@id"},{update:{method:"PUT",isArray:!1}})}]),services.factory("Organisation",["$resource",function(e){return e("/api/v1/organisation/:organisationId",{organisationId:"@id"},{update:{method:"PUT",isArray:!1}})}]),services.factory("EiaPermit",["$resource",function(e){return e("/api/v1/project/:projectId/eiapermit/:eiapermitId",{eiapermitId:"@id"},{update:{method:"PUT",isArray:!1}})}]),services.factory("Document",["$resource",function(e){return e("/api/v1/project/:projectId/eiapermit/:eiapermitId/document/:documentId",{documentId:"@id"},{update:{method:"PUT",isArray:!1}})}]),services.factory("Hearing",["$resource",function(e){return e("/api/v1/project/:projectId/eiapermit/:eiapermitId/document/:documentId/hearing/:hearingId",{hearingId:"@id"},{update:{method:"PUT",isArray:!1}})}]),services.factory("PermitLicense",["$resource",function(e){return e("/api/v1/project/:projectId/permitlicense/:permitlicenseId",{permitLicenseId:"@id"},{update:{method:"PUT",isArray:!1}})}]),services.factory("ExternalAudit",["$resource",function(e){return e("/api/v1/project/:projectId/externalaudit/:externalauditId",{externalauditId:"@id"},{update:{method:"PUT",isArray:!1}})}]),services.factory("DocumentEA",["$resource",function(e){return e("/api/v1/project/:projectId/externalaudit/:externalauditId/document/:documentId",{documentId:"@id"},{update:{method:"PUT",isArray:!1}})}]),services.factory("AuditInspection",["$resource",function(e){return e("/api/v1/project/:projectId/auditinspection/:auditinspectionId",{auditinspectionId:"@id"},{update:{method:"PUT",isArray:!1}})}]),services.factory("Valuelist",["$resource",function(e){return e("/api/v1/valuelist/:id",{id:"@id"})}]),services.factory("EnvInfo",["$http",function(e){return function(t){e.get("/env").success(function(e){return t(e)})}}]),services.factory("Valuelists",["Valuelist",function(e){return e.get({id:"all"})}]),services.factory("UserInfo",["$http","$location",function(t,n){function i(e){e?(_.merge(r.info,e),"/login"==n.path()&&n.path("/")):r.info=_.cloneDeep(a)}function e(){t.get("/user/info").success(i)}var r={info:{}},a={name:"Not signed in",role_1:!1,role_2:!1,role_3:!1,role_4:!1,role_5:!1,role_6:!1,role_7:!1,role_8:!1,roles:[],features:[]};return r.impersonate=function(e){i(null),t.get("/user/impersonate/"+e).success(i)},r.signout=function(){t.get("/auth/logout").success(function(){i(null),n.path("/login")})},r.getAllUsers=function(){t.get("/user/all").success(function(e){r.allusers=e})},r.reTry=function(){e()},i(null),e(),r}]),services.factory("EditCode",["$resource",function(e){return e("/edit/v1/code/:codeId",{codeId:"@id"},{update:{method:"PUT",isArray:!1}})}]),services.factory("EditUser",["$resource",function(e){return e("/edit/v1/user/:userId",{userId:"@id"},{update:{method:"PUT",isArray:!1}})}]),services.factory("EditLeadAgency",["$resource",function(e){return e("/edit/v1/leadagency/:leadAgencyId",{leadAgencyId:"@id"},{update:{method:"PUT",isArray:!1}})}]),services.factory("EiaPermitSearch",["$resource",function(e){return e("/search/v1/eiapermit")}]),services.factory("PermitLicenseSearch",["$resource",function(e){return e("/search/v1/permitlicense")}]),services.factory("ExternalAuditSearch",["$resource",function(e){return e("/search/v1/externalaudit")}]),services.factory("AuditInspectionSearch",["$resource",function(e){return e("/search/v1/auditinspection")}]),services.factory("ProjectSearch",["$resource",function(e){return e("/search/v1/project")}]),services.factory("ProjectStatistics",["$resource",function(e){return e("/statistics/v1/project")}]),services.factory("GeneralStatistics",["$resource",function(e){return e("/statistics/v1/general")}]),services.factory("EiaPermitSearchService",["EiaPermitSearch","$q",function(n,i){var r={criteria:{},allowCache:!0,rows:[],search:function(e){var t=i.defer();return _.isEqual(r.criteria,e)&&r.allowCache?t.resolve(r.rows):(r.criteria=_.clone(e),n.query(r.criteria,function(e){r.rows=e,t.resolve(r.rows),r.allowCache=!0})),t.promise}};return r}]),services.factory("PermitLicenseSearchService",["PermitLicenseSearch","$q",function(n,i){var r={criteria:{},allowCache:!0,rows:[],search:function(e){var t=i.defer();return _.isEqual(r.criteria,e)&&r.allowCache?t.resolve(r.rows):(r.criteria=_.clone(e),n.query(r.criteria,function(e){r.rows=e,t.resolve(r.rows),r.allowCache=!0})),t.promise}};return r}]),services.factory("ExternalAuditSearchService",["ExternalAuditSearch","$q",function(n,i){var r={criteria:{},allowCache:!0,rows:[],search:function(e){var t=i.defer();return _.isEqual(r.criteria,e)&&r.allowCache?t.resolve(r.rows):(r.criteria=_.clone(e),n.query(r.criteria,function(e){r.rows=e,t.resolve(r.rows),r.allowCache=!0})),t.promise}};return r}]),services.factory("SearchService",["AuditInspectionSearch","$q",function(n,i){var r={criteria:{},allowCache:!0,rows:[],search:function(e){var t=i.defer();return _.isEqual(r.criteria,e)&&r.allowCache?t.resolve(r.rows):(r.criteria=_.clone(e),n.query(r.criteria,function(e){r.rows=e,t.resolve(r.rows),r.allowCache=!0})),t.promise}};return r}]),services.factory("ProjectSearchService",["ProjectSearch","$q",function(n,i){var r={criteria:{},allowCache:!0,rows:[],search:function(e){var t=i.defer();return _.isEqual(r.criteria,e)&&r.allowCache?t.resolve(r.rows):(r.criteria=_.clone(e),n.query(r.criteria,function(e){r.rows=e,t.resolve(r.rows),r.allowCache=!0})),t.promise}};return r}]),services.factory("StatisticsService",["ProjectStatistics","$q",function(n,i){var r={allowCache:!0,projectData:{},getProjectData:function(e){var t=i.defer();return r.allowCache&&!_.isEmpty(r.projectData)?t.resolve(r.projectData):n.get({},function(e){r.projectData=e,t.resolve(e)}),t.promise}};return r}]);var data1={};services.factory("ProjectFactory",["$q","$filter","Project","Organisation","EiaPermit","Document","Hearing","ExternalAudit","DocumentEA","AuditInspection","Valuelists","UserInfo","PermitLicense",function(c,e,d,u,l,r,a,p,o,m,t,n,f){var g={project:{},organisation:{},eiaspermits:[],eiapermit:{},documents:[],document:{},hearings:[],hearing:{},permitslicenses:[],permitlicense:{},externalaudits:[],externalaudit:{},documents_ea:[],document_ea:{},auditsinspections:[],auditinspection:{}};return g.valuelists=t,g.userinfo=n,g.hasData={eiapermits:!1,eiapermit:!1,documents:!1,document:!1,hearings:!1,hearing:!1,permitslicenses:!1,permitlicense:!1,externalaudits:!1,externalaudit:!1,documents_ea:!1,document_ea:!1},g.retrieveProjectData=function(e){var t=c.defer(),n=c.defer(),i=c.defer(),r=c.defer(),a=c.defer(),o=c.defer();if(g.project.id!=e.projectId){var s=_.omit(e,["eiapermitId","externalauditId","documentId","hearingId","permitlicenseId","auditinspectionId"]);g.empty(),g.project=d.get(s,function(e){t.resolve(e),g.organisation=u.get({organisationId:e.organisation_id},function(e){n.resolve(e)})}),g.eiaspermits=l.query(s,function(e){i.resolve(e)}),g.permitslicenses=f.query(s,function(e){o.resolve(e)}),g.externalaudits=p.query(s,function(e){r.resolve(e)}),g.auditsinspections=m.query(s,function(e){a.resolve(e)})}else _.remove(g.permitslicenses,function(e){return e.is_new}),t.resolve(g.project),n.resolve(g.organisation),i.resolve(g.eiaspermits),o.resolve(g.permitslicenses),r.resolve(g.externalaudits),a.resolve(g.auditsinspections);return[t.promise,n.promise,i.promise,a.promise,o.promise,r.promise]},g.retrieveEiaPermit=function(t){var n=c.defer(),i=c.defer();if(g.eiapermit.id!=t.eiapermitId){g.emptyEiaPermit();var e=_.where(g.eiaspermits,{id:parseInt(t.eiapermitId)});1==e.length&&(g.eiapermit=e[0],g.eiapermit.$get(_.omit(t,["documentId","hearingId"]),function(e){n.resolve(e),g.documents=r.query(_.omit(t,["documentId","hearingId"]),function(e){i.resolve(e)})}))}else n.resolve(g.eiapermit),i.resolve(g.documents);return[n.promise,i.promise]},g.retrieveDocument=function(t){var n=c.defer(),i=c.defer();if(g.document.id!=t.documentId){g.emptyDocument();var e=_.where(g.documents,{id:parseInt(t.documentId)});1==e.length&&(g.document=e[0],g.document.$get(_.omit(t,["hearingId"]),function(e){g.hearings=a.query(_.omit(t,["hearingId"]),function(e){i.resolve(e)}),n.resolve(e)}))}else n.resolve(g.document),i.resolve(g.hearings);return[n.promise,i.promise]},g.retrieveHearing=function(e){var t=c.defer();if(g.hearing.id!=e.hearingId){g.emptyHearing();var n=_.where(g.hearings,{id:parseInt(e.hearingId)});1==n.length&&(g.hearing=n[0],g.hearing.$get(e,function(e){t.resolve(e)}))}else t.resolve(g.hearing);return[t.promise]},g.retrieveExternalAudit=function(t){var n=c.defer(),i=c.defer();g.emptyExternalAudit();var e=_.where(g.externalaudits,{id:parseInt(t.externalauditId)});return 1==e.length&&(g.externalaudit=e[0],g.externalaudit.$get(_.omit(t,["documentId"]),function(e){g.documents_ea=o.query(_.omit(t,["documentId"]),function(e){i.resolve(e)}),n.resolve(e)})),[n.promise,i.promise]},g.retrieveDocumentEA=function(e){var t=c.defer();if(g.document_ea.id!=e.documentId){g.emptyDocumentEA();var n=_.where(g.documents_ea,{id:parseInt(e.documentId)});1==n.length&&(g.document_ea=n[0],g.document_ea.$get(_.omit(e,["hearingId"]),function(e){t.resolve(e)}))}else t.resolve(g.document_ea);return[t.promise]},g.retrieveAuditInspection=function(e){var t=c.defer();if(e.auditinspectionId){var n=_.where(g.auditsinspections,{id:parseInt(e.auditinspectionId)});1==n.length&&(g.auditinspection=n[0],g.auditinspection.$get(e,function(e){t.resolve(e)}))}return[t.promise]},g.retrievePermitLicense=function(e){data1=g.permitslicenses;var t=c.defer();if(e.permitlicenseId){var n=_.where(g.permitslicenses,{id:parseInt(e.permitlicenseId)});1==n.length&&(g.permitlicense=n[0],g.permitlicense.$get(e,function(e){t.resolve(e)}))}return[t.promise]},g.getProjectSummary=function(e){var t=g.project;return t.title?t.title:""},g.getCodeFromValuelist=function(e,t){"string"==typeof t&&(t=parseInt(t));var n=_.find(g.valuelists[e],{id:t});return n?n.description1:""},g.setOrganisation=function(e){var t=c.defer();return e=new u(e),(g.organisation=e).$get({},function(e){t.resolve(e)}),t.promise},g.setEiaPermit=function(e){var t=c.defer();return g.eiapermit=e,t.resolve(e),t.promise},g.setAuditInspection=function(e){var t=c.defer();return g.auditinspection=e,t.resolve(e),t.promise},g.empty=function(){g.project={},g.organisation={},g.eiaspermits=[],g.emptyEiaPermit(),g.emptyExternalAudit(),g.auditsinspections=[],g.auditinspection={}},g.emptyEiaPermit=function(){g.eiapermit={},g.documents=[],g.emptyDocument()},g.emptyDocument=function(){g.document={},g.hearings=[],g.emptyHearing()},g.emptyHearing=function(){g.hearing={}},g.emptyExternalAudit=function(){g.externalaudit={},g.documents_ea=[],g.emptyDocumentEA()},g.emptyDocumentEA=function(){g.document_ea={}},g.createNewProject=function(e){var t={has_industrial_waste_water:42,organisation_id:e.id,risk_level:null,is_new:!0};g.project=new d(t)},g.createNewOrganisation=function(){g.organisation=new u({is_new:!0})},g.createNewEiaPermit=function(e){var t={project_id:e.id,inspection_recommended:42,is_new:!0};g.eiapermit=new l(t),g.eiaspermits.push(g.eiapermit),g.documents=[]},g.createNewDocument=function(e){var t={eia_permit_id:e.id,director_copy_no:1,is_new:!0};g.document=new r(t),g.documents.unshift(g.document),g.hearings=[]},g.createNewHearing=function(e){var t={document_id:e.id,is_new:!0};g.hearing=new a(t),g.hearings.unshift(g.hearing)},g.deleteEiaPermit=function(e){function t(e){g.eiaspermits.splice(e,1),g.eiapermit={}}var n=_.findIndex(g.eiaspermits,{id:g.eiapermit.id});g.eiapermit.is_new?t(n):g.eiapermit.$delete(e,function(){t(n)})},g.deleteDocument=function(e){function t(e){g.documents.splice(e,1),g.document={}}var n=c.defer();if(g.document.is_new)t(0);else{var i=_.findIndex(g.documents,{id:g.document.id});g.document.$delete(e,function(){t(i),n.resolve()})}return n.promise},g.moveDocument=function(e,t){var n=c.defer(),i=_.findIndex(g.documents,{id:g.document.id});return g.document.eia_permit_id=t,g.document.$update(e,function(e){!function(e){g.documents.splice(e,1),g.document={}}(i),n.resolve(e)},function(){n.reject("Moving failed")}),n.promise},g.moveDocumentEA=function(e,t){var n=c.defer(),i=_.findIndex(g.documents_ea,{id:g.document_ea.id});return g.document_ea.external_audit_id=t,g.document_ea.$update(e,function(e){!function(e){g.documents_ea.splice(e,1),g.document_ea={}}(i),n.resolve(e)},function(){n.reject("Moving failed")}),n.promise},g.deleteHearing=function(e){function t(e){g.hearings.splice(e,1),g.hearing={}}var n=c.defer();if(g.hearing.is_new)t(0);else{var i=_.findIndex(g.hearings,{id:g.hearing.id});g.hearing.$delete(e,function(){t(i),n.resolve()})}return n.promise},g.createNewExternalAudit=function(e){var t={project_id:e.id,is_new:!0};g.externalaudit=new p(t),g.externalaudits.push(g.externalaudit),g.documents_ea=[]},g.createNewDocumentEA=function(e){var t={external_audit_id:e.id,director_copy_no:1,is_new:!0};g.document_ea=new o(t),g.documents_ea.unshift(g.document_ea)},g.deleteExternalAudit=function(e){function t(e){g.externalaudits.splice(e,1),g.externalaudit={}}var n=_.findIndex(g.externalaudits,{id:g.externalaudit.id});g.externalaudit.is_new?t(n):g.externalaudit.$delete(e,function(){t(n)})},g.deleteDocumentEA=function(e){function t(e){g.documents_ea.splice(e,1),g.document_ea={}}var n=c.defer();if(g.document_ea.is_new)t(0);else{var i=_.findIndex(g.documents_ea,{id:g.document_ea.id});g.document_ea.$delete(e,function(){t(i),n.resolve()})}return n.promise},g.createNewAuditInspection=function(e,t,n,i,r){var a={project_id:e.id,year:t,type:n,reason:i,date_carried_out:r,days:1,status:70,performance_level:47,lead_officer:g.userinfo.info.id,is_new:!0};g.auditinspection=new m(a),g.auditsinspections.push(g.auditinspection)},g.deleteAuditInspection=function(e){function t(e){g.auditsinspections.splice(e,1),0<g.auditsinspections.length?g.auditinspection=g.auditinspection[0]:g.auditinspection={}}var n=_.findIndex(g.auditsinspections,{id:g.auditinspection.id});g.auditinspection.is_new?t(n):g.auditinspection.$delete(e,function(){t(n)})},g.createNewPermitLicense=function(e,t,n,i,r,a,o,s,c){var d={project_id:e.id,regulation:t,ecosystem:n,regulation_activity:i,area:r,unit:a,approved_by_the_lc1:o,approved_by_the_dec:s,waste_license_type:c,is_new:!0};g.permitlicense=new f(d),g.permitslicenses.push(g.permitlicense)},g.deletePermitLicense=function(e){function t(e){g.permitslicenses.splice(e,1),g.permitlicense={}}var n=_.findIndex(g.permitslicenses,{id:g.permitlicense.id});g.permitlicense.is_new?t(n):g.permitlicense.$delete(e,function(){t(n)})},g.deleteProject=function(e){function t(){g.project={},n.resolve()}var n=c.defer();return g.project.is_new?t():g.project.$delete(e,function(){t()}),n.promise},g.save=function(e,t){var n=c.defer();if(t.is_new){var i=_.omit(e,function(e){return"new"==e});t.$save(i,function(e){n.resolve(e)},function(){n.reject("Saving new failed")})}else t.$update(e,function(e){n.resolve(e)},function(){n.reject("Saving exisiting failed")});return n.promise},g}]);var validations=angular.module("pax.validations");function isNumberInRange(e,t,n){return!(null!==e&&n<e)&&!(null!==t&&t<n)}function getColumns(e){var i=[];return $.each(e[0],function(e,t){var n={};n.headertext=e,n.datatype="string",n.datafield=e,i.push(n)}),i}validations.directive("decimal",function(){return{require:"ngModel",link:function(e,t,n,r){var i=n.min?parseFloat(n.min):null,a=n.max?parseFloat(n.max):null,o=n.decimal?"{0,"+parseInt(n.decimal)+"}":"+",s=n.negativeNumber?"\\-?":"",c=new RegExp("^"+s+"\\d+((\\.|\\,)\\d"+o+")?$");r.$parsers.push(function(e,t){if(r.$isEmpty(e))return null;var n=e.toString().trim().replace(",","."),i=parseFloat(n);return r.$isEmpty(i)?void 0:i}),r.$formatters.push(function(e){if(r.$isEmpty(e)||!n.decimal)return e;var t=parseInt(n.decimal);return _.round(parseFloat(e),t).toFixed(t)}),r.$validators.decimalInRange=function(e,t){return!!r.$isEmpty(e)||!!c.test(t)&&isNumberInRange(i,a,t)}}}}),validations.directive("integer",function(){return{require:"ngModel",link:function(e,t,n,i){var r=n.min?parseInt(n.min):null,a=n.max?parseInt(n.max):null,o=n.negativeNumber?"\\-?":"",s=new RegExp("^"+o+"\\d+$");i.$validators.integerInRange=function(e,t){return!!i.$isEmpty(e)||!!s.test(t)&&isNumberInRange(r,a,t)}}}}),validations.directive("certificateNumber",function(){return{require:"ngModel",link:function(e,t,n,i){var r=new RegExp("^CC/(EIA|EA|EP)/[0-9]{3}/[0-9]{2}$");i.$validators.certificateNumber=function(e,t){return!!i.$isEmpty(e)||r.test(t)}}}}),function(o){var s={containerid:null,datatype:"table",dataset:null,columns:null,returnUri:!0,locale:"en-US",worksheetName:"My Worksheet",encoding:"utf-8"},c=s;o.fn.excelexportjs=function(e){c=o.extend({},s,e);var t,r=[];return function(){var e=c.datatype.toLowerCase();switch(function(e){switch(e){case"table":break;case"json":r=c.dataset;break;case"xml":o(c.dataset).find("row").each(function(e,t){var n={};null!=this.attributes&&0<this.attributes.length&&(o(this.attributes).each(function(){n[this.name]=this.value}),r.push(n))});break;case"jqgrid":o(c.dataset).find("rows > row").each(function(e,t){var n={};null!=this.children&&0<this.children.length&&(o(this.children).each(function(){n[this.tagName]=o(this).text()}),r.push(n))})}}(e),e){case"table":t=i(o("<div>").append(o("#"+c.containerid).clone()).html());break;case"json":case"xml":case"jqgrid":t=i(n())}{if(c.returnUri)return t;a()||window.open(t)}}();function n(){var i="<table id='tabledata' style='table-layout:inherit;white-space: nowrap;'>";return i+="<thead><tr>",o(c.columns).each(function(e,t){1!=this.ishidden&&(i+="<th",this.width,i+=">",i+=this.headertext,i+="</th>")}),i+="</tr></thead>",i+="<tbody>",o(r).each(function(e,n){i+="<tr>",o(c.columns).each(function(e,t){n.hasOwnProperty(this.datafield)&&1!=this.ishidden&&(i+="<td",i+=">",i+=n[this.datafield],i+="</td>")}),i+="</tr>"}),i+="</tbody>",i+="</table>"}function i(e){if(!a()){var t="<html xml:lang="+s.locale+" xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:x='urn:schemas-microsoft-com:office:excel' xmlns='http://www.w3.org/TR/REC-html40'>";t+="<head>",t+='<meta http-equiv="Content-type" content="text/html;charset='+s.encoding+'" />',t+="\x3c!--[if gte mso 9]>",t+="<xml>",t+="<x:ExcelWorkbook>",t+="<x:ExcelWorksheets>",t+="<x:ExcelWorksheet>",t+="<x:Name>",t+="{worksheet}",t+="</x:Name>",t+="<x:WorksheetOptions>",t+="<x:DisplayGridlines/>",t+="</x:WorksheetOptions>",t+="</x:ExcelWorksheet>",t+="</x:ExcelWorksheets>",t+="</x:ExcelWorkbook>",t+="</xml>",t+="<![endif]--\x3e",t+="</head>",t+="<body>",t+=e.replace(/"/g,"'"),t+="</body>";return function(e){return window.btoa(unescape(encodeURIComponent(e)))}(function(e,n){return e.replace(/{(\w+)}/g,function(e,t){return n[t]})}(t+="</html>",{worksheet:c.worksheetName,table:e}))}!function(e){var t=document.createElement("div");t.innerHTML=e;var n,i="<table border='2px'><tr bgcolor='#87AFC6'>",r=0;n="table"==c.datatype.toLowerCase()?document.getElementById(c.containerid):t.children[0];for(r=0;r<n.rows.length;r++)i=i+n.rows[r].innerHTML+"</tr>";i=(i=(i=(i+="</table>").replace(/<A[^>]*>|<\/A>/g,"")).replace(/<img[^>]*>/gi,"")).replace(/<input[^>]*>|<\/input>/gi,""),0<window.navigator.userAgent.indexOf("MSIE ")||!!navigator.userAgent.match(/Trident.*rv\:11\./)?(txtArea1.document.open("txt/html","replace"),txtArea1.document.write(i),txtArea1.document.close(),txtArea1.focus(),sa=txtArea1.document.execCommand("SaveAs",!0,c.worksheetName+".xlsx")):sa=window.open("data:application/vnd.ms-excel,"+encodeURIComponent(i));sa}(e)}function a(){return 0<(!!navigator.userAgent.match(/Trident/g)||!!navigator.userAgent.match(/MSIE/g))}}}(jQuery);var excelExport=function(e,t,n){e=exportHelpers.reformatDateFields(e,t.dateFields),e=exportHelpers.renameFields(e,t.fieldmap),e=exportHelpers.sortObj(e,Object.values(t.fieldmap)),e=exportHelpers.replaceNullValues(e);var i=$("#dvjson").excelexportjs({containerid:"dvjson",datatype:"json",dataset:e,columns:getColumns(e),worksheetName:""}),r=new Date,a=r.getDate()+"."+(r.getMonth()+1)+"."+r.getFullYear()+"_"+r.getHours()+"."+r.getMinutes(),o=exportHelpers.b64toBlob(i,"application/vnd.ms-excel"),s=URL.createObjectURL(o),c=document.createElement("a"),d=document.body.appendChild(c);d.href=s,d.download=n+"_"+a+".xls",d.click()},exportHelpers={renameFields:function(e,t){var n=(e=JSON.parse(JSON.stringify(e))).length;for(var i in t)if(t.hasOwnProperty(i))for(var r=t[i],a=0;a<n;a++){var o=e[a][i];e[a][r]=o,delete e[a][i]}return e},removeFields:function(e,t){for(var n=(e=JSON.parse(JSON.stringify(e))).length,i=0;i<n;i++){var r=e[i];for(var a in r)r.hasOwnProperty(a)&&t.includes(a)&&delete e[i][a]}return e},reformatDateFields:function(e,t){for(var n,i=[],r=0;r<e.length;r++){var a=e[r];for(var o in a)a.hasOwnProperty(o)&&t.includes(o)&&(a[o]=(n=a[o])?n.split("-").reverse().join("-"):n);i.push(a)}return i},replaceNullValues:function(e){for(var t=[],n=0;n<e.length;n++){var i=e[n];if("object"==typeof i){for(var r in i)if(i.hasOwnProperty(r)){var a=i[r];null==a||""==a?i[r]="NA":(i[r]=i[r]+"",i[r]=i[r].trim())}t.push(i)}}return t},sortObj:function(e,t){e=JSON.parse(JSON.stringify(e));for(var n=[],i=0;i<e.length;i++){for(var r=e[i],a={},o=0;o<t.length;o++){var s=t[o];a[s]=r[s]}n.push(a)}return n},b64toBlob:function(e,t){for(var n=atob(e),i=[],r=0;r<n.length;r+=512){for(var a=n.slice(r,r+512),o=new Array(a.length),s=0;s<a.length;s++)o[s]=a.charCodeAt(s);var c=new Uint8Array(o);i.push(c)}return new Blob(i,{type:t})}};!function(e,t){"function"==typeof define&&define.amd?define([],t(window,null)):"object"==typeof exports?module.exports=t(null,require("fs")):e.codegrid=t(e,null)}(this,function(n,u){var _,l,p,m="../tiles/",f=[9,13],d={},e={};function h(e,t){return Math.floor(((e+180)/360%1+1)%1*Math.pow(2,t))}l=function(e,t,n,i){var u,l,p,m,s,c,d,r={};if(r.x=e,r.y=t,r.zoom=n,!i.hasOwnProperty("grid")||!i.hasOwnProperty("keys"))return console.warn("Error in creating grid - no grid/keys attribute"),null;function f(e){return 93<=e&&e--,35<=e&&e--,e-32}function g(e){return e%1==0}return l=i.grid,p=i.keys,i.hasOwnProperty("data")&&(m=i.data),u=i.grid.length,s=Math.round(Math.log(u)/Math.log(2))+n,c=e*Math.pow(2,s-n),d=t*Math.pow(2,s-n),r.getCode=function(e,t,n){var i=h(t,s)-c,r=v(e,s)-d;if(!g(i)||!g(r)||i<0||r<0||u<=i||u<=r)return console.warn("Error in arguments to retrieve grid"),void n("Error in input coordinates: out of range");var a=function(e,t){var n=l[t],i=n.length;if(1<i&&i<4){var r=parseInt(n);if(r.isNaN||r<0||u<=r)return console.warn("Error in decoding compressed grid"),null;i=(n=l[r]).length}var a=0;if(i===u)a=n.charCodeAt(e);else if(1===i)a=n.charCodeAt(0);else for(var o=0,s=e;o<i-1;o+=2)if((s-=f(n.charCodeAt(o+1)))<0){a=n.charCodeAt(o);break}var c=f(a);if(!c.isNaN&&p.length>c){var d=p[c];if(""===d)return{};if(void 0===m){if(_.hasOwnProperty(d))return _[d]}else if(m.hasOwnProperty(d))return m[d]}return console.warn("Error in decoding grid data."),null}(i,r);if(null!==a){var o="None";return a.hasOwnProperty("code")&&(o=a.code,a.hasOwnProperty("subcode")&&(o=o+":"+a.subcode)),void n(null,o)}n("Error reading geocode data")},r},p=function(e){var a,t={},r=[],s=e[0];function o(e,t,n){for(var i=0;i<r.length;i++)if(r[i].x===e&&r[i].y===t)return void n(null,r[i]);!function(n,i,r){var a=Math.floor(n/Math.pow(2,s-5)),o=Math.floor(i/Math.pow(2,s-5));void 0===d[a]||void 0===d[a][o]||void 0===d[a][o][s]?g(m+a.toString()+"/"+o.toString()+".json",function(e,t){return e?(r("Grid data loading error."),console.warn("Error loading grid tile data: "+e)):void 0===t[s]?(r("Zoom level "+s.toString()+" not in loaded data."),console.warn("Zoom level "+s.toString()+" not in loaded data.")):(c(n,i,t[s],r),void 0===d[a]&&(d[a]={}),void(d[a][o]=t))}):c(n,i,d[a][o][s],r)}(e,t,function(e,t){if(!e)return r.push(t),void n(null,t);n(e)})}function c(e,t,n,i){return void 0===n[e]||void 0===n[e][t]?(i("Grid tile not found in loaded data."),console.warn("Grid tile "+s.toString()+"/"+e.toString()+"/"+t.toString()+" not found in loaded data.")):(i(null,l(e,t,s,n[e][t])),null)}return 1<e.length&&(a=p(e.slice(1))),t.getCode=function(n,i,r){o(h(i,s),v(n,s),function(e,t){e?r("Error getting grid data: "+e):t.getCode(n,i,function(e,t){e?r(e,t):"*"===t?a.getCode(n,i,r):r(e,t)})})},t},e.CodeGrid=function(e,t){var a,o,i={},s=!1,c=!0,d=[];function r(e){_=e.data,null!==(o=l(0,0,0,e))&&(s=!0),c=!1}return e?m=e:"undefined"!=typeof __dirname&&u.readFile&&(m=__dirname+"/"+m),n||u.readFile||!window||(n=window),t?r(t):g(m+"worldgrid.json",function(e,t){if(e)return console.warn("Error loading geocoding data: "+e);var n;for(r(t);n=d.shift();)i.getCode(n[0],n[1],n[2]);return null}),a=p(f),i.getCode=function(n,i,r){if(!s)return c?void d.push([n,i,r]):(console.warn("Error : grid not initialized."),void r("Error: grid not initialized."));o.getCode(n,i,function(e,t){e?r(e,t):"*"===t?a.getCode(n,i,r):r(e,t)})},i};var i=Math.atan((Math.exp(Math.PI)-Math.exp(-Math.PI))/2)/Math.PI*180;function v(e,t){return Math.abs(e)>=i?-1:Math.floor((1-Math.log(Math.tan(e*Math.PI/180)+1/Math.cos(e*Math.PI/180))/Math.PI)/2*Math.pow(2,t))}function g(i,r){if(n)if(n.XMLHttpRequest&&"undefined"!=typeof JSON){var t=new XMLHttpRequest;t&&(t.open("GET",i,!0),t.setRequestHeader("X-Requested-With","XMLHttpRequest"),t.setRequestHeader("Content-type","application/json"),t.onreadystatechange=function(){if(4===t.readyState&&200===t.status){var e=JSON.parse(t.responseText);r(null,e)}else 4===t.readyState&&r("HTTP request returned "+t.status.toString())},t.send())}else r("JSON request not supported.");else u&&u.readFile(i,function(e,t){if(e)"ENOENT"===e.code?(console.warn("File "+i+" not found."),r("File "+i+" not found.")):(console.warn(e.message),r(e.message));else{var n=JSON.parse(t);r(null,n)}})}return e});
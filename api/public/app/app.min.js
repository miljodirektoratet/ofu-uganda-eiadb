// Generated with grunt. Do not edit!


angular.$=angular.element,angular.$.prototype.parent=function(e){if(!e)return angular.$(this[0].parentNode);for(var t,i=[].slice.call(document.querySelectorAll(e)),n=this[0];"HTML"!==n.nodeName;){n=n.parentNode,-1===i.indexOf(n)||(t=n,n=document.documentElement)}return angular.$(t)};"use strict";var debug=!0;angular.module("seroApp.services",[]),angular.module("seroApp.directives",[]),angular.module("seroApp.controllers",[]),angular.module("pax.validations",[]);var seroApp=angular.module("seroApp",["ngRoute","ngResource","ngAnimate","ngMessages","ngSanitize","ui.bootstrap","ui.select2","ngFileUpload","ui.grid","ui.grid.edit","ui.grid.rowEdit","ui.grid.cellNav","ui.grid.resizeColumns","ui.grid.moveColumns","ui.grid.selection","seroApp.services","seroApp.directives","seroApp.controllers","pax.validations"]).config(["$routeProvider",function(e){var t={templateUrl:"partials/projectTabs.html",controller:"ProjectTabsController"};e.when("/",{templateUrl:"partials/home.html",controller:"HomeController"}),e.when("/projects",{templateUrl:"partials/projects.html",controller:"ProjectsController"}),e.when("/projects/:projectId",t),e.when("/projects/:projectId/eiaspermits",t),e.when("/projects/:projectId/eiaspermits/:eiapermitId",t),e.when("/projects/:projectId/eiaspermits/:eiapermitId/documents",t),e.when("/projects/:projectId/eiaspermits/:eiapermitId/documents/:documentId",t),e.when("/projects/:projectId/eiaspermits/:eiapermitId/documents/:documentId/hearings",t),e.when("/projects/:projectId/eiaspermits/:eiapermitId/documents/:documentId/hearings/:hearingId",t),e.when("/projects/:projectId/externalaudits",t),e.when("/projects/:projectId/externalaudits/:externalauditId",t),e.when("/projects/:projectId/externalaudits/:externalauditId/documents",t),e.when("/projects/:projectId/externalaudits/:externalauditId/documents/:documentId",t),e.when("/projects/:projectId/auditsinspections",t),e.when("/projects/:projectId/auditsinspections/:auditinspectionId",t),e.when("/projects/:projectId/permitslicenses",t),e.when("/projects/:projectId/permitslicenses/:permitlicenseId",t);var i={templateUrl:"partials/searchTabs.html",controller:"SearchTabsController"};e.when("/search",{redirectTo:"/search/projects"}),e.when("/search/projects",i),e.when("/search/eiaspermits",i),e.when("/search/permitslicenses",i),e.when("/search/auditsinspections",i),e.when("/search/externalaudits",i);e.when("/statistics",{redirectTo:"/statistics/projects"}),e.when("/statistics/projects",{templateUrl:"partials/statisticsTabs.html",controller:"StatisticsTabsController"}),e.when("/advanced/codes",{templateUrl:"partials/advancedCodes.html",controller:"AdvancedCodesController"}),e.when("/advanced/users",{templateUrl:"partials/advancedUsers.html",controller:"AdvancedUsersController"}),e.when("/advanced/leadagencies",{templateUrl:"partials/advancedLeadAgency.html",controller:"AdvancedLeadAgenciesController"}),e.when("/pirking",{templateUrl:"partials/pirking.html",controller:"PirkingController"}),e.when("/about",{templateUrl:"partials/about.html"}),e.when("/login",{templateUrl:"partials/login.html",controller:"UserController"}),e.when("/password/send",{templateUrl:"partials/passwordSend.html",controller:"LoginController"}),e.when("/password/reset/:token",{templateUrl:"partials/passwordReset.html",controller:"LoginController"}),e.when("/user",{templateUrl:"partials/user.html",controller:"UserController"}),e.when("/practitioners",{templateUrl:"partials/practitioners.html",controller:"PractitionersController"}),e.otherwise({redirectTo:"/"})}]).factory("authHttpResponseInterceptor",["$q","$location",function(t,i){return{responseError:function(e){return 0==i.path().indexOf("/password/reset/")||401===e.status&&i.path("/login"),t.reject(e)}}}]).config(["$httpProvider",function(e){e.interceptors.push("authHttpResponseInterceptor")}]),SavingStateEnum={None:"None",LoadingNew:"Loading new",Loading:"Loading",Loaded:"Loaded",SavingStarted:"Saving started",SavingFinished:"Saving finished",SavingFailed:"Saving failed",Invalid:"Form not valid",MissingDependency:"Missing dependency in other form"},ProjectTabEnum={Project:"Project",EiasPermits:"EIAS",PermitsLicenses:"Permits and Licenses",AuditsInspections:"Audits and Inspections",ExternalAudits:"External audits"},EiasPermitsTabEnum={EiaPermit:"EIA",Documents:"Documents",Hearings:"Hearings"},ExternalAuditsTabEnum={ExternalAudit:"External audit",Documents:"Documents",Hearings:"Hearings"},SearchTabEnum={Projects:"Projects",EiasPermits:"EIAS",PermitsLicenses:"Permits and Licenses",AuditsInspections:"Audits and Inspections",ExternalAudits:"External audits"},StatisticsTabEnum={Projects:"Projects",EiasPermits:"EIAS",AuditsInspections:"Audits and Inspections"},DocumentTagEnum={PermitLicenseApplicationForm:"Application form",PermitLicensePermitLicense:"Permit or license",PermitLicenseAttachments:"Attachment to the application"},fileUploadPattern="image/*,application/pdf,application/vnd.openxmlformats*,application/msword,text/plain,text/csv,application/octet-stream,binary/octet-stream",fileUploadNgfPattern="'image/*,application/pdf,application/vnd.openxmlformats*,application/msword,text/plain,text/csv,application/octet-stream,binary/octet-stream'",fileUploadMaxSize="20MB",exportObj={};function so(){console.log("ca")}function isCoordinateWithinUganda(e,t,i){if(!e||!t)return i(!1,{error:"undefined coordinates"});fetch("https://nominatim.openstreetmap.org/reverse?format=json&lat="+e+"&lon="+t,{headers:{"content-type":"application/json"},method:"GET",mode:"cors"}).then(function(e){return e.json()}).then(function(e){return e.address&&"ug"==e.address.country_code?i(!0,e):i(!1,e)}).catch(function(){return i(!1,{error:"network"})})}exportObj.exportMetaData={},exportObj.exportData=function(e,t){var i=this.exportMetaData[t];excelExport(e,i,t)},exportObj.exportMetaData.auditAndInspection={fieldmap:{auditinspection_code:"Control number",auditinspection_status:"Audit and inspection status",auditinspection_year:"Year",auditinspection_type:"Activity",auditinspection_reason:"Type",lead_officer_name:"Lead officer",other_officer_name:"Other officers",auditinspection_date_carried_out:"Date carried out",auditinspection_days:"Number of days",auditinspection_external_participants:"Participants from lead agencies, facilities etc.",auditinspection_coordinated:"Multisectoral",lead_agency_name:"Lead agencies",auditinspection_date_action_taken:"Date of response",auditinspection_action_taken:"Response",auditinspection_advance_notice:"Advanced notice",auditinspection_findings:"Description of findings",auditinspection_performance_level:"Performance level",auditinspection_recommendations:"Recommendations",auditinspection_date_deadline:"Follow-up date",auditinspection_date_closing:"Activity ended",auditinspection_remarks:"Remarks",project_id:"Project ID",project_title:"Project name",category_description:"Category",district_district:"District",organisation_id:"Developer ID",developer_name:"Developer name"},dateFields:["auditinspection_date_carried_out","auditinspection_date_deadline","auditinspection_date_closing","auditinspection_date_action_taken"]},exportObj.exportMetaData.project={fieldmap:{project_id:"Project ID",project_title:"Project name",category_description:"Category",district_district:"District",project_location:"Location",project_longitude:"Longitude",project_latitude:"Latitude",project_has_industrial_waste_water:"Industrial waste water?",project_risk_level:"Risk level",project_contact_person:"Contact person",project_remarks:"Project remarks",organization_id:"Developer ID",developer_name:"Developer name",developer_id:"TIN",organization_visiting_address:"Visiting address",organization_physical_address:"Physical address",organization_box_no:"PO box",organization_city:"City",organization_phone:"Phone",organization_fax:"Fax",organization_email:"Email",organization_remarks:"Developer remarks"},dateFields:[]},exportObj.exportMetaData.exportPermitsLicenses={fieldmap:{permitlicense_id:"Permit and license ID",permitlicense_regulation:"Regulation",permitlicense_date_submitted:"Date of submission",permitlicense_waste_license_type:"Waste license type",permitlicense_ecosystem:"Ecosystem",permitlicense_regulation_activity:"Regulation activity",permitlicense_area:"Area",permitlicense_unit:"Unit",permitlicense_approved_by_the_lc1:"LC1 approved",permitlicense_approved_by_the_dec:"DEC approved",permitlicense_application_number:"Application number",permitlicense_application_fee_receipt_number:"Application fee receipt number",permitlicense_date_feedback_to_applicants:"Date feedback to applicants",permitlicense_date_sent_officer:"Date feedback to applicants",permitlicense_date_sent_to_director:"Date sent to Director",permitlicense_date_sent_from_dep:"Date sent to team leader from dep",permitlicense_date_sent_officer:"Date sent to the officer",permitlicense_officer_assigned:"Team leader",permitlicense_handling_officer:"Officers to handle",permitlicense_officer_evaluation:"Application evaluation by officer",permitlicense_date_of_evaluation:"Date of evaluation",permitlicense_folio_no:"File and foliono.",permitlicense_inspection_recommended:"Inspection before decision ?",permitlicense_date_inspection:"Date of inspection",permitlicense_officer_recommend:"Recommendations by reviewer",permitlicense_fee_receipt_no:"Permit/license fee receipt number",permitlicense_date_fee_payed:"Date permit / license fee paid",permitlicense_date_sent_to_ed_for_decision:"Date to ED for decision",permitlicense_decision:"Decision taken",permitlicense_signature_on_permit_license:"Signature on permit / license",permitlicense_date_permit_license:"Date on the permit / licence",permitlicense_permit_license_no:"Permit / license number",permitlicense_date_permit_license_expired:"Date permit / license expired",permitlicense_documentation_files:"Soft copy",project_id:"Project ID",project_title:"Project name",category_name:"Category",district_district:"District",organisation_id:"Developer ID",organisation_name:"Developer name"},dateFields:["permitlicense_date_submitted","permitlicense_date_sent_to_director","permitlicense_date_sent_from_dep","permitlicense_date_sent_officer","permitlicense_date_of_evaluation","permitlicense_date_inspection","permitlicense_date_fee_payed","permitlicense_date_sent_to_ed_for_decision","permitlicense_date_permit_license","permitlicense_date_permit_license_expired","permitlicense_date_feedback_to_applicants"]},exportObj.exportMetaData.eiaspermits={fieldmap:{eiapermit_id:"EIA and permit ID",eiapermit_status:"EIA status",practitioner_teamleader:"Practitioner team leader",cost:"Cost of the proposed development",eiapermit_cost_currency:"Cost currency",eiapermit_expected_jobs_created:"Expected jobs created",team_leader_name:"Team leader",personnel_officers_name:"Officers to handle",eias_permits_inspection_recommendation:"Inspection before decision?",eiapermit_date_inspection:"Date of inspection",eiapermit_officer_recommend:"Recommendations by reviewer",eiapermit_fee:"Expected fees",eiapermit_fee_currency:"Fee currency",eiapermit_date_sent_ded_approval:"Date sent for approval",eiapermit_decision:"Decision taken",eiapermit_date_decision:"Date for decision",eiapermit_date_fee_notification:"Date of invoicing",eiapermit_date_fee_payed:"Date invoice is payed",eiapermit_fee_receipt_no:"Fee receipt number",eiapermit_designation:"Signature on certificate",eiapermit_date_certificate:"Date on the certificate",eiapermit_certificate_no:"Certificate number",eiapermit_date_cancelled:"Certificate canceled date",eiapermit_remarks:"Remarks",file_metadata:"Soft copy of certificate",document_codes:"Documents",project_id:"Project ID",project_title:"Project name",category_description:"Category",district_district:"District",developer_id:"Developer ID",developer_name:"Developer name"},dateFields:["eiapermit_date_inspection","eiapermit_date_sent_ded_approval","eiapermit_date_decision","eiapermit_date_fee_notification","eiapermit_date_fee_payed","eiapermit_date_certificate","eiapermit_date_cancelled"]},exportObj.exportMetaData.externalAudit={fieldmap:{externalaudit_id:"External audit ID",project_id:"Project ID",ea_type:"Type of external audit",team_leader:"Team leader",handling_officers:"Officers to handle",verification_inspection:"Verification inspection?",date_inspection:"Date of inspection",date_response:"Date of response",file_metadata_response_id:"Response letter",review_findings:"Review findings",response:"Response",date_deadline_compliance:"Date for complete compliance",doc_code:"Documents",project_project_name:"Project name",category_name:"Category",district_district:"District",organisation_id:"Developer ID",organisation_name:"Developer name"},dateFields:["date_inspection","date_response"]};var regexIso8601=/^(\d{4}-\d{2}-\d{2} \d{2}\:\d{2}\:\d{2})$/;function convertDateStringsToDates(e){if("object"!=typeof e)return e;for(var t in e)if(e.hasOwnProperty(t)){var i,n=e[t];if("string"==typeof n&&(i=n.match(regexIso8601))){var r=i[0].replace(" ","T");r+="Z",e[t]=new Date(r)}else"object"==typeof n&&convertDateStringsToDates(n)}}seroApp.config(["$httpProvider",function(e){e.defaults.transformResponse.push(function(e){return convertDateStringsToDates(e),e})}]);var uploadFile=function(e,t,i,n,r,a){n.$setValidity("serverError",!0);var o=e.defer();return r&&!r.$error?(r.upload=i.upload({url:"/file/v1/upload",file:r,fields:{tag:a}}),r.upload.then(function(e){t(function(){r.result=e.data,o.resolve(r)})},function(e){0<e.status&&(n.$setValidity("serverError",!1),r.progress=0,r.error=e.status+": "+e.data.message,o.reject(r.error))}),r.upload.progress(function(e){r.progress=Math.min(100,parseInt(100*e.loaded/e.total))})):o.reject("Validation error."),o.promise};function addDays(e,t){var i=new Date(e);return i.setDate(i.getDate()+t),i}function updateEiaPermitStatus(e,t){var i=e.status,n=null;if(e.date_cancelled)n=37;else if(e.certificate_no)n=36;else if(e.fee_receipt_no)n=35;else if(e.date_fee_notification)n=34;else if(e.date_decision)n=33;else if(e.date_sent_ded_approval)n=32;else{var r=_.groupBy(t,function(e){return e.type}),a=0,o={13:{conclusion:59,date_dispatched:58,date_sent_officer:57,date_sent_from_dep:56,date_sent_director:55,date_submitted:54},10:{date_dispatched:31,date_sent_officer:30,date_sent_from_dep:29,date_sent_director:28,date_submitted:27},9:{conclusion:26,date_dispatched:25,date_sent_officer:24,date_sent_from_dep:23,date_sent_director:22,date_submitted:21},8:{conclusion:20,date_dispatched:19,date_sent_officer:18,date_sent_from_dep:17,date_sent_director:16,date_submitted:15}};_.forEach([13,10,9,8],function(t){var e=r[t];if(e){var i=0;return _.forEach(e,function(e){e.conclusion&&_.includes([78,79],e.conclusion)&&o[t].conclusion?i=o[t].conclusion:e.date_sent_officer?i=o[t].date_sent_officer:e.date_sent_from_dep?i=o[t].date_sent_from_dep:e.date_sent_director?i=o[t].date_sent_director:e.date_submitted&&(i=o[t].date_submitted),a<i&&(a=i)}),!1}}),0<a&&(n=a)}return i!=n&&(e.status=n,!0)}(controllers=angular.module("seroApp.controllers")).controller("DatePickerController",["$scope",function(t){t.open=function(e){e.preventDefault(),e.stopPropagation(),t.opened=!0},t.datepickerOptions={startingDay:1}}]),controllers.controller("DatePickerSearchController",["$scope",function(t){t.open=function(e){e.preventDefault(),e.stopPropagation(),t.opened=!0},t.datepickerOptions={startingDay:1}}]),controllers.controller("NavBarController",["$scope","$location","UserInfo","EnvInfo",function(t,i,e,n){t.userinfo=e,n(function(e){t.envinfo=e.env}),t.isActive=function(e){return e===i.path()},t.isAdvancedActive=function(e){return 0==i.path().indexOf(e)}}]),controllers.controller("HomeController",["$scope","GeneralStatistics",function(t,e){t.counts={},e.get({},function(e){t.counts=e.counts})}]),controllers.controller("UserController",["$scope","UserInfo",function(e,t){e.userinfo=t,e.userid_to_impersonate=null,e.impersonate=function(){e.userinfo.impersonate(e.userid_to_impersonate)}}]),controllers.controller("PirkingController",["$scope","$http","EiaPermit","Document","Valuelists","$q",function(o,e,s,c,d,u){o.lastId="..",o.criteria={},o.dryrun=!0,o.eiaspermits=[],o.working=!1,o.info={error:0,nochange:0,changed:0,finished:function(){return this.error+this.nochange+this.changed},progress:function(){return 0==o.eiaspermits.length?0:Math.round(100*this.finished()/o.eiaspermits.length)}},o.beginPirking=function(){o.info.error=0,o.info.nochange=0,o.info.changed=0,console.log("beginPirking"),console.log("dryrun:",o.dryrun),o.working=!0,e({method:"GET",url:"/pirking/v1/eiaspermits",params:o.criteria}).then(function(e){o.eiaspermits=e.data,console.log("beginPirking finished"),o.beginUpdate()},function(e){console.log("oh noes")})};o.beginUpdate=function(){function i(n){n.updating=!0;var r={projectId:n.project_id,eiapermitId:n.eiapermit_id},e=s.get(r).$promise,t=c.query(r).$promise,a=u.defer();return u.all([e,t]).then(function(e){var t=e[0],i=updateEiaPermitStatus(t,e[1]);n.status_id_new=t.status,n.status_description_new=function(e){var t=_.find(d.eiastatus,{id:e});return t?t.description1:""}(t.status),i?o.dryrun?(n.changed=!0,n.result="CHANGED",o.info.changed+=1,n.updating=!1,a.resolve()):(t.pirking=!0,t.$update(r,function(e){n.changed=!0,n.result="CHANGED",o.info.changed+=1,n.updating=!1,n.eiapermit_updated_at=e.updated_at,a.resolve()})):(n.nochange=!0,n.result="NO CHANGE",o.info.nochange+=1,n.updating=!1,a.resolve())},function(e){n.updating=!1,n.error=!0,n.result="ERROR",o.info.error+=1,a.reject("Server Error")}),a.promise}console.log("beginUpdate"),o.eiaspermits.reduce(function(e,t){return e.then(function(){return i(t)}).catch(function(e){console.log("ERROR:",e)})},u.when()).then(function(){console.log("beginUpdate finished"),o.working=!1})}}]),controllers.controller("PractitionersController",["$scope","$filter","$animate","UserInfo","Practitioner","Valuelists",function(r,a,e,t,i,n){r.certificateYearMin=2e3,r.certificateYearMax=(new Date).getFullYear()+1,r.certificateYearValid=(new Date).getFullYear(),r.current=null,r.currentForm=null,r.userinfo=t,r.valuelists=n,i.query(function(e){r.practitioners=e});function o(e,t,i,n){return!!e&&0<a("filter")(e,function(e){return e.cert_type==t&&(e.year===i&&(!(0<n&&e.conditions!=n)&&(!e.is_deleted&&!e.is_cancelled)))},!0).length}r.hasEiaTL=function(e){var t=o(e.practitioner_certificates,50,r.certificateYearValid,38);return e.cert_eia=t?"eia":null,t},r.hasEiaTM=function(e){var t=o(e.practitioner_certificates,50,r.certificateYearValid,39);return e.cert_eia=t?"eia":null,t},r.hasAuditTL=function(e){var t=o(e.practitioner_certificates,51,r.certificateYearValid,38);return e.cert_au=t?"audit":null,t},r.hasAuditTM=function(e){var t=o(e.practitioner_certificates,51,r.certificateYearValid,39);return e.cert_au=t?"audit":null,t},r.hasPartnershipEia=function(e){var t=o(e.practitioner_certificates,52,r.certificateYearValid,53);return e.cert_ep=t?"partnership":null,t},r.hasPartnershipEa=function(e){var t=o(e.practitioner_certificates,52,r.certificateYearValid,97);return e.cert_ep=t?"partnership":null,t},r.newPractitioner=function(){if(r.currentForm&&r.currentForm.$invalid)alert("Current form not valid. Can't create new practitioner.");else{var e=new i({practitioner_certificates:[],is_new:!0});r.practitioners.unshift(e),r.toggleRow(e)}},r.deletePractitioner=function(e,t){r.current=null,t.is_new||t.$delete(),r.practitioners.splice(e,1)},r.deleteCertificate=function(e,t,i){i.is_new?t.practitioner_certificates.splice(e,1):(i.is_deleted=!0,r.currentForm.$setDirty(),r.toggleRow(t,!0))},r.newCertificate=function(e){var t={year:r.certificateYearValid,date_of_entry:new Date,is_new:!0};t.cert_no=r.certificateNumber(t),e.practitioner_certificates.unshift(t)},r.calculateCertificateNumber=function(e){e.cert_no=r.certificateNumber(e)},r.canSave=function(){return r.userinfo.info.role_6};r.toggleRow=function(t,e){if(!r.loading){if(r.canSave()&&r.current){var i=r.current,n=r.currentForm;if(n.$invalid)return void alert("Form not valid. Can't save.");n.$dirty&&(function(e){r.canSave()&&(e.is_new?e.$save({},function(e){s()}):e.$update({},function(e){console.log("save pract called",e),s()}))}(i),n.$setPristine())}r.current!=t||e?t.is_new?r.current=t:(r.loading=t).$get({},function(e){r.loading=null,r.current=t}):r.current=null}},r.setCurrentForm=function(e){r.currentForm=e},r.certificateNumber=function(e){var t="E",i=_.find(r.valuelists.practitionertype,{id:+e.cert_type});return i&&(t=i.description1),"CC/"+t+"/"+(e.number?("00"+e.number).slice(-3):"000")+"/"+(e.year?e.year.toString().substr(2):"00")},r.changeNumericBoolean=function(e){return 0===e?1:0};var s=function(){};r.practitionerOrderBy=function(e){return e.person.trim().substring(e.person.trim().lastIndexOf(" "))}}]);var controllers,testy1="x",paginationCount=20,projectPagerOffset=0;controllers.controller("ProjectsController",["$scope","$location","$filter","Project","UserInfo",function(i,t,e,n,r){i.projectSearchTxt="Search",i.loadMoreProjectsTxt="Load more",i.projects=n.query({count:20}),i.projectsCount=0,n.query({countOnly:1},function(e){i.projectsCount=e[0]}),i.userinfo=r,i.goto=function(e){t.path(e)},i.canSave=function(){return i.userinfo.info.role_1},i.loadMoreProjects=function(){i.loadMoreProjectsTxt="Loading..",projectPagerOffset+=20,n.query({count:20,offset:projectPagerOffset,searchWord:i.searchWord},function(e){if(0!=e.length){var t=i.projects.concat(e);i.projects=t,i.loadMoreProjectsTxt="Load more"}else i.hideProjectLoader=!0})},i.searchProjects=function(){i.projectSearchTxt="Searching...",n.query({count:20,searchWord:i.searchWord},function(e){i.hideProjectLoader=!1,i.projects=e,i.projectSearchTxt="Search"})}}]),controllers.controller("ProjectTabsController",["$scope","$routeParams","$location","$q","$timeout","ProjectFactory","UserInfo","Valuelists",function(a,e,t,o,i,s,n,r){a.SavingStateEnum=SavingStateEnum,a.ProjectTabEnum=ProjectTabEnum,a.routeParams=e,a.userinfo=n,a.valuelists=r,a.data=s,a.loadMoreBtnTxt="Load more",a.searchBtnTxt="search",a.organisations=[];var c;a.tab=(c=t.path(),_.contains(c,"eiaspermits")?ProjectTabEnum.EiasPermits:_.contains(c,"auditsinspections")?ProjectTabEnum.AuditsInspections:_.contains(c,"externalaudits")?ProjectTabEnum.ExternalAudits:_.contains(c,"permitslicenses")?ProjectTabEnum.PermitsLicenses:ProjectTabEnum.Project),a.goto=function(e){i(function(){t.path(e)})},a.auth={},a.auth.canSave=function(){return!1},a.saveCurrent=function(t,e,i){if(i=void 0!==i&&i,t.saveInProgress&&t.isNew)return(n=o.defer()).reject(),n.promise;t.saveInProgress=!0;var n=o.defer();if(t.form.$pristine&&!i)t.saveInProgress=!1,n.reject();else if(!t.form.$invalid&&!this.coordinateError||t.isNew&&i){t.state=t.isNew?SavingStateEnum.LoadingNew:SavingStateEnum.SavingStarted;var r=a.routeParams;i&&(r=_.omit(r,"auditinspectionId"),r=_.omit(r,"eiapermitId"),r=_.omit(r,"externalauditId")),s.save(r,e).then(function(e){_.isUndefined(t.form)||(t.state=t.isNew?SavingStateEnum.LoadingNew:SavingStateEnum.SavingFinished,t.form.$setPristine(),t.saveInProgress=!1,n.resolve(e))},function(e){console&&console.log("Error on server:",e),t.state=SavingStateEnum.SavingFailed,t.saveInProgress=!1})}else t.state=SavingStateEnum.Invalid,t.saveInProgress=!1,n.reject();return n.promise}}]),controllers.controller("ProjectController",["$scope","$q","ProjectFactory","Organisation","$timeout",function(a,e,t,r,i){if(a.selectOrganisationMode=!1,a.isNewProject=!1,a.coordinateError=!1,a.coordinateNetworkIssues=!1,a.checkingCoordinates=!1,a.currentLong="",a.currentLat="",a.parts={project:{form:null,state:SavingStateEnum.Loading},organisation:{form:null,state:SavingStateEnum.Loading}},a.newProjectExisitingOrganisation=function(e){a.selectOrganisationMode=!1,t.setOrganisation(e).then(function(e){a.parts.organisation.state=SavingStateEnum.Loaded}),0<t.project.id?(t.project.organisation_id=e.id,i(function(){a.saveCurrentProject(!0)})):t.createNewProject(e),a.parts.project.state=SavingStateEnum.Loaded},a.newProjectNewOganisation=function(){a.selectOrganisationMode=!1,t.createNewOrganisation(),0<t.project.id||t.createNewProject(a.data.organisation),a.parts.project.state=SavingStateEnum.Loaded,a.parts.organisation.state=SavingStateEnum.Loaded,a.parts.organisation.isNew=!0},a.loadMoreDevelopers=function(e){a.loadMoreBtnTxt="Loading...",paginationCount+=20;var t=a.data.searchWord,i=r.query({offset:paginationCount,searchWord:t}),n=a.organisations;i.$promise.then(function(e){var t=e[0].organisations,i=n.concat(t);a.organisations=i.sort(a.projectSortScript),a.currentCount=e[0].properties.currentCount,a.loadMoreBtnTxt="Load more"})},a.search=function(){a.searchBtnTxt="searching...";var e=a.data.searchWord;paginationCount=0,r.query({searchWord:e}).$promise.then(function(e){var t=e[0].organisations.sort(a.projectSortScript);a.organisations=t,a.totalCount=e[0].properties.totalCount,a.currentCount=e[0].properties.currentCount,a.searchBtnTxt="search"})},a.saveCurrentProject=function(e){if(e=void 0!==e&&e,a.isNewProject)a.saveNewProjectAndNewOrganisation();else{var t=a.data.project;a.saveCurrent(a.parts.project,t,e).then(function(e){})}},a.saveCurrentOrganisation=function(){if(a.isNewProject)a.saveNewProjectAndNewOrganisation();else{var t=a.data.project,e=a.data.organisation;a.saveCurrent(a.parts.organisation,e).then(function(e){e.id!==t.organisation_id&&(t.organisation_id=e.id,a.saveCurrentProject(!0))})}},a.saveNewProjectAndNewOrganisation=function(){var t=a.parts.project,e=a.parts.organisation;if(t.form.$invalid||this.coordinateError)return a.parts.project.state=SavingStateEnum.Invalid,void(e.form.$dirty&&(a.parts.organisation.state=SavingStateEnum.MissingDependency));if(t.form.$valid&&e.form.$invalid)return a.parts.project.state=SavingStateEnum.MissingDependency,void(a.parts.organisation.state=SavingStateEnum.Invalid);if(t.form.$valid&&e.form.$valid){var i=a.data.project,n=a.data.organisation;e.form.$pristine?(i.organisation_id=n.id,a.saveCurrent(t,i).then(function(e){a.goto("/projects/"+e.id)})):a.saveCurrent(e,n).then(function(e){i.organisation_id=e.id,a.saveCurrent(t,i).then(function(e){a.goto("/projects/"+e.id)})})}},a.auth.canSave=function(e){switch(e){case"has_industrial_waste_water":return a.userinfo.info.role_3;default:return a.userinfo.info.role_1}},a.auth.canDelete=function(){return!a.isNewProject&&(a.parts.project.state!=SavingStateEnum.Loading&&(!(0<a.data.eiaspermits.length||0<a.data.auditsinspections.length)&&a.auth.canSave()))},a.deleteProject=function(){t.deleteProject(a.routeParams).then(function(){a.goto("/projects")})},a.changeDeveloper=function(){a.selectOrganisationMode=!0,r.query().$promise.then(function(e){a.organisations=e[0].organisations.sort(a.projectSortScript),a.totalCount=e[0].totalCount,a.currentCount=e[0].currentCount})},a.verifyCoordinates=function(e,t){if(!t||a.parts.project.state!=SavingStateEnum.Loading){var i=a.data.project.latitude?a.data.project.latitude.trim():a.data.project.latitude,n=a.data.project.longitude?a.data.project.longitude.trim():a.data.project.longitude;a.data.project.latitude=i,a.data.project.longitude=n,!a.isNewProject||i||n?a.parts.project.state!=SavingStateEnum.Loading&&(a.currentLong==n&&a.currentLat==i||(i||n?(a.currentLat=i,a.currentLong=n,r(!0),isCoordinateWithinUganda(i,n,function(e,t){a.$apply(function(){e?(a.coordinateError=!1,a.saveCurrentProject()):(document.getElementById("latitude").classList.remove("ng-valid"),document.getElementById("longitude").classList.remove("ng-valid"),a.coordinateError=!0,"network"==t.error?a.coordinateNetworkIssues=!0:a.coordinateNetworkIssues=!1),r(!1)})})):a.coordinateError=!1)):a.coordinateError=!1}function r(e){e&&(a.coordinateError=e),a.checkingCoordinates=e}},a.splitCoordinates=function(t){setTimeout(function(){var e=document.getElementById(t).value.split(",");e.length<2||(a.data.project.latitude=e[0],a.data.project.longitude=e[1])},0)},"new"==a.routeParams.projectId){a.selectOrganisationMode=!0,a.isNewProject=!0,a.parts.project.isNew=!0,t.empty(),r.query().$promise.then(function(e){a.organisations=e[0].organisations.sort(a.projectSortScript),a.totalCount=e[0].properties.totalCount,a.currentCount=e[0].properties.currentCount})}else{var n=t.retrieveProjectData(a.routeParams);n[0].then(function(){a.parts.project.state=SavingStateEnum.Loaded}),n[1].then(function(){a.parts.organisation.state=SavingStateEnum.Loaded})}a.projectSortScript=function(e,t){return e.projectCount<t.projectCount?1:e.projectCount>t.projectCount?-1:0}}]),controllers.controller("EiasPermitsTabsController",["$scope","$location","ProjectFactory",function(i,e,t){i.fileUploadPattern=fileUploadPattern,i.fileUploadNgfPattern=fileUploadNgfPattern,i.fileUploadMaxSize=fileUploadMaxSize,i.EiasPermitsTabEnum=EiasPermitsTabEnum,i.parts={eiapermits:{state:SavingStateEnum.None},eiapermit:{form:null,state:SavingStateEnum.None},documents:{state:SavingStateEnum.None},document:{form:null,state:SavingStateEnum.None},hearings:{state:SavingStateEnum.None},hearing:{form:null,state:SavingStateEnum.None}};var n;i.eptab=(n=e.path(),_.contains(n,"hearings")?EiasPermitsTabEnum.Hearings:_.contains(n,"documents")?EiasPermitsTabEnum.Documents:EiasPermitsTabEnum.EiaPermit),i.preventClickIfDisabled=function(e,t){e&&t.preventDefault()},i.stopPropagation=function(e){e.stopPropagation()},i.openEiapermit=function(e,t){i.routeParams.eiapermitId==e?i.goto("/projects/"+i.data.project.id+"/eiaspermits"):i.routeParams.eiapermitId||i.goto("/projects/"+i.data.project.id+"/eiaspermits/"+e)},i.openEiapermitDocument=function(e,t){i.routeParams.documentId==e?i.goto("/projects/"+i.data.project.id+"/eiaspermits/"+i.data.eiapermit.id+"/documents"):i.routeParams.documentId||i.goto("/projects/"+i.data.project.id+"/eiaspermits/"+i.data.eiapermit.id+"/documents/"+e)},i.openEiapermitDocumentHearing=function(e,t){i.routeParams.hearingId==e?i.goto("/projects/"+i.data.project.id+"/eiaspermits/"+i.data.eiapermit.id+"/documents/"+i.data.document.id+"/hearings"):i.routeParams.hearingId||i.goto("/projects/"+i.data.project.id+"/eiaspermits/"+i.data.eiapermit.id+"/documents/"+i.data.document.id+"/hearings/"+e)},i.isDocumentsDisabled=function(e){return!!i.isDisabled(e)||i.parts.documents.state==SavingStateEnum.Loading},i.isHearingsDisabled=function(e){return!!i.isDisabled(e)||i.parts.hearings.state==SavingStateEnum.Loading},i.isDisabled=function(e){return _.isUndefined(e)},i.downloadFileUrl=function(e){return"/file/v1/download/"+e},i.updateStatus=function(e){var t=updateEiaPermitStatus(e,i.data.documents);return t&&i.parts.eiapermit.form&&i.parts.eiapermit.form.$setDirty(),t},i.loadEiaPermitWithDocuments=function(){i.parts.eiapermit.state=SavingStateEnum.Loading,i.parts.documents.state=SavingStateEnum.Loading;var e=t.retrieveEiaPermit(i.routeParams);e[0].then(function(e){i.parts.eiapermit.state=SavingStateEnum.Loaded}),e[1].then(function(e){i.parts.documents.state=SavingStateEnum.Loaded})},i.parts.eiapermits.state=SavingStateEnum.Loading,t.retrieveProjectData(i.routeParams)[2].then(function(e){i.parts.eiapermits.state=SavingStateEnum.Loaded,_.isUndefined(i.routeParams.eiapermitId)||i.loadEiaPermitWithDocuments()})}]),controllers.controller("EiasPermitsController",["$scope","ProjectFactory","$timeout","Upload","$q","$location",function(i,e,t,n,r,a){i.showUploadingCertificate=!1,i.shouldShowEiaPermit=function(e){return i.parts.eiapermit.state!=SavingStateEnum.Loading&&i.routeParams.eiapermitId==e.id},i.saveCurrentEiaPermit=function(e){var t=e.is_new;t||i.updateStatus(e),i.saveCurrent(i.parts.eiapermit,e,t).then(function(e){t&&i.goto("/projects/"+i.data.project.id+"/eiaspermits/"+e.id)})},i.newEiaPermit=function(){i.parts.eiapermit.state=SavingStateEnum.LoadingNew,e.createNewEiaPermit(i.data.project)},i.deleteEiaPermit=function(){e.deleteEiaPermit(i.routeParams),i.goto("/projects/"+i.data.project.id+"/eiaspermits")},i.uploadCertificate=function(e){e&&(i.showUploadingCertificate=!0,i.certificateFile=e[0],uploadFile(r,t,n,i.parts.eiapermit.form.certificate,i.certificateFile).then(function(e){i.data.eiapermit.file_metadata_id=e.result.id,i.parts.eiapermit.form.certificate.$setDirty(),i.saveCurrentEiaPermit(i.data.eiapermit)},function(e){}))},i.deleteCertificate=function(){i.showUploadingCertificate=!1,i.data.eiapermit.file_metadata_id=null,i.parts.eiapermit.form.certificate.$setDirty(),i.saveCurrentEiaPermit(i.data.eiapermit)},i.criteriaMatchOfficer1=function(e){return function(e){return!0}},i.criteriaMatchOfficer=function(e){return function(e){return!0}},i.auth.canSave=function(e){if(i.data.eiapermit.is_new&&i.parts.eiapermit.state==SavingStateEnum.SavingStarted)return!1;switch(e){case"new":case"delete":return i.userinfo.info.role_1;case"teamleader_id":case"practitioner_id":case"cost":case"cost_currency":case"expected_jobs_created":return i.userinfo.info.role_1;case"personnel":return i.userinfo.info.role_2;case"inspection_recommended":case"date_inspection":case"officer_recommend":case"fee":case"fee_currency":case"remarks":return i.userinfo.info.role_3;case"date_fee_notification":case"date_fee_payed":case"fee_receipt_no":return i.userinfo.info.role_4;case"decision":case"date_decision":case"designation":case"date_certificate":case"certificate_no":case"date_cancelled":case"user_id":case"date_sent_ded_approval":return i.userinfo.info.role_5;case"status":default:return!1}}}]),controllers.controller("EiasPermitsDocumentsController",["$scope","ProjectFactory","$timeout","Upload","$q","$location","EiaPermitSearch",function(r,a,t,i,n,e,o){r.shouldShowDocument=function(e){return r.parts.document.state!=SavingStateEnum.Loading&&r.routeParams.documentId==e.id},r.moveButton={},r.moveDocument=function(){r.moveButton.error="",o.query({eiapermit_id:r.moveButton.id},function(e){if(1<=e.length){var t=e[0].project_id,i=e[0].eiapermit_id,n=r.data.document.id;a.moveDocument(r.routeParams,r.moveButton.id).then(function(){r.updateStatusBasedOnDocument(),r.goto("/projects/"+t+"/eiaspermits/"+i+"/documents/"+n)})}else r.moveButton.error="Not a valid EIA ID."})},r.updateStatusBasedOnDocument=function(){r.updateStatus(r.data.eiapermit)&&r.data.eiapermit.$update(r.routeParams,function(e){},function(){})},r.saveCurrentDocument=function(e){var t=e.is_new;r.saveCurrent(r.parts.document,e).then(function(e){r.updateStatusBasedOnDocument(),t&&r.goto("/projects/"+r.data.project.id+"/eiaspermits/"+r.data.eiapermit.id+"/documents/"+e.id)})},r.newDocument=function(){r.parts.document.state=SavingStateEnum.LoadingNew,a.createNewDocument(r.data.eiapermit)},r.deleteDocument=function(){a.deleteDocument(r.routeParams).then(function(){r.updateStatusBasedOnDocument(),r.goto("/projects/"+r.data.project.id+"/eiaspermits/"+r.data.eiapermit.id+"/documents")})},r.uploadAttachment=function(e){e&&(r.showUploadingAttachment=!0,r.attachmentFile=e[0],uploadFile(n,t,i,r.parts.document.form.attachment,r.attachmentFile).then(function(e){r.data.document.file_metadata_id=e.result.id,r.parts.document.form.attachment.$setDirty(),r.saveCurrentDocument(r.data.document)},function(e){}))},r.uploadResponseDocument=function(e){e&&(r.showUploadingResponseDocument=!0,r.responseDocumentFile=e[0],uploadFile(n,t,i,r.parts.document.form.response_document,r.responseDocumentFile).then(function(e){r.data.document.file_metadata_response_id=e.result.id,r.parts.document.form.response_document.$setDirty(),r.saveCurrentDocument(r.data.document)},function(e){}))},r.deleteAttachment=function(){r.showUploadingAttachment=!1,r.data.document.file_metadata_id=null,r.parts.document.form.attachment.$setDirty(),r.saveCurrentDocument(r.data.document)},r.deleteResponseDocument=function(){r.showUploadingResponseDocument=!1,r.data.document.file_metadata_response_id=null,r.parts.document.form.response_document.$setDirty(),r.saveCurrentDocument(r.data.document)},r.calculateNumberOfCopiesOfDocument=function(){r.data.document.director_copy_no=1,r.data.document.coordinator_copy_no=r.data.document.sub_copy_no-1},r.calculateDocumentCode=function(){var e=_.find(r.valuelists.documenttype,{id:parseInt(r.data.document.type)}),t=e?e.description1:"",i=r.data.document.number?r.data.document.number:"";r.data.document.code=t+i},r.setDefaultDocumentConclusion=function(){0<=_.indexOf(["8","9"],r.data.document.type)?r.data.document.conclusion=80:r.data.document.conclusion=81},r.isDisabledBasedOnRule=function(e){switch(e){case"document.conclusion":return 81==r.data.document.conclusion;case"document.type":return 10==r.data.document.type;default:return!1}},r.auth.canSave=function(e){if(r.data.document.is_new&&r.parts.document.state==SavingStateEnum.SavingStarted)return!1;switch(e){case"new":case"delete":return r.userinfo.info.role_1;case"document.date_submitted":case"document.sub_copy_no":case"document.title":case"document.type":case"document.number":case"document.code":case"document.consultent":case"document.director_copy_no":case"document.date_sent_director":case"document.coordinator_copy_no":case"document.date_copies_coordinator":case"document.date_next_appointment":case"document.folio_no":return r.userinfo.info.role_1;case"document.date_sent_officer":return r.userinfo.info.role_2;case"document.file_metadata_response_id":case"document.conclusion":case"document.date_conclusion":case"document.remarks":case"document.remarks_director":case"document.remarks_team_leader":return r.userinfo.info.role_3;case"document.date_sent_from_dep":return r.userinfo.info.role_5;case"move":return r.userinfo.info.role_8;default:return!1}},r.loadDocumentWithHearings=function(){r.parts.document.state=SavingStateEnum.Loading,r.parts.hearings.state=SavingStateEnum.Loading;var e=a.retrieveDocument(r.routeParams);e[0].then(function(e){r.parts.document.state=SavingStateEnum.Loaded}),e[1].then(function(e){r.parts.hearings.state=SavingStateEnum.Loaded})},r.parts.document,SavingStateEnum.Loading,a.retrieveProjectData(r.routeParams)[2].then(function(e){a.retrieveEiaPermit(r.routeParams)[1].then(function(e){r.parts.documents.state=SavingStateEnum.Loaded,_.isUndefined(r.routeParams.documentId)||r.loadDocumentWithHearings()})})}]),controllers.controller("EiasPermitsHearingsController",["$scope","ProjectFactory","$timeout","Upload","$q","$location",function(i,t,n,r,a,e){i.shouldShowHearing=function(e){return i.parts.hearing.state!=SavingStateEnum.Loading&&i.routeParams.hearingId==e.id},i.saveCurrentHearing=function(e){var t=e.is_new;i.saveCurrent(i.parts.hearing,e).then(function(e){t&&i.goto("/projects/"+i.data.project.id+"/eiaspermits/"+i.data.eiapermit.id+"/documents/"+i.data.document.id+"/hearings/"+e.id)})},i.newHearing=function(){i.parts.hearing.state=SavingStateEnum.LoadingNew,t.createNewHearing(i.data.document)},i.deleteHearing=function(){t.deleteHearing(i.routeParams).then(function(){i.goto("/projects/"+i.data.project.id+"/eiaspermits/"+i.data.eiapermit.id+"/documents/"+i.data.document.id)})},i.uploadAttachment=function(e){e&&(i.showUploadingAttachment=!0,i.attachmentFile=e[0],uploadFile(a,n,r,i.parts.hearing.form.attachment,i.attachmentFile).then(function(e){i.data.hearing.file_metadata_id=e.result.id,i.parts.hearing.form.attachment.$setDirty(),i.saveCurrentHearing(i.data.hearing)},function(e){}))},i.deleteAttachment=function(){i.showUploadingAttachment=!1,i.data.hearing.file_metadata_id=null,i.parts.hearing.form.attachment.$setDirty(),i.saveCurrentHearing(i.data.hearing)},i.isDisabledBasedOnRule=function(e){switch(e){case"hearing.district_id":return 7!=i.data.hearing.lead_agency&&8!=i.data.hearing.lead_agency&&!(i.data.hearing.district_id=null);default:return!1}},i.auth.canSave=function(e){if(i.data.hearing.is_new&&i.parts.hearing.state==SavingStateEnum.SavingStarted)return!1;switch(e){case"new":case"delete":case"hearing.date_dispatched":case"hearing.lead_agency":case"hearing.district_id":case"hearing.date_expected":case"hearing.date_received":case"hearing.recommendations":case"hearing.document_id":return i.userinfo.info.role_1;case"hearing.remarks":return i.userinfo.info.role_3;default:return!1}},i.loadHearing=function(){i.parts.hearing.state=SavingStateEnum.Loading,t.retrieveHearing(i.routeParams)[0].then(function(e){i.parts.hearing.state=SavingStateEnum.Loaded})},i.loadDocumentWithHearings=function(){i.parts.document.state=SavingStateEnum.Loading,i.parts.hearings.state=SavingStateEnum.Loading;var e=t.retrieveDocument(i.routeParams);e[0].then(function(e){i.parts.document.state=SavingStateEnum.Loaded}),e[1].then(function(e){i.parts.hearings.state=SavingStateEnum.Loaded,_.isUndefined(i.routeParams.hearingId)||i.loadHearing()})},t.retrieveProjectData(i.routeParams)[2].then(function(e){t.retrieveEiaPermit(i.routeParams)[1].then(function(e){i.parts.documents.state=SavingStateEnum.Loaded,_.isUndefined(i.routeParams.documentId)||i.loadDocumentWithHearings()})})}]),controllers.controller("ExternalAuditsTabsController",["$scope","$location","ProjectFactory",function(i,e,t){i.fileUploadPattern=fileUploadPattern,i.fileUploadNgfPattern=fileUploadNgfPattern,i.fileUploadMaxSize=fileUploadMaxSize,i.ExternalAuditsTabEnum=ExternalAuditsTabEnum,i.parts={externalaudits:{state:SavingStateEnum.None},externalaudit:{form:null,state:SavingStateEnum.None},documents:{state:SavingStateEnum.None},document:{form:null,state:SavingStateEnum.None},hearings:{state:SavingStateEnum.None},hearing:{form:null,state:SavingStateEnum.None}};var n;i.eatab=(n=e.path(),_.contains(n,"hearings")?EiasPermitsTabEnum.Hearings:_.contains(n,"documents")?ExternalAuditsTabEnum.Documents:ExternalAuditsTabEnum.ExternalAudit),i.openExternalaudit=function(e,t){i.routeParams.externalauditId==e?i.goto("/projects/"+i.data.project.id+"/externalaudits"):i.routeParams.externalauditId||i.goto("/projects/"+i.data.project.id+"/externalaudits/"+e)},i.openExternalauditDocument=function(e,t){i.routeParams.documentId==e?i.goto("/projects/"+i.data.project.id+"/externalaudits/"+i.data.externalaudit.id+"/documents"):i.routeParams.documentId||i.goto("/projects/"+i.data.project.id+"/externalaudits/"+i.data.externalaudit.id+"/documents/"+e)},i.preventClickIfDisabled=function(e,t){e&&t.preventDefault()},i.stopPropagation=function(e){e.stopPropagation()},i.isDocumentsDisabled=function(e){return!!i.isDisabled(e)||i.parts.documents.state==SavingStateEnum.Loading},i.isHearingsDisabled=function(e){return!!i.isDisabled(e)||i.parts.hearings.state==SavingStateEnum.Loading},i.isDisabled=function(e){return _.isUndefined(e)},i.downloadFileUrl=function(e){return"/file/v1/download/"+e},i.updateStatus=function(e){},i.loadExternalAuditWithDocuments=function(){i.parts.externalaudit.state=SavingStateEnum.Loading,i.parts.documents.state=SavingStateEnum.Loading;var e=t.retrieveExternalAudit(i.routeParams);e[0].then(function(e){i.parts.externalaudit.state=SavingStateEnum.Loaded}),e[1].then(function(e){i.parts.documents.state=SavingStateEnum.Loaded})},i.parts.externalaudits.state=SavingStateEnum.Loading,t.retrieveProjectData(i.routeParams)[5].then(function(e){i.parts.externalaudits.state=SavingStateEnum.Loaded,_.isUndefined(i.routeParams.externalauditId)||i.loadExternalAuditWithDocuments()})}]),controllers.controller("ExternalAuditsController",["$scope","ProjectFactory","$timeout","Upload","$q","$location",function(i,e,t,n,r,a){i.showUploadingResponseDocument=!1,i.shouldShowExternalAudit=function(e){return i.parts.externalaudit.state!=SavingStateEnum.Loading&&i.routeParams.externalauditId==e.id},i.saveCurrentExternalAudit=function(e){var t=e.is_new;t||i.updateStatus(e),i.saveCurrent(i.parts.externalaudit,e,t).then(function(e){t&&i.goto("/projects/"+i.data.project.id+"/externalaudits/"+e.id)})},i.newExternalAudit=function(){i.parts.externalaudit.state=SavingStateEnum.LoadingNew,e.createNewExternalAudit(i.data.project)},i.deleteExternalAudit=function(){e.deleteExternalAudit(i.routeParams),i.goto("/projects/"+i.data.project.id+"/externalaudits")},i.uploadResponseDocument=function(e){e&&(i.showUploadingResponseDocument=!0,i.responseDocumentFile=e[0],uploadFile(r,t,n,i.parts.externalaudit.form.response_document,i.responseDocumentFile).then(function(e){i.data.externalaudit.file_metadata_response_id=e.result.id,i.parts.externalaudit.form.response_document.$setDirty(),i.saveCurrentExternalAudit(i.data.externalaudit)},function(e){}))},i.deleteResponseDocument=function(){i.showUploadingResponseDocument=!1,i.data.externalaudit.file_metadata_response_id=null,i.parts.externalaudit.form.response_document.$setDirty(),i.saveCurrentExternalAudit(i.data.externalaudit)},i.criteriaMatchOfficer1=function(e){return function(e){return!0}},i.criteriaMatchOfficer=function(e){return function(e){return!0}},i.auth.canSave=function(e){if(i.data.externalaudit.is_new&&i.parts.externalaudit.state==SavingStateEnum.SavingStarted)return!1;switch(e){case"new":return i.userinfo.info.role_1;case"teamleader_id":case"practitioner_id":case"type":return i.userinfo.info.role_1;case"personnel":return i.userinfo.info.role_2;case"verification_inspection":case"date_inspection":case"date_response":case"fee":case"fee_currency":case"remarks":case"review_findings":case"response":case"date_deadline_compliance":case"delete":case"upload_documentation_response_letter":case"delete_documentation_response_letter":return i.userinfo.info.role_3;case"user_id":return i.userinfo.info.role_5;case"status":default:return!1}},i.filterByDateSubmission=function(e){if(e.length||e[0].documents)return e.sort(function(e,t){return console.log(),(e.documents&&e.documents[0]?e.documents[0].date_submitted:"")<(t.documents&&t.documents[0]?t.documents[0].date_submitted:"")?-1:1}),e.reverse()}}]),controllers.controller("ExternalAuditsDocumentsController",["$scope","ProjectFactory","$timeout","Upload","$q","$location","ExternalAuditSearch",function(r,a,t,i,n,e,o){r.shouldShowDocument=function(e){return r.parts.document.state!=SavingStateEnum.Loading&&r.routeParams.documentId==e.id},r.moveButton={},r.moveDocument=function(){r.moveButton.error="",o.query({externalaudit_id:r.moveButton.id},function(e){if(1<=e.length){var t=e[0].project_id,i=e[0].externalaudit_id,n=r.data.document_ea.id;console.log(t,i,n),a.moveDocumentEA(r.routeParams,r.moveButton.id).then(function(){r.updateStatusBasedOnDocument(),r.goto("/projects/"+t+"/externalaudits/"+i+"/documents/"+n)})}else r.moveButton.error="Not a valid EA ID."})},r.updateStatusBasedOnDocument=function(){r.updateStatus(r.data.externalaudit)&&r.data.externalaudit.$update(r.routeParams,function(e){},function(){})},r.saveCurrentDocument=function(e){var t=e.is_new;r.saveCurrent(r.parts.document,e).then(function(e){r.updateStatusBasedOnDocument(),t&&r.goto("/projects/"+r.data.project.id+"/externalaudits/"+r.data.externalaudit.id+"/documents/"+e.id)})},r.newDocument=function(){r.parts.document.state=SavingStateEnum.LoadingNew,a.createNewDocumentEA(r.data.externalaudit)},r.deleteDocument=function(){a.deleteDocumentEA(r.routeParams).then(function(){r.updateStatusBasedOnDocument(),r.goto("/projects/"+r.data.project.id+"/externalaudits/"+r.data.externalaudit.id+"/documents")})},r.uploadAttachment=function(e){e&&(r.showUploadingAttachment=!0,r.attachmentFile=e[0],uploadFile(n,t,i,r.parts.document.form.attachment,r.attachmentFile).then(function(e){r.data.document_ea.file_metadata_id=e.result.id,r.parts.document.form.attachment.$setDirty(),r.saveCurrentDocument(r.data.document_ea)},function(e){}))},r.uploadResponseDocument=function(e){e&&(r.showUploadingResponseDocument=!0,r.responseDocumentFile=e[0],uploadFile(n,t,i,r.parts.document.form.response_document,r.responseDocumentFile).then(function(e){r.data.document_ea.file_metadata_response_id=e.result.id,r.parts.document.form.response_document.$setDirty(),r.saveCurrentDocument(r.data.document_ea)},function(e){}))},r.deleteAttachment=function(){r.showUploadingAttachment=!1,r.data.document_ea.file_metadata_id=null,r.parts.document.form.attachment.$setDirty(),r.saveCurrentDocument(r.data.document_ea)},r.deleteResponseDocument=function(){r.showUploadingResponseDocument=!1,r.data.document_ea.file_metadata_response_id=null,r.parts.document.form.response_document.$setDirty(),r.saveCurrentDocument(r.data.document_ea)},r.calculateNumberOfCopiesOfDocument=function(){r.data.document_ea.director_copy_no=1,r.data.document_ea.coordinator_copy_no=r.data.document_ea.sub_copy_no-1},r.calculateDocumentCode=function(){var e=_.find(r.valuelists.documenttypeexternalaudits,{id:parseInt(r.data.document_ea.type)}),t=e?e.description1:"",i=r.data.document_ea.number?r.data.document_ea.number:"";r.data.document_ea.code=t+i},r.setDefaultDocumentConclusion=function(){0<=_.indexOf(["11"],r.data.document_ea.type)?r.data.document_ea.conclusion=80:r.data.document_ea.conclusion=81},r.isDisabledBasedOnRule=function(e){switch(e){case"document.conclusion":return 81==r.data.document_ea.conclusion;case"document.type":return 12==r.data.document_ea.type;default:return!1}},r.auth.canSave=function(e){if(r.data.document_ea.is_new&&r.parts.document.state==SavingStateEnum.SavingStarted)return!1;switch(e){case"new":case"delete":return r.userinfo.info.role_1;case"document.date_submitted":case"document.sub_copy_no":case"document.title":case"document.type":case"document.number":case"document.code":case"document.consultent":case"document.director_copy_no":case"document.date_sent_director":case"document.coordinator_copy_no":case"document.date_copies_coordinator":case"document.date_next_appointment":case"document.folio_no":case"document.remarks":return r.userinfo.info.role_1;case"document.date_sent_officer":return r.userinfo.info.role_2;case"document.file_metadata_response_id":case"document.conclusion":case"document.date_conclusion":return r.userinfo.info.role_3;case"document.date_sent_from_dep":return r.userinfo.info.role_5;case"move":return r.userinfo.info.role_8;default:return!1}},r.loadDocument=function(){r.parts.document.state=SavingStateEnum.Loading,a.retrieveDocumentEA(r.routeParams)[0].then(function(e){r.parts.document.state=SavingStateEnum.Loaded})},r.parts.document,SavingStateEnum.Loading,a.retrieveProjectData(r.routeParams)[5].then(function(e){a.retrieveExternalAudit(r.routeParams)[1].then(function(e){r.parts.documents.state=SavingStateEnum.Loaded,_.isUndefined(r.routeParams.documentId)||r.loadDocument()})})}]),(controllers=angular.module("seroApp.controllers")).controller("AuditsInspectionsController",["$scope","ProjectFactory","$timeout","Upload","$q",function(i,e,t,n,r){i.parts={auditsinspections:{state:SavingStateEnum.None},auditinspection:{form:null,state:SavingStateEnum.None}},i.newButton={},i.newButton.year=(new Date).getFullYear(),i.fileUploadPattern=fileUploadPattern,i.fileUploadNgfPattern=fileUploadNgfPattern,i.fileUploadMaxSize=fileUploadMaxSize,i.shouldShowAuditInspection=function(e){return i.parts.auditinspection.state!=SavingStateEnum.Loading&&i.routeParams.auditinspectionId==e.id},i.criteriaMatchOfficer1=function(e){return function(e){return!0}},i.criteriaMatchOfficer=function(e){return function(e){return!0}},i.isLoading=function(){return i.parts.auditinspection.state==SavingStateEnum.Loading?!!i.hasAuditInspection():i.parts.auditinspection.state==SavingStateEnum.LoadingNew},i.hasAuditInspection=function(){return!_.isEmpty(i.data.auditinspection)},i.updateStatus=function(e){e.date_closing?e.status=75:e.date_received?e.status=74:e.date_deadline&&e.date_deadline<new Date?e.status=73:e.action_taken?e.status=72:e.date_carried_out&&(e.status=71)},i.openAuditInspection=function(e,t){i.routeParams.auditinspectionId==e?i.goto("/projects/"+i.data.project.id+"/auditsinspections"):i.routeParams.auditinspectionId||i.goto("/projects/"+i.data.project.id+"/auditsinspections/"+e)},i.stopPropagation=function(e){e.stopPropagation()},i.saveCurrentAuditInspection=function(){i.data.auditinspection.year=new Date(i.data.auditinspection.date_carried_out).getFullYear();var e=i.data.auditinspection;console.log(e,"about to save");var t=e.is_new;t||i.updateStatus(e),i.saveCurrent(i.parts.auditinspection,e,t).then(function(e){t&&i.goto("/projects/"+i.data.project.id+"/auditsinspections/"+e.id)})},i.newAuditInspection=function(){i.parts.auditinspection.state=SavingStateEnum.LoadingNew,i.newButton.isopen=!1,i.newButton.year=new Date(i.newButton.date_carried_out).getFullYear(),e.createNewAuditInspection(i.data.project,i.newButton.year,i.newButton.type,i.newButton.reason,i.newButton.date_carried_out),i.parts.auditinspection.isNew=!0,i.saveCurrentAuditInspection()},i.deleteAuditInspection=function(){e.deleteAuditInspection(i.routeParams),i.goto("/projects/"+i.data.project.id+"/auditsinspections/")},i.auth.canSave=function(e){return"new"==e?i.userinfo.info.role_7:!!i.userinfo.info.role_8||"lead_officer"!=e&&i.userinfo.info.id===i.data.auditinspection.lead_officer},i.uploadActionTakenLetter=function(e){e&&(i.showUploadingFileActionTakenLetter=!0,i.actionTakenLetterFile=e[0],uploadFile(r,t,n,i.parts.auditinspection.form.action_taken_letter,i.actionTakenLetterFile).then(function(e){i.data.auditinspection.file_metadata_id=e.result.id,i.parts.auditinspection.form.action_taken_letter.$setDirty(),i.saveCurrentAuditInspection(),t(function(){i.showUploadingFileActionTakenLetter=!1},3e3)},function(e){}))},i.uploadReport=function(e){e&&(i.showUploadingFileReport=!0,i.reportFile=e[0],uploadFile(r,t,n,i.parts.auditinspection.form.report,i.reportFile).then(function(e){i.data.auditinspection.file_metadata_report_id=e.result.id,i.parts.auditinspection.form.report.$setDirty(),i.saveCurrentAuditInspection(),t(function(){i.showUploadingFileReport=!1},3e3)},function(e){}))},i.uploadDocumentation=function(e){e&&(i.showUploadingFileDocumentation=!0,i.documentationFile=e[0],uploadFile(r,t,n,i.parts.auditinspection.form.documentation,i.documentationFile).then(function(e){i.data.auditinspection.documentation_ids.push(e.result.id),i.parts.auditinspection.form.documentation.$setDirty(),i.saveCurrentAuditInspection(),t(function(){i.showUploadingFileDocumentation=!1},3e3)},function(e){}))},i.downloadFileUrl=function(e){return"/file/v1/download/"+e},i.deleteActionTakenLetter=function(){i.data.auditinspection.file_metadata_id=null,i.parts.auditinspection.form.action_taken_letter.$setDirty(),i.saveCurrentAuditInspection()},i.deleteReport=function(){i.data.auditinspection.file_metadata_report_id=null,i.parts.auditinspection.form.report.$setDirty(),i.saveCurrentAuditInspection()},i.deleteDocumentation=function(t){_.remove(i.data.auditinspection.documentation_ids,function(e){return e===t}),i.parts.auditinspection.form.documentation.$setDirty(),i.saveCurrentAuditInspection()},i.loadAuditInspection=function(){i.parts.auditinspection.state=SavingStateEnum.Loading,e.retrieveAuditInspection(i.routeParams)[0].then(function(e){i.parts.auditinspection.state=SavingStateEnum.Loaded})},i.parts.auditinspection.state=SavingStateEnum.Loading,e.retrieveProjectData(i.routeParams)[3].then(function(e){i.parts.auditsinspections.state=SavingStateEnum.Loaded,_.isUndefined(i.routeParams.auditinspectionId)||i.loadAuditInspection()})}]),controllers.controller("PermitsLicensesController",["$scope","ProjectFactory","$timeout","Upload","$q","$location",function(n,t,r,a,o,e){n.parts={permitslicenses:{state:SavingStateEnum.None},permitlicense:{form:null,state:SavingStateEnum.None}},n.newButton={},n.newButton.approved_by_the_lc1=!1,n.newButton.approved_by_the_dec=!1,n.fileUploadPattern=fileUploadPattern,n.fileUploadNgfPattern=fileUploadNgfPattern,n.fileUploadMaxSize=fileUploadMaxSize,n.DocumentTagEnum=DocumentTagEnum,n.documentationData={ApplicationForm:{formField:"documentation_applicationform",tag:DocumentTagEnum.PermitLicenseApplicationForm},PermitLicense:{formField:"documentation_permitlicense",tag:DocumentTagEnum.PermitLicensePermitLicense},Attachments:{formField:"documentation_attachments",tag:DocumentTagEnum.PermitLicenseAttachments}},n.idPermit=118,n.idLicense=119,n.idWetland=123,n.isEcosystemWetland=function(e){return e.ecosystem==n.idWetland},n.shouldShowPermitLicense=function(e){return n.parts.permitlicense.state!=SavingStateEnum.Loading&&n.routeParams.permitlicenseId==e.id},n.notOkToEditOrCreateNew=function(){return!!n.routeParams.permitlicenseId||!!n.data.permitlicense.is_new},n.preventClickIfDisabled=function(e,t){e&&t.preventDefault()},n.openPermitLicense=function(e,t){console.log(n.routeParams.permitlicenseId,e),n.data.permitlicense.is_new||(n.routeParams.permitlicenseId==e?n.goto("/projects/"+n.data.project.id+"/permitslicenses"):n.routeParams.permitlicenseId&&n.routeParamspermitlicenseId!=e?n.goto("/projects/"+n.data.project.id+"/permitslicenses/"+e):n.routeParams.permitlicenseId||(console.log("it says its not set"),n.goto("/projects/"+n.data.project.id+"/permitslicenses/"+e)))},n.saveCurrentPermitLicense=function(e){var t=e.is_new;n.isEcosystemWetland(e)||(e.regulation_activity=null),t||n.updateStatus(e),n.saveCurrent(n.parts.permitlicense,e,t).then(function(e){t&&n.goto("/projects/"+n.data.project.id+"/permitslicenses/"+e.id)})},n.updateStatus=function(e){},n.newPermitLicense=function(){n.parts.permitlicense.state=SavingStateEnum.LoadingNew,n.newButton.isopen=!1;var e=null;n.isEcosystemWetland(n.newButton)&&(e=n.newButton.regulation_activity),t.createNewPermitLicense(n.data.project,n.newButton.regulation,n.newButton.ecosystem,e,n.newButton.area,n.newButton.unit,n.newButton.approved_by_the_lc1,n.newButton.approved_by_the_dec,n.newButton.waste_license_type)},n.deletePermitLicense=function(){t.deletePermitLicense(n.routeParams),n.goto("/projects/"+n.data.project.id+"/permitslicenses")},n.calculateDateFeedbackToApplicants=function(){n.data.permitlicense.date_feedback_to_applicants=addDays(n.data.permitlicense.date_submitted,21)},n.uploadDocumentation=function(t,i,e){e&&(i.showUploading=!0,i.file=e[0],uploadFile(o,r,a,n.parts.permitlicense.form[i.formField],i.file,i.tag).then(function(e){t.documentation_ids.push(e.result.id),n.parts.permitlicense.form[i.formField].$setDirty(),n.saveCurrentPermitLicense(t),r(function(){i.showUploading=!1},3e3)},function(e){}))},n.deleteDocumentation=function(e,t,i){_.remove(e.documentation_ids,function(e){return e===t}),n.parts.permitlicense.form[i.formField].$setDirty(),n.saveCurrentPermitLicense(e)},n.hasDocumentationTag=function(e,t){var i=!1;return _.forEach(e,function(e){e.tag==t&&(i=!0)}),i},n.downloadFileUrl=function(e){return"/file/v1/download/"+e},n.auth.canSave=function(e){if(n.data.permitlicense.is_new&&n.parts.permitlicense.state==SavingStateEnum.SavingStarted)return!1;switch(e){case"new":case"delete":case"regulation":case"date_submitted":case"waste_license_type":case"ecosystem":case"regulation_activity":case"area":case"unit":case"approved_by_the_lc1":case"approved_by_the_dec":case"application_number":case"application_fee_receipt_number":case"date_feedback_to_applicants":case"date_sent_to_director":case"date_sent_from_dep":case"date_sent_officer":case"folio_no":return n.userinfo.info.role_1;case"personnel":return n.userinfo.info.role_2;case"application_evaluation_by_officer":case"date_of_evaluation":case"inspection_recommended":case"date_inspection":case"officer_recommend":case"date_sent_to_ed_for_decision":return n.userinfo.info.role_3;case"fee_receipt_no":case"date_fee_payed":return n.userinfo.info.role_4;case"user_id":case"decision":case"date_decision":case"signature_on_permit_license":case"date_permit_license":case"permit_license_no":case"date_permit_license_expired":case"upload_documentation_permit_license":case"delete_documentation_permit_license":return n.userinfo.info.role_5;case"status":default:return!1}},n.loadPermitLicense=function(){n.parts.permitlicense.state=SavingStateEnum.Loading,t.retrievePermitLicense(n.routeParams)[0].then(function(e){n.parts.permitlicense.state=SavingStateEnum.Loaded})},n.parts.permitlicense.state=SavingStateEnum.Loading,t.retrieveProjectData(n.routeParams)[4].then(function(e){n.parts.permitslicenses.state=SavingStateEnum.Loaded,_.isUndefined(n.routeParams.permitlicenseId)||n.loadPermitLicense()})}]),controllers.controller("SearchTabsController",["$scope","$routeParams","$location","$q","$timeout","ProjectFactory","Valuelists","UserInfo",function(e,t,i,n,r,a,o,s){e.SearchTabEnum=SearchTabEnum,e.routeParams=t,e.userinfo=s,e.valuelists=o;var c;e.tab=(c=i.path(),_.contains(c,"projects")?SearchTabEnum.Projects:_.contains(c,"eiaspermits")?SearchTabEnum.EiasPermits:_.contains(c,"permitslicenses")?SearchTabEnum.PermitsLicenses:_.contains(c,"auditsinspections")?SearchTabEnum.AuditsInspections:_.contains(c,"externalaudits")?SearchTabEnum.ExternalAudits:null),e.goto=function(e){r(function(){i.path(e)})}}]),controllers.controller("SearchAuditsInspectionsController",["$scope","$routeParams","$location","$q","$timeout","AuditInspectionSearch","UserInfo","Valuelists","SearchService",function(t,e,i,n,r,a,o,s,c){t.isSearching=!1,t.showResultGrid=!1,t.gridOptions={},t.gridOptions.enableHorizontalScrollbar=0,t.gridOptions.showGridFooter=!0,t.gridOptions.minRowsToShow=10,t.gridOptions.enableColumnMenus=!1,t.gridOptions.enableRowSelection=!0,t.gridOptions.enableRowHeaderSelection=!1,t.gridOptions.multiSelect=!1,t.gridOptions.noUnselect=!0,t.gridOptions.enableFooterTotalSelected=!1,t.gridOptions.appScopeProvider={onDblClick:function(e){t.goto("/projects/"+e.project_id+"/auditsinspections/"+e.auditinspection_id)}},t.gridOptions.rowTemplate='<div ng-dblclick="grid.appScope.onDblClick(row.entity)" ng-repeat="(colRenderIndex, col) in colContainer.renderedColumns track by col.colDef.name" class="ui-grid-cell" ng-class="{ \'ui-grid-row-header-cell\': col.isRowHeader }" ui-grid-cell ></div>',t.gridOptions.columnDefs=[{name:"auditinspection_code",displayName:"Number",width:80,cellTooltip:!0,headerTooltip:!0},{name:"project_title",displayName:"Project name",cellTooltip:!0,headerTooltip:!0},{name:"developer_name",displayName:"Developer name",cellTooltip:!0,headerTooltip:!0},{name:"developer_tin",displayName:"TIN",type:"number",width:90,cellTooltip:!0,headerTooltip:!0},{name:"district_district",displayName:"District",cellTooltip:!0,headerTooltip:!0},{name:"auditinspection_type",displayName:"Activity",cellTooltip:!0,headerTooltip:!0},{name:"category_description",displayName:"Category of project",width:150,cellTooltip:!0,headerTooltip:!0},{name:"auditinspection_action_taken",displayName:"Response",cellTooltip:!0,headerTooltip:!0},{name:"auditinspection_performance_level",displayName:"Performance",width:110,cellTooltip:!0,headerTooltip:!0},{name:"auditinspection_date_deadline",displayName:"Deadline for complete compliance",width:90,type:"date",cellFilter:'date:"d MMM yyyy"',headerTooltip:!0}],t.gridOptions.onRegisterApi=function(e){t.gridApi=e},t.setSearchUrl=function(){_.isEmpty(t.criteria)||(_.isEqual(c.criteria,t.criteria)?(c.allowCache=!1,t.search()):i.search(t.criteria))},t.search=function(){t.isSearching=!0,t.showResultGrid=!1,c.search(t.criteria).then(function(e){t.gridOptions.data=e,t.isSearching=!1,t.showResultGrid=!0})},t.reset=function(){t.criteria={},c.criteria={},t.gridOptions.data=[],t.showResultGrid=!1},t.exportAuditAndInspectionResults=function(e){exportObj.exportData(e,"auditAndInspection")},t.criteria=i.search(),_.isEmpty(t.criteria)&&!_.isEmpty(c.criteria)?i.search(c.criteria):_.isEmpty(t.criteria)||t.search()}]),controllers.controller("SearchProjectsController",["$scope","$routeParams","$location","$q","$timeout","ProjectSearch","UserInfo","Valuelists","ProjectSearchService",function(t,e,i,n,r,a,o,s,c){t.isSearching=!1,t.showResultGrid=!1,t.gridOptions={},t.gridOptions.enableHorizontalScrollbar=0,t.gridOptions.showGridFooter=!0,t.gridOptions.minRowsToShow=10,t.gridOptions.enableColumnMenus=!1,t.gridOptions.enableRowSelection=!0,t.gridOptions.enableRowHeaderSelection=!1,t.gridOptions.multiSelect=!1,t.gridOptions.noUnselect=!0,t.gridOptions.enableFooterTotalSelected=!1,t.gridOptions.appScopeProvider={onDblClick:function(e){t.goto("/projects/"+e.project_id)}},t.gridOptions.rowTemplate='<div ng-dblclick="grid.appScope.onDblClick(row.entity)" ng-repeat="(colRenderIndex, col) in colContainer.renderedColumns track by col.colDef.name" class="ui-grid-cell" ng-class="{ \'ui-grid-row-header-cell\': col.isRowHeader }" ui-grid-cell ></div>',t.gridOptions.columnDefs=[{name:"project_id",displayName:"Id",type:"number",width:50,cellTooltip:!0,headerTooltip:!0},{name:"project_title",displayName:"Name",cellTooltip:!0,headerTooltip:!0},{name:"project_location",displayName:"Location",cellTooltip:!0,headerTooltip:!0},{name:"district_district",displayName:"District",cellTooltip:!0,headerTooltip:!0},{name:"category_description",displayName:"Category",cellTooltip:!0,headerTooltip:!0},{name:"developer_name",displayName:"Developer name",cellTooltip:!0,headerTooltip:!0},{name:"developer_tin",displayName:"TIN",type:"number",width:90,cellTooltip:!0,headerTooltip:!0}],t.gridOptions.onRegisterApi=function(e){t.gridApi=e},t.setSearchUrl=function(){_.isEmpty(t.criteria)||(_.isEqual(c.criteria,t.criteria)?(c.allowCache=!1,t.search()):i.search(t.criteria))},t.search=function(){t.isSearching=!0,t.showResultGrid=!1,c.search(t.criteria).then(function(e){t.gridOptions.data=e,localStorage.projectData=JSON.stringify(e),t.isSearching=!1,t.showResultGrid=!0})},t.reset=function(){t.criteria={},c.criteria={},t.gridOptions.data=[],t.showResultGrid=!1},t.criteria=i.search(),_.isEmpty(t.criteria)&&!_.isEmpty(c.criteria)?i.search(c.criteria):_.isEmpty(t.criteria)||t.search(),t.exportProjects=function(e){exportObj.exportData(e,"project")}}]),controllers.controller("SearchEiasPermitsController",["$scope","$routeParams","$location","$q","$timeout","EiaPermitSearch","UserInfo","Valuelists","EiaPermitSearchService",function(i,e,t,n,r,a,o,s,c){i.isSearching=!1,i.showResultGrid=!1,i.gridOptions={},i.gridOptions.enableHorizontalScrollbar=0,i.gridOptions.showGridFooter=!0,i.gridOptions.minRowsToShow=10,i.gridOptions.enableColumnMenus=!1,i.gridOptions.enableRowSelection=!0,i.gridOptions.enableRowHeaderSelection=!1,i.gridOptions.multiSelect=!1,i.gridOptions.noUnselect=!0,i.gridOptions.enableFooterTotalSelected=!1,i.gridOptions.appScopeProvider={onDblClick:function(e){i.goto("/projects/"+e.project_id+"/eiaspermits/"+e.eiapermit_id)}},i.gridOptions.rowTemplate='<div ng-dblclick="grid.appScope.onDblClick(row.entity)" ng-repeat="(colRenderIndex, col) in colContainer.renderedColumns track by col.colDef.name" class="ui-grid-cell" ng-class="{ \'ui-grid-row-header-cell\': col.isRowHeader }" ui-grid-cell ></div>',i.gridOptions.columnDefs=[{name:"eiapermit_id",displayName:"EIA Id",type:"number",width:80,cellTooltip:!0,headerTooltip:!0},{name:"eiapermit_status",displayName:"Status",cellTooltip:!0,headerTooltip:!0},{name:"eiapermit_officer_assigned",displayName:"Team leader",cellTooltip:!0,headerTooltip:!0},{name:"project_title",displayName:"Project name",cellTooltip:!0,headerTooltip:!0},{name:"eiapermit_certificate_no",displayName:"Certificate No.",cellTooltip:!0,headerTooltip:!0}],i.gridOptions.onRegisterApi=function(e){i.gridApi=e},i.setSearchUrl=function(){_.forOwn(i.dateCriteria,function(e,t){e instanceof Date&&(e.setHours(12),i.criteria[t]=e.toJSON().substr(0,10))}),_.isEmpty(i.criteria)||(_.isEqual(c.criteria,i.criteria)?(c.allowCache=!1,i.search()):t.search(i.criteria))},i.search=function(){i.isSearching=!0,i.showResultGrid=!1,c.search(i.criteria).then(function(e){i.gridOptions.data=e,i.isSearching=!1,i.showResultGrid=!0})},i.reset=function(){i.criteria={},i.dateCriteria={},c.criteria={},i.gridOptions.data=[],i.showResultGrid=!1},i.exportEiasPermits=function(e){exportObj.exportData(e,"eiaspermits")},i.criteria=t.search(),i.dateCriteria={},i.criteria.eiapermit_date_submission_from&&(i.dateCriteria.eiapermit_date_submission_from=new Date(i.criteria.eiapermit_date_submission_from)),i.criteria.eiapermit_date_submission_to&&(i.dateCriteria.eiapermit_date_submission_to=new Date(i.criteria.eiapermit_date_submission_to)),_.isEmpty(i.criteria)&&!_.isEmpty(c.criteria)?t.search(c.criteria):_.isEmpty(i.criteria)||i.search()}]),controllers.controller("SearchPermitsLicensesController",["$scope","$routeParams","$location","$q","$timeout","PermitLicenseSearch","UserInfo","Valuelists","PermitLicenseSearchService",function(i,e,t,n,r,a,o,s,c){i.isSearching=!1,i.showResultGrid=!1,i.gridOptions={},i.gridOptions.enableHorizontalScrollbar=0,i.gridOptions.showGridFooter=!0,i.gridOptions.minRowsToShow=10,i.gridOptions.enableColumnMenus=!1,i.gridOptions.enableRowSelection=!0,i.gridOptions.enableRowHeaderSelection=!1,i.gridOptions.multiSelect=!1,i.gridOptions.noUnselect=!0,i.gridOptions.enableFooterTotalSelected=!1,i.gridOptions.appScopeProvider={onDblClick:function(e){i.goto("/projects/"+e.project_id+"/permitslicenses/"+e.permitlicense_id)}},i.gridOptions.rowTemplate='<div ng-dblclick="grid.appScope.onDblClick(row.entity)" ng-repeat="(colRenderIndex, col) in colContainer.renderedColumns track by col.colDef.name" class="ui-grid-cell" ng-class="{ \'ui-grid-row-header-cell\': col.isRowHeader }" ui-grid-cell ></div>',i.gridOptions.columnDefs=[{name:"permitlicense_id",displayName:"PL Id",type:"number",width:80,cellTooltip:!0,headerTooltip:!0},{name:"permitlicense_date_submitted",displayName:"Date of submission",width:130,type:"date",cellFilter:'date:"d MMM yyyy"',headerTooltip:!0},{name:"permitlicense_regulation",displayName:"Regulation",width:80,cellTooltip:!0,headerTooltip:!0},{name:"permitlicense_officer_assigned",displayName:"Team leader",cellTooltip:!0,headerTooltip:!0},{name:"project_title",displayName:"Project name",cellTooltip:!0,headerTooltip:!0}],i.idPermit=118,i.idLicense=119,i.idWetland=123,i.idRB=124,i.idLS=125,i.isDisabled=function(e){switch(e){case"permitlicense_ecosystem":return i.criteria.permitlicense_regulation==i.idLicense;case"permitlicense_waste_license_type":return i.criteria.permitlicense_regulation==i.idPermit;case"permitlicense_regulation_activity":return i.criteria.permitlicense_regulation==i.idLicense||i.criteria.permitlicense_ecosystem==i.idRB||i.criteria.permitlicense_ecosystem==i.idLS;default:return!1}},i.gridOptions.onRegisterApi=function(e){i.gridApi=e},i.setSearchUrl=function(){i.removeDisabledSearchCriteria(),_.forOwn(i.dateCriteria,function(e,t){e instanceof Date&&(e.setHours(12),i.criteria[t]=e.toJSON().substr(0,10))}),_.isEmpty(i.criteria)||(_.isEqual(c.criteria,i.criteria)?(c.allowCache=!1,i.search()):t.search(i.criteria))},i.removeDisabledSearchCriteria=function(){_.forOwn(i.criteria,function(e,t){i.isDisabled(t)&&(i.criteria[t]=null)})},i.search=function(){i.isSearching=!0,i.showResultGrid=!1,c.search(i.criteria).then(function(e){i.gridOptions.data=e,i.isSearching=!1,i.showResultGrid=!0})},i.reset=function(){i.criteria={},i.dateCriteria={},c.criteria={},i.gridOptions.data=[],i.showResultGrid=!1},i.exportPermitsLicensesResults=function(e){exportObj.exportData(e,"exportPermitsLicenses")},i.criteria=t.search(),i.dateCriteria={},i.criteria.permitlicense_date_submission_from&&(i.dateCriteria.permitlicense_date_submission_from=new Date(i.criteria.permitlicense_date_submission_from)),i.criteria.permitlicense_date_submission_to&&(i.dateCriteria.permitlicense_date_submission_to=new Date(i.criteria.permitlicense_date_submission_to)),_.isEmpty(i.criteria)&&!_.isEmpty(c.criteria)?t.search(c.criteria):_.isEmpty(i.criteria)||i.search()}]),controllers.controller("StatisticsTabsController",["$scope","$routeParams","$location","$q","$timeout","ProjectFactory","Valuelists","StatisticsService",function(e,t,i,n,r,a,o,s){e.routeParams=t,e.valuelists=o,e.StatisticsService=s,e.StatisticsTabEnum=StatisticsTabEnum;var c;e.tab=(c=i.path(),_.contains(c,"projects")?StatisticsTabEnum.Projects:_.contains(c,"eiaspermits")?StatisticsTabEnum.EiasPermits:_.contains(c,"auditsinspections")?StatisticsTabEnum.AuditsInspections:null),e.goto=function(e){r(function(){i.path(e)})}}]),controllers.controller("StatisticsProjectsController",["$scope","$routeParams","$location","$q","$timeout","ProjectStatistics","UserInfo","Valuelists","StatisticsService",function(t,e,i,n,r,a,o,s,c){t.data={},t.isLoadingData=!0,c.getProjectData().then(function(e){t.data=e,t.isLoadingData=!1})}]),controllers.controller("SearchExternalAuditsController",["$scope","$routeParams","$location","$q","$timeout","ExternalAuditSearch","UserInfo","Valuelists","ExternalAuditSearchService",function(i,e,t,n,r,a,o,s,c){i.isSearching=!1,i.showResultGrid=!1,i.gridOptions={},i.gridOptions.enableHorizontalScrollbar=0,i.gridOptions.showGridFooter=!0,i.gridOptions.minRowsToShow=10,i.gridOptions.enableColumnMenus=!1,i.gridOptions.enableRowSelection=!0,i.gridOptions.enableRowHeaderSelection=!1,i.gridOptions.multiSelect=!1,i.gridOptions.noUnselect=!0,i.gridOptions.enableFooterTotalSelected=!1,i.gridOptions.appScopeProvider={onDblClick:function(e){i.goto("/projects/"+e.project_id+"/externalaudits/"+e.externalaudit_id)}},i.gridOptions.rowTemplate='<div ng-dblclick="grid.appScope.onDblClick(row.entity)" ng-repeat="(colRenderIndex, col) in colContainer.renderedColumns track by col.colDef.name" class="ui-grid-cell" ng-class="{ \'ui-grid-row-header-cell\': col.isRowHeader }" ui-grid-cell ></div>',i.gridOptions.columnDefs=[{name:"externalaudit_id",displayName:"EA Id",type:"number",width:80,cellTooltip:!0,headerTooltip:!0},{name:"verification_inspection",displayName:"Verification inspection",cellTooltip:!0,headerTooltip:!0},{name:"response",displayName:"Response",cellTooltip:!0,headerTooltip:!0},{name:"externalaudit_officer_assigned",displayName:"Team leader",cellTooltip:!0,headerTooltip:!0},{name:"project_title",displayName:"Project name",cellTooltip:!0,headerTooltip:!0}],i.gridOptions.onRegisterApi=function(e){i.gridApi=e},i.setSearchUrl=function(){_.forOwn(i.dateCriteria,function(e,t){e instanceof Date&&(e.setHours(12),i.criteria[t]=e.toJSON().substr(0,10))}),_.isEmpty(i.criteria)||(_.isEqual(c.criteria,i.criteria)?(c.allowCache=!1,i.search()):t.search(i.criteria))},i.search=function(){i.isSearching=!0,i.showResultGrid=!1,c.search(i.criteria).then(function(e){i.gridOptions.data=e,i.isSearching=!1,i.showResultGrid=!0})},i.exportExternalAuditResults=function(e){exportObj.exportData(e,"externalAudit")},i.reset=function(){i.criteria={},i.dateCriteria={},c.criteria={},i.gridOptions.data=[],i.showResultGrid=!1},i.criteria=t.search(),i.dateCriteria={},i.criteria.externalaudit_date_submission_from&&(i.dateCriteria.externalaudit_date_submission_from=new Date(i.criteria.externalaudit_date_submission_from)),i.criteria.externalaudit_date_submission_to&&(i.dateCriteria.externalaudit_date_submission_to=new Date(i.criteria.externalaudit_date_submission_to)),_.isEmpty(i.criteria)&&!_.isEmpty(c.criteria)?t.search(c.criteria):_.isEmpty(i.criteria)||i.search()}]),controllers.controller("AdvancedCodesController",["$scope","$routeParams","EditCode","$timeout","$q","$interval","uiGridConstants",function(i,e,t,n,r,a,o){i.routeParams=e,i.parts={code:{form:null,state:SavingStateEnum.Loading}},i.gridOptions={},i.gridOptions.enableCellEditOnFocus=!0,i.gridOptions.showGridFooter=!0,i.gridOptions.minRowsToShow=15,i.gridOptions.rowEditWaitInterval=1e3,i.gridOptions.enableFiltering=!0,i.gridOptions.columnDefs=[{name:"id",type:"number",enableCellEdit:!1,width:60},{name:"description1",cellTooltip:!0,width:"*"},{name:"description2",cellTooltip:!0,width:150},{name:"value1",type:"number",width:100},{name:"dropdown_list",cellTooltip:!0,width:150},{name:"updated_by",enableCellEdit:!1,width:120},{name:"updated_at",enableCellEdit:!1,enableFiltering:!1,type:"date",cellFilter:'date:"d MMM yyyy HH:mm:ss"',width:160},{name:"delete",displayName:"",enableSorting:!1,enableCellEdit:!1,enableFiltering:!1,enableColumnMenu:!1,width:80,cellTemplate:'<div><button ng-show="row.entity.deleted_at" ng-click="grid.appScope.undeleteRow(row.entity)" class="btn undelete btn-sm btn-link">undelete</button><button ng-hide="row.entity.deleted_at" ng-click="grid.appScope.deleteRow(row.entity)" class="btn delete btn-sm btn-link">delete</button></div>'}],i.saveRow=function(e){var t=e.$update();i.gridApi.rowEdit.setSavePromise(e,t)},i.deleteRow=function(e){var t=e.$delete({});i.gridApi.rowEdit.setSavePromise(e,t)},i.undeleteRow=function(e){e.deleted_at=null,i.saveRow(e)},i.addRow=function(){(new t).$save().then(function(e){i.gridOptions.data.push(e),n(function(){i.gridApi.cellNav.scrollToFocus(e,i.gridOptions.columnDefs[0])})})},i.gridOptions.onRegisterApi=function(e){(i.gridApi=e).rowEdit.on.saveRow(i,i.saveRow)},t.query({},function(e){i.gridOptions.data=e})}]),controllers.controller("AdvancedUsersController",["$scope","$routeParams","EditUser","$timeout","$q","$interval","uiGridConstants",function(i,e,t,n,r,a,o){i.routeParams=e,i.parts={code:{form:null,state:SavingStateEnum.Loading}},i.gridOptions={},i.gridOptions.enableCellEditOnFocus=!0,i.gridOptions.showGridFooter=!0,i.gridOptions.minRowsToShow=15,i.gridOptions.rowEditWaitInterval=1e3,i.gridOptions.enableFiltering=!0,i.gridOptions.columnDefs=[{name:"id",type:"number",enableCellEdit:!1,width:60},{name:"initials",cellTooltip:!0,width:80},{name:"name",cellTooltip:!0,width:"*"},{name:"job_position_code",cellTooltip:!0,width:80},{name:"job_position_name",cellTooltip:!0,width:100},{name:"email",cellTooltip:!0,width:100},{name:"password",cellTooltip:!0,width:80},{name:"is_passive",type:"number",width:90},{name:"role_ids",enableCellEdit:!0,width:90},{name:"updated_by",enableCellEdit:!1,width:120},{name:"updated_at",enableCellEdit:!1,enableFiltering:!1,type:"date",cellFilter:'date:"d MMM yyyy HH:mm:ss"',width:160},{name:"delete",displayName:"",enableSorting:!1,enableCellEdit:!1,enableFiltering:!1,enableColumnMenu:!1,width:80,cellTemplate:'<div><button ng-show="row.entity.deleted_at" ng-click="grid.appScope.undeleteRow(row.entity)" class="btn undelete btn-sm btn-link">undelete</button><button ng-hide="row.entity.deleted_at" ng-click="grid.appScope.deleteRow(row.entity)" class="btn delete btn-sm btn-link">delete</button></div>'}],i.saveRow=function(e){var t=e.$update();i.gridApi.rowEdit.setSavePromise(e,t)},i.deleteRow=function(e){var t=e.$delete({});i.gridApi.rowEdit.setSavePromise(e,t)},i.undeleteRow=function(e){e.deleted_at=null,i.saveRow(e)},i.addRow=function(){(new t).$save().then(function(e){i.gridOptions.data.push(e),n(function(){i.gridApi.cellNav.scrollToFocus(e,i.gridOptions.columnDefs[0])})})},i.gridOptions.onRegisterApi=function(e){(i.gridApi=e).rowEdit.on.saveRow(i,i.saveRow)},t.query({},function(e){i.gridOptions.data=e})}]),controllers.controller("AdvancedLeadAgenciesController",["$scope","$routeParams","EditLeadAgency","$timeout","$q","$interval","uiGridConstants",function(i,e,t,n,r,a,o){i.routeParams=e,i.parts={code:{form:null,state:SavingStateEnum.Loading}},i.gridOptions={},i.gridOptions.enableCellEditOnFocus=!0,i.gridOptions.showGridFooter=!0,i.gridOptions.minRowsToShow=15,i.gridOptions.rowEditWaitInterval=1e3,i.gridOptions.enableFiltering=!0,i.gridOptions.columnDefs=[{name:"id",type:"number",enableCellEdit:!1,width:60},{name:"short_name",cellTooltip:!0,width:150},{name:"long_name",cellTooltip:!0,width:"*"},{name:"updated_by",enableCellEdit:!1,width:120},{name:"updated_at",enableCellEdit:!1,enableFiltering:!1,type:"date",cellFilter:'date:"d MMM yyyy HH:mm:ss"',width:160},{name:"delete",displayName:"",enableSorting:!1,enableCellEdit:!1,enableFiltering:!1,enableColumnMenu:!1,width:80,cellTemplate:'<div><button ng-show="row.entity.deleted_at" ng-click="grid.appScope.undeleteRow(row.entity)" class="btn undelete btn-sm btn-link">undelete</button><button ng-hide="row.entity.deleted_at" ng-click="grid.appScope.deleteRow(row.entity)" class="btn delete btn-sm btn-link">delete</button></div>'}],i.saveRow=function(e){var t=e.$update();i.gridApi.rowEdit.setSavePromise(e,t)},i.deleteRow=function(e){var t=e.$delete({});i.gridApi.rowEdit.setSavePromise(e,t)},i.undeleteRow=function(e){e.deleted_at=null,i.saveRow(e)},i.addRow=function(){(new t).$save().then(function(e){i.gridOptions.data.push(e),n(function(){i.gridApi.cellNav.scrollToFocus(e,i.gridOptions.columnDefs[0])})})},i.gridOptions.onRegisterApi=function(e){(i.gridApi=e).rowEdit.on.saveRow(i,i.saveRow)},t.query({},function(e){i.gridOptions.data=e})}]),controllers.controller("LoginController",["$scope","$http","$routeParams","$location","UserInfo","$timeout",function(r,e,t,a,o,i){r.loginData={},r.sendData={},r.resetData={},r.loginMessages=[],r.sendMessages=[],r.resetMessages=[],r.loginFormDisabled=!1,r.sendFormDisabled=!1,r.resetFormDisabled=!1,r.forgot=function(){console.debug("/password/email")};function s(e){return _.flatten(_.values(e))}r.login=function(){r.loginForm.$invalid||(r.loginFormDisabled=!0,e.post("/auth/login",r.loginData).success(function(e,t,i,n){r.loginMessages=s(e),o.reTry(),a.path("/")}).error(function(e,t,i,n){r.loginMessages=s(e),r.loginFormDisabled=!1}))},r.send=function(){r.sendForm.$invalid||(r.sendFormDisabled=!0,e.post("/password/email",r.sendData).success(function(e,t,i,n){r.sendMessages=s(e)}).error(function(e,t,i,n){r.sendMessages=s(e),r.sendFormDisabled=!1}))},r.reset=function(){r.resetForm.$invalid||(r.resetFormDisabled=!0,r.resetData.token=t.token,e.post("/password/reset",r.resetData).success(function(e,t,i,n){r.resetMessages=s(e),o.reTry(),a.path("/user")}).error(function(e,t,i,n){r.resetMessages=s(e),r.resetFormDisabled=!1}))},i(function(){})}]);var directives=angular.module("seroApp.directives").directive("appVersion",["version",function(n){return function(e,t,i){t.text(n.replace(/\.0$/,"").replace(/\.00$/,".0").replace(/\.([1-9])$/,".0$1"))}}]);directives.directive("addPractitionerButton",["Practitioner",function(n){return{restrict:"A",link:function(e,t,i){t.bind("click",function(){new n({person:"Gunnar Nymann",city:"Oslo"}).$save()})}}}]),directives.directive("animateNewElement",["$animate",function(r){return function(e,n,t){e.$watch(t.animateNewElement,function(e,t){if(!0===e){console.log(n);var i="new-element";r.addClass(n,i,function(){r.removeClass(n,i)})}})}}]),directives.directive("hoverOnParent",[function(){return{restrict:"A",link:function(e,t,i){var n=i.hoverOnParent;t.parent(n).bind("mouseenter",function(){t.addClass("btn-link-hover")}),t.parent(n).bind("mouseleave",function(){t.removeClass("btn-link-hover")})}}}]),directives.directive("coordinatePasting",function(){return{require:"ngModel",link:function(e,t,i,n){n.$setViewValue("0.12104"),n.$render()}}}),directives.directive("setFocus",["$timeout",function(n){return{restrict:"A",link:function(e,t,i){n(function(){n(function(){t[0].focus()})})}}}]),directives.directive("statisticsPanel",function(){return{restrict:"E",scope:{part:"="},templateUrl:"partials/statisticsTablePanel.html"}}),angular.module("seroApp.directives").directive("seroDeleteButton",["$sce",function(e){return{restrict:"E",scope:{onYes:"&",text:"=",warning:"=",buttonClass:"="},templateUrl:"partials/directives.deleteButton.html"}}]),seroApp.filter("myDateFormat",function(i){return function(e){if(!e)return"tom";var t=new Date(e.replace(/-/g,"/"));return i("date")(t,"MMM-dd-yyyy")}});var version={version:"4.69.0"},services=angular.module("seroApp.services");services.value("version",version.version),services.factory("Practitioner",["$resource",function(e){return e("/api/v1/practitioner/:id",{id:"@id"},{update:{method:"PUT",isArray:!1}})}]),services.factory("Project",["$resource",function(e){return e("/api/v1/project/:projectId",{projectId:"@id"},{update:{method:"PUT",isArray:!1}})}]),services.factory("Organisation",["$resource",function(e){return e("/api/v1/organisation/:organisationId",{organisationId:"@id"},{update:{method:"PUT",isArray:!1}})}]),services.factory("EiaPermit",["$resource",function(e){return e("/api/v1/project/:projectId/eiapermit/:eiapermitId",{eiapermitId:"@id"},{update:{method:"PUT",isArray:!1}})}]),services.factory("Document",["$resource",function(e){return e("/api/v1/project/:projectId/eiapermit/:eiapermitId/document/:documentId",{documentId:"@id"},{update:{method:"PUT",isArray:!1}})}]),services.factory("Hearing",["$resource",function(e){return e("/api/v1/project/:projectId/eiapermit/:eiapermitId/document/:documentId/hearing/:hearingId",{hearingId:"@id"},{update:{method:"PUT",isArray:!1}})}]),services.factory("PermitLicense",["$resource",function(e){return e("/api/v1/project/:projectId/permitlicense/:permitlicenseId",{permitLicenseId:"@id"},{update:{method:"PUT",isArray:!1}})}]),services.factory("ExternalAudit",["$resource",function(e){return e("/api/v1/project/:projectId/externalaudit/:externalauditId",{externalauditId:"@id"},{update:{method:"PUT",isArray:!1}})}]),services.factory("DocumentEA",["$resource",function(e){return e("/api/v1/project/:projectId/externalaudit/:externalauditId/document/:documentId",{documentId:"@id"},{update:{method:"PUT",isArray:!1}})}]),services.factory("AuditInspection",["$resource",function(e){return e("/api/v1/project/:projectId/auditinspection/:auditinspectionId",{auditinspectionId:"@id"},{update:{method:"PUT",isArray:!1}})}]),services.factory("Valuelist",["$resource",function(e){return e("/api/v1/valuelist/:id",{id:"@id"})}]),services.factory("EnvInfo",["$http",function(e){return function(t){e.get("/env").success(function(e){return t(e)})}}]),services.factory("Valuelists",["Valuelist",function(e){return e.get({id:"all"})}]),services.factory("UserInfo",["$http","$location",function(t,i){function n(e){e?(_.merge(r.info,e),"/login"==i.path()&&i.path("/")):r.info=_.cloneDeep(a)}function e(){t.get("/user/info").success(n)}var r={info:{}},a={name:"Not signed in",role_1:!1,role_2:!1,role_3:!1,role_4:!1,role_5:!1,role_6:!1,role_7:!1,role_8:!1,roles:[],features:[]};return r.impersonate=function(e){n(null),t.get("/user/impersonate/"+e).success(n)},r.signout=function(){t.get("/auth/logout").success(function(){n(null),i.path("/login")})},r.getAllUsers=function(){t.get("/user/all").success(function(e){r.allusers=e})},r.reTry=function(){e()},n(null),e(),r}]),services.factory("EditCode",["$resource",function(e){return e("/edit/v1/code/:codeId",{codeId:"@id"},{update:{method:"PUT",isArray:!1}})}]),services.factory("EditUser",["$resource",function(e){return e("/edit/v1/user/:userId",{userId:"@id"},{update:{method:"PUT",isArray:!1}})}]),services.factory("EditLeadAgency",["$resource",function(e){return e("/edit/v1/leadagency/:leadAgencyId",{leadAgencyId:"@id"},{update:{method:"PUT",isArray:!1}})}]),services.factory("EiaPermitSearch",["$resource",function(e){return e("/search/v1/eiapermit")}]),services.factory("PermitLicenseSearch",["$resource",function(e){return e("/search/v1/permitlicense")}]),services.factory("ExternalAuditSearch",["$resource",function(e){return e("/search/v1/externalaudit")}]),services.factory("AuditInspectionSearch",["$resource",function(e){return e("/search/v1/auditinspection")}]),services.factory("ProjectSearch",["$resource",function(e){return e("/search/v1/project")}]),services.factory("ProjectStatistics",["$resource",function(e){return e("/statistics/v1/project")}]),services.factory("GeneralStatistics",["$resource",function(e){return e("/statistics/v1/general")}]),services.factory("EiaPermitSearchService",["EiaPermitSearch","$q",function(i,n){var r={criteria:{},allowCache:!0,rows:[],search:function(e){var t=n.defer();return _.isEqual(r.criteria,e)&&r.allowCache?t.resolve(r.rows):(r.criteria=_.clone(e),i.query(r.criteria,function(e){r.rows=e,t.resolve(r.rows),r.allowCache=!0})),t.promise}};return r}]),services.factory("PermitLicenseSearchService",["PermitLicenseSearch","$q",function(i,n){var r={criteria:{},allowCache:!0,rows:[],search:function(e){var t=n.defer();return _.isEqual(r.criteria,e)&&r.allowCache?t.resolve(r.rows):(r.criteria=_.clone(e),i.query(r.criteria,function(e){r.rows=e,t.resolve(r.rows),r.allowCache=!0})),t.promise}};return r}]),services.factory("ExternalAuditSearchService",["ExternalAuditSearch","$q",function(i,n){var r={criteria:{},allowCache:!0,rows:[],search:function(e){var t=n.defer();return _.isEqual(r.criteria,e)&&r.allowCache?t.resolve(r.rows):(r.criteria=_.clone(e),i.query(r.criteria,function(e){r.rows=e,t.resolve(r.rows),r.allowCache=!0})),t.promise}};return r}]),services.factory("SearchService",["AuditInspectionSearch","$q",function(i,n){var r={criteria:{},allowCache:!0,rows:[],search:function(e){var t=n.defer();return _.isEqual(r.criteria,e)&&r.allowCache?t.resolve(r.rows):(r.criteria=_.clone(e),i.query(r.criteria,function(e){r.rows=e,t.resolve(r.rows),r.allowCache=!0})),t.promise}};return r}]),services.factory("ProjectSearchService",["ProjectSearch","$q",function(i,n){var r={criteria:{},allowCache:!0,rows:[],search:function(e){var t=n.defer();return _.isEqual(r.criteria,e)&&r.allowCache?t.resolve(r.rows):(r.criteria=_.clone(e),i.query(r.criteria,function(e){r.rows=e,t.resolve(r.rows),r.allowCache=!0})),t.promise}};return r}]),services.factory("StatisticsService",["ProjectStatistics","$q",function(i,n){var r={allowCache:!0,projectData:{},getProjectData:function(e){var t=n.defer();return r.allowCache&&!_.isEmpty(r.projectData)?t.resolve(r.projectData):i.get({},function(e){r.projectData=e,t.resolve(e)}),t.promise}};return r}]);var data1={};services.factory("ProjectFactory",["$q","$filter","Project","Organisation","EiaPermit","Document","Hearing","ExternalAudit","DocumentEA","AuditInspection","Valuelists","UserInfo","PermitLicense",function(c,e,d,u,l,r,a,p,o,m,t,i,f){var g={project:{},organisation:{},eiaspermits:[],eiapermit:{},documents:[],document:{},hearings:[],hearing:{},permitslicenses:[],permitlicense:{},externalaudits:[],externalaudit:{},documents_ea:[],document_ea:{},auditsinspections:[],auditinspection:{}};return g.valuelists=t,g.userinfo=i,g.hasData={eiapermits:!1,eiapermit:!1,documents:!1,document:!1,hearings:!1,hearing:!1,permitslicenses:!1,permitlicense:!1,externalaudits:!1,externalaudit:!1,documents_ea:!1,document_ea:!1},g.retrieveProjectData=function(e){var t=c.defer(),i=c.defer(),n=c.defer(),r=c.defer(),a=c.defer(),o=c.defer();if(g.project.id!=e.projectId){var s=_.omit(e,["eiapermitId","externalauditId","documentId","hearingId","permitlicenseId","auditinspectionId"]);g.empty(),g.project=d.get(s,function(e){t.resolve(e),g.organisation=u.get({organisationId:e.organisation_id},function(e){i.resolve(e)})}),g.eiaspermits=l.query(s,function(e){n.resolve(e)}),g.permitslicenses=f.query(s,function(e){o.resolve(e)}),g.externalaudits=p.query(s,function(e){r.resolve(e)}),g.auditsinspections=m.query(s,function(e){a.resolve(e)})}else _.remove(g.permitslicenses,function(e){return e.is_new}),t.resolve(g.project),i.resolve(g.organisation),n.resolve(g.eiaspermits),o.resolve(g.permitslicenses),r.resolve(g.externalaudits),a.resolve(g.auditsinspections);return[t.promise,i.promise,n.promise,a.promise,o.promise,r.promise]},g.retrieveEiaPermit=function(t){var i=c.defer(),n=c.defer();if(g.eiapermit.id!=t.eiapermitId){g.emptyEiaPermit();var e=_.where(g.eiaspermits,{id:parseInt(t.eiapermitId)});1==e.length&&(g.eiapermit=e[0],g.eiapermit.$get(_.omit(t,["documentId","hearingId"]),function(e){i.resolve(e),g.documents=r.query(_.omit(t,["documentId","hearingId"]),function(e){n.resolve(e)})}))}else i.resolve(g.eiapermit),n.resolve(g.documents);return[i.promise,n.promise]},g.retrieveDocument=function(t){var i=c.defer(),n=c.defer();if(g.document.id!=t.documentId){g.emptyDocument();var e=_.where(g.documents,{id:parseInt(t.documentId)});1==e.length&&(g.document=e[0],g.document.$get(_.omit(t,["hearingId"]),function(e){g.hearings=a.query(_.omit(t,["hearingId"]),function(e){n.resolve(e)}),i.resolve(e)}))}else i.resolve(g.document),n.resolve(g.hearings);return[i.promise,n.promise]},g.retrieveHearing=function(e){var t=c.defer();if(g.hearing.id!=e.hearingId){g.emptyHearing();var i=_.where(g.hearings,{id:parseInt(e.hearingId)});1==i.length&&(g.hearing=i[0],g.hearing.$get(e,function(e){t.resolve(e)}))}else t.resolve(g.hearing);return[t.promise]},g.retrieveExternalAudit=function(t){var i=c.defer(),n=c.defer();g.emptyExternalAudit();var e=_.where(g.externalaudits,{id:parseInt(t.externalauditId)});return 1==e.length&&(g.externalaudit=e[0],g.externalaudit.$get(_.omit(t,["documentId"]),function(e){g.documents_ea=o.query(_.omit(t,["documentId"]),function(e){n.resolve(e)}),i.resolve(e)})),[i.promise,n.promise]},g.retrieveDocumentEA=function(e){var t=c.defer();if(g.document_ea.id!=e.documentId){g.emptyDocumentEA();var i=_.where(g.documents_ea,{id:parseInt(e.documentId)});1==i.length&&(g.document_ea=i[0],g.document_ea.$get(_.omit(e,["hearingId"]),function(e){t.resolve(e)}))}else t.resolve(g.document_ea);return[t.promise]},g.retrieveAuditInspection=function(e){var t=c.defer();if(e.auditinspectionId){var i=_.where(g.auditsinspections,{id:parseInt(e.auditinspectionId)});1==i.length&&(g.auditinspection=i[0],g.auditinspection.$get(e,function(e){t.resolve(e)}))}return[t.promise]},g.retrievePermitLicense=function(e){data1=g.permitslicenses;var t=c.defer();if(e.permitlicenseId){var i=_.where(g.permitslicenses,{id:parseInt(e.permitlicenseId)});1==i.length&&(g.permitlicense=i[0],g.permitlicense.$get(e,function(e){t.resolve(e)}))}return[t.promise]},g.getProjectSummary=function(e){var t=g.project;return t.title?t.title:""},g.getCodeFromValuelist=function(e,t){"string"==typeof t&&(t=parseInt(t));var i=_.find(g.valuelists[e],{id:t});return i?i.description1:""},g.setOrganisation=function(e){var t=c.defer();return e=new u(e),(g.organisation=e).$get({},function(e){t.resolve(e)}),t.promise},g.setEiaPermit=function(e){var t=c.defer();return g.eiapermit=e,t.resolve(e),t.promise},g.setAuditInspection=function(e){var t=c.defer();return g.auditinspection=e,t.resolve(e),t.promise},g.empty=function(){g.project={},g.organisation={},g.eiaspermits=[],g.emptyEiaPermit(),g.emptyExternalAudit(),g.auditsinspections=[],g.auditinspection={}},g.emptyEiaPermit=function(){g.eiapermit={},g.documents=[],g.emptyDocument()},g.emptyDocument=function(){g.document={},g.hearings=[],g.emptyHearing()},g.emptyHearing=function(){g.hearing={}},g.emptyExternalAudit=function(){g.externalaudit={},g.documents_ea=[],g.emptyDocumentEA()},g.emptyDocumentEA=function(){g.document_ea={}},g.createNewProject=function(e){var t={has_industrial_waste_water:42,organisation_id:e.id,risk_level:null,is_new:!0};g.project=new d(t)},g.createNewOrganisation=function(){g.organisation=new u({is_new:!0})},g.createNewEiaPermit=function(e){var t={project_id:e.id,inspection_recommended:42,is_new:!0};g.eiapermit=new l(t),g.eiaspermits.push(g.eiapermit),g.documents=[]},g.createNewDocument=function(e){var t={eia_permit_id:e.id,director_copy_no:1,is_new:!0};g.document=new r(t),g.documents.unshift(g.document),g.hearings=[]},g.createNewHearing=function(e){var t={document_id:e.id,is_new:!0};g.hearing=new a(t),g.hearings.unshift(g.hearing)},g.deleteEiaPermit=function(e){function t(e){g.eiaspermits.splice(e,1),g.eiapermit={}}var i=_.findIndex(g.eiaspermits,{id:g.eiapermit.id});g.eiapermit.is_new?t(i):g.eiapermit.$delete(e,function(){t(i)})},g.deleteDocument=function(e){function t(e){g.documents.splice(e,1),g.document={}}var i=c.defer();if(g.document.is_new)t(0);else{var n=_.findIndex(g.documents,{id:g.document.id});g.document.$delete(e,function(){t(n),i.resolve()})}return i.promise},g.moveDocument=function(e,t){var i=c.defer(),n=_.findIndex(g.documents,{id:g.document.id});return g.document.eia_permit_id=t,g.document.$update(e,function(e){!function(e){g.documents.splice(e,1),g.document={}}(n),i.resolve(e)},function(){i.reject("Moving failed")}),i.promise},g.moveDocumentEA=function(e,t){var i=c.defer(),n=_.findIndex(g.documents_ea,{id:g.document_ea.id});return g.document_ea.external_audit_id=t,g.document_ea.$update(e,function(e){!function(e){g.documents_ea.splice(e,1),g.document_ea={}}(n),i.resolve(e)},function(){i.reject("Moving failed")}),i.promise},g.deleteHearing=function(e){function t(e){g.hearings.splice(e,1),g.hearing={}}var i=c.defer();if(g.hearing.is_new)t(0);else{var n=_.findIndex(g.hearings,{id:g.hearing.id});g.hearing.$delete(e,function(){t(n),i.resolve()})}return i.promise},g.createNewExternalAudit=function(e){var t={project_id:e.id,is_new:!0};g.externalaudit=new p(t),g.externalaudits.push(g.externalaudit),g.documents_ea=[]},g.createNewDocumentEA=function(e){var t={external_audit_id:e.id,director_copy_no:1,is_new:!0};g.document_ea=new o(t),g.documents_ea.unshift(g.document_ea)},g.deleteExternalAudit=function(e){function t(e){g.externalaudits.splice(e,1),g.externalaudit={}}var i=_.findIndex(g.externalaudits,{id:g.externalaudit.id});g.externalaudit.is_new?t(i):g.externalaudit.$delete(e,function(){t(i)})},g.deleteDocumentEA=function(e){function t(e){g.documents_ea.splice(e,1),g.document_ea={}}var i=c.defer();if(g.document_ea.is_new)t(0);else{var n=_.findIndex(g.documents_ea,{id:g.document_ea.id});g.document_ea.$delete(e,function(){t(n),i.resolve()})}return i.promise},g.createNewAuditInspection=function(e,t,i,n,r){var a={project_id:e.id,year:t,type:i,reason:n,date_carried_out:r,days:1,status:70,performance_level:47,lead_officer:g.userinfo.info.id,is_new:!0};g.auditinspection=new m(a),g.auditsinspections.push(g.auditinspection)},g.deleteAuditInspection=function(e){function t(e){g.auditsinspections.splice(e,1),0<g.auditsinspections.length?g.auditinspection=g.auditinspection[0]:g.auditinspection={}}var i=_.findIndex(g.auditsinspections,{id:g.auditinspection.id});g.auditinspection.is_new?t(i):g.auditinspection.$delete(e,function(){t(i)})},g.createNewPermitLicense=function(e,t,i,n,r,a,o,s,c){var d={project_id:e.id,regulation:t,ecosystem:i,regulation_activity:n,area:r,unit:a,approved_by_the_lc1:o,approved_by_the_dec:s,waste_license_type:c,is_new:!0};g.permitlicense=new f(d),g.permitslicenses.push(g.permitlicense)},g.deletePermitLicense=function(e){function t(e){g.permitslicenses.splice(e,1),g.permitlicense={}}var i=_.findIndex(g.permitslicenses,{id:g.permitlicense.id});g.permitlicense.is_new?t(i):g.permitlicense.$delete(e,function(){t(i)})},g.deleteProject=function(e){function t(){g.project={},i.resolve()}var i=c.defer();return g.project.is_new?t():g.project.$delete(e,function(){t()}),i.promise},g.save=function(e,t){var i=c.defer();if(t.is_new){var n=_.omit(e,function(e){return"new"==e});t.$save(n,function(e){i.resolve(e)},function(){i.reject("Saving new failed")})}else t.$update(e,function(e){i.resolve(e)},function(){i.reject("Saving exisiting failed")});return i.promise},g}]);var validations=angular.module("pax.validations");function isNumberInRange(e,t,i){return!(null!==e&&i<e)&&!(null!==t&&t<i)}function getColumns(e){var n=[];return $.each(e[0],function(e,t){var i={};i.headertext=e,i.datatype="string",i.datafield=e,n.push(i)}),n}validations.directive("decimal",function(){return{require:"ngModel",link:function(e,t,i,r){var n=i.min?parseFloat(i.min):null,a=i.max?parseFloat(i.max):null,o=i.decimal?"{0,"+parseInt(i.decimal)+"}":"+",s=i.negativeNumber?"\\-?":"",c=new RegExp("^"+s+"\\d+((\\.|\\,)\\d"+o+")?$");r.$parsers.push(function(e,t){if(r.$isEmpty(e))return null;var i=e.toString().trim().replace(",","."),n=parseFloat(i);return r.$isEmpty(n)?void 0:n}),r.$formatters.push(function(e){if(r.$isEmpty(e)||!i.decimal)return e;var t=parseInt(i.decimal);return _.round(parseFloat(e),t).toFixed(t)}),r.$validators.decimalInRange=function(e,t){return!!r.$isEmpty(e)||!!c.test(t)&&isNumberInRange(n,a,t)}}}}),validations.directive("integer",function(){return{require:"ngModel",link:function(e,t,i,n){var r=i.min?parseInt(i.min):null,a=i.max?parseInt(i.max):null,o=i.negativeNumber?"\\-?":"",s=new RegExp("^"+o+"\\d+$");n.$validators.integerInRange=function(e,t){return!!n.$isEmpty(e)||!!s.test(t)&&isNumberInRange(r,a,t)}}}}),validations.directive("certificateNumber",function(){return{require:"ngModel",link:function(e,t,i,n){var r=new RegExp("^CC/(EIA|EA|EP)/[0-9]{3}/[0-9]{2}$");n.$validators.certificateNumber=function(e,t){return!!n.$isEmpty(e)||r.test(t)}}}}),function(o){var s={containerid:null,datatype:"table",dataset:null,columns:null,returnUri:!0,locale:"en-US",worksheetName:"My Worksheet",encoding:"utf-8"},c=s;o.fn.excelexportjs=function(e){c=o.extend({},s,e);var t,r=[];return function(){var e=c.datatype.toLowerCase();switch(function(e){switch(e){case"table":break;case"json":r=c.dataset;break;case"xml":o(c.dataset).find("row").each(function(e,t){var i={};null!=this.attributes&&0<this.attributes.length&&(o(this.attributes).each(function(){i[this.name]=this.value}),r.push(i))});break;case"jqgrid":o(c.dataset).find("rows > row").each(function(e,t){var i={};null!=this.children&&0<this.children.length&&(o(this.children).each(function(){i[this.tagName]=o(this).text()}),r.push(i))})}}(e),e){case"table":t=n(o("<div>").append(o("#"+c.containerid).clone()).html());break;case"json":case"xml":case"jqgrid":t=n(i())}{if(c.returnUri)return t;a()||window.open(t)}}();function i(){var n="<table id='tabledata' style='table-layout:inherit;white-space: nowrap;'>";return n+="<thead><tr>",o(c.columns).each(function(e,t){1!=this.ishidden&&(n+="<th",this.width,n+=">",n+=this.headertext,n+="</th>")}),n+="</tr></thead>",n+="<tbody>",o(r).each(function(e,i){n+="<tr>",o(c.columns).each(function(e,t){i.hasOwnProperty(this.datafield)&&1!=this.ishidden&&(n+="<td",n+=">",n+=i[this.datafield],n+="</td>")}),n+="</tr>"}),n+="</tbody>",n+="</table>"}function n(e){if(!a()){var t="<html xml:lang="+s.locale+" xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:x='urn:schemas-microsoft-com:office:excel' xmlns='http://www.w3.org/TR/REC-html40'>";t+="<head>",t+='<meta http-equiv="Content-type" content="text/html;charset='+s.encoding+'" />',t+="\x3c!--[if gte mso 9]>",t+="<xml>",t+="<x:ExcelWorkbook>",t+="<x:ExcelWorksheets>",t+="<x:ExcelWorksheet>",t+="<x:Name>",t+="{worksheet}",t+="</x:Name>",t+="<x:WorksheetOptions>",t+="<x:DisplayGridlines/>",t+="</x:WorksheetOptions>",t+="</x:ExcelWorksheet>",t+="</x:ExcelWorksheets>",t+="</x:ExcelWorkbook>",t+="</xml>",t+="<![endif]--\x3e",t+="</head>",t+="<body>",t+=e.replace(/"/g,"'"),t+="</body>";return function(e){return window.btoa(unescape(encodeURIComponent(e)))}(function(e,i){return e.replace(/{(\w+)}/g,function(e,t){return i[t]})}(t+="</html>",{worksheet:c.worksheetName,table:e}))}!function(e){var t=document.createElement("div");t.innerHTML=e;var i,n="<table border='2px'><tr bgcolor='#87AFC6'>",r=0;i="table"==c.datatype.toLowerCase()?document.getElementById(c.containerid):t.children[0];for(r=0;r<i.rows.length;r++)n=n+i.rows[r].innerHTML+"</tr>";n=(n=(n=(n+="</table>").replace(/<A[^>]*>|<\/A>/g,"")).replace(/<img[^>]*>/gi,"")).replace(/<input[^>]*>|<\/input>/gi,""),0<window.navigator.userAgent.indexOf("MSIE ")||!!navigator.userAgent.match(/Trident.*rv\:11\./)?(txtArea1.document.open("txt/html","replace"),txtArea1.document.write(n),txtArea1.document.close(),txtArea1.focus(),sa=txtArea1.document.execCommand("SaveAs",!0,c.worksheetName+".xlsx")):sa=window.open("data:application/vnd.ms-excel,"+encodeURIComponent(n));sa}(e)}function a(){return 0<(!!navigator.userAgent.match(/Trident/g)||!!navigator.userAgent.match(/MSIE/g))}}}(jQuery);var excelExport=function(e,t,i){e=exportHelpers.reformatDateFields(e,t.dateFields),e=exportHelpers.renameFields(e,t.fieldmap),e=exportHelpers.sortObj(e,Object.values(t.fieldmap)),e=exportHelpers.replaceNullValues(e);var n=$("#dvjson").excelexportjs({containerid:"dvjson",datatype:"json",dataset:e,columns:getColumns(e),worksheetName:""}),r=new Date,a=r.getDate()+"."+(r.getMonth()+1)+"."+r.getFullYear()+"_"+r.getHours()+"."+r.getMinutes(),o=exportHelpers.b64toBlob(n,"application/vnd.ms-excel"),s=URL.createObjectURL(o),c=document.createElement("a"),d=document.body.appendChild(c);d.href=s,d.download=i+"_"+a+".xls",d.click()},exportHelpers={renameFields:function(e,t){var i=(e=JSON.parse(JSON.stringify(e))).length;for(var n in t)if(t.hasOwnProperty(n))for(var r=t[n],a=0;a<i;a++){var o=e[a][n];e[a][r]=o,delete e[a][n]}return e},removeFields:function(e,t){for(var i=(e=JSON.parse(JSON.stringify(e))).length,n=0;n<i;n++){var r=e[n];for(var a in r)r.hasOwnProperty(a)&&t.includes(a)&&delete e[n][a]}return e},reformatDateFields:function(e,t){for(var i,n=[],r=0;r<e.length;r++){var a=e[r];for(var o in a)a.hasOwnProperty(o)&&t.includes(o)&&(a[o]=(i=a[o])?i.split("-").reverse().join("-"):i);n.push(a)}return n},replaceNullValues:function(e){for(var t=[],i=0;i<e.length;i++){var n=e[i];if("object"==typeof n){for(var r in n)if(n.hasOwnProperty(r)){var a=n[r];null==a||""==a?n[r]="NA":(n[r]=n[r]+"",n[r]=n[r].trim())}t.push(n)}}return t},sortObj:function(e,t){e=JSON.parse(JSON.stringify(e));for(var i=[],n=0;n<e.length;n++){for(var r=e[n],a={},o=0;o<t.length;o++){var s=t[o];a[s]=r[s]}i.push(a)}return i},b64toBlob:function(e,t){for(var i=atob(e),n=[],r=0;r<i.length;r+=512){for(var a=i.slice(r,r+512),o=new Array(a.length),s=0;s<a.length;s++)o[s]=a.charCodeAt(s);var c=new Uint8Array(o);n.push(c)}return new Blob(n,{type:t})}};!function(e,t){"function"==typeof define&&define.amd?define([],t(window,null)):"object"==typeof exports?module.exports=t(null,require("fs")):e.codegrid=t(e,null)}(this,function(i,u){var g,l,p,m="../tiles/",f=[9,13],d={},e={};function h(e,t){return Math.floor(((e+180)/360%1+1)%1*Math.pow(2,t))}l=function(e,t,i,n){var u,l,p,m,s,c,d,r={};if(r.x=e,r.y=t,r.zoom=i,!n.hasOwnProperty("grid")||!n.hasOwnProperty("keys"))return console.warn("Error in creating grid - no grid/keys attribute"),null;function f(e){return 93<=e&&e--,35<=e&&e--,e-32}function _(e){return e%1==0}return l=n.grid,p=n.keys,n.hasOwnProperty("data")&&(m=n.data),u=n.grid.length,s=Math.round(Math.log(u)/Math.log(2))+i,c=e*Math.pow(2,s-i),d=t*Math.pow(2,s-i),r.getCode=function(e,t,i){var n=h(t,s)-c,r=v(e,s)-d;if(!_(n)||!_(r)||n<0||r<0||u<=n||u<=r)return console.warn("Error in arguments to retrieve grid"),void i("Error in input coordinates: out of range");var a=function(e,t){var i=l[t],n=i.length;if(1<n&&n<4){var r=parseInt(i);if(r.isNaN||r<0||u<=r)return console.warn("Error in decoding compressed grid"),null;n=(i=l[r]).length}var a=0;if(n===u)a=i.charCodeAt(e);else if(1===n)a=i.charCodeAt(0);else for(var o=0,s=e;o<n-1;o+=2)if((s-=f(i.charCodeAt(o+1)))<0){a=i.charCodeAt(o);break}var c=f(a);if(!c.isNaN&&p.length>c){var d=p[c];if(""===d)return{};if(void 0===m){if(g.hasOwnProperty(d))return g[d]}else if(m.hasOwnProperty(d))return m[d]}return console.warn("Error in decoding grid data."),null}(n,r);if(null!==a){var o="None";return a.hasOwnProperty("code")&&(o=a.code,a.hasOwnProperty("subcode")&&(o=o+":"+a.subcode)),void i(null,o)}i("Error reading geocode data")},r},p=function(e){var a,t={},r=[],s=e[0];function o(e,t,i){for(var n=0;n<r.length;n++)if(r[n].x===e&&r[n].y===t)return void i(null,r[n]);!function(i,n,r){var a=Math.floor(i/Math.pow(2,s-5)),o=Math.floor(n/Math.pow(2,s-5));void 0===d[a]||void 0===d[a][o]||void 0===d[a][o][s]?_(m+a.toString()+"/"+o.toString()+".json",function(e,t){return e?(r("Grid data loading error."),console.warn("Error loading grid tile data: "+e)):void 0===t[s]?(r("Zoom level "+s.toString()+" not in loaded data."),console.warn("Zoom level "+s.toString()+" not in loaded data.")):(c(i,n,t[s],r),void 0===d[a]&&(d[a]={}),void(d[a][o]=t))}):c(i,n,d[a][o][s],r)}(e,t,function(e,t){if(!e)return r.push(t),void i(null,t);i(e)})}function c(e,t,i,n){return void 0===i[e]||void 0===i[e][t]?(n("Grid tile not found in loaded data."),console.warn("Grid tile "+s.toString()+"/"+e.toString()+"/"+t.toString()+" not found in loaded data.")):(n(null,l(e,t,s,i[e][t])),null)}return 1<e.length&&(a=p(e.slice(1))),t.getCode=function(i,n,r){o(h(n,s),v(i,s),function(e,t){e?r("Error getting grid data: "+e):t.getCode(i,n,function(e,t){e?r(e,t):"*"===t?a.getCode(i,n,r):r(e,t)})})},t},e.CodeGrid=function(e,t){var a,o,n={},s=!1,c=!0,d=[];function r(e){g=e.data,null!==(o=l(0,0,0,e))&&(s=!0),c=!1}return e?m=e:"undefined"!=typeof __dirname&&u.readFile&&(m=__dirname+"/"+m),i||u.readFile||!window||(i=window),t?r(t):_(m+"worldgrid.json",function(e,t){if(e)return console.warn("Error loading geocoding data: "+e);var i;for(r(t);i=d.shift();)n.getCode(i[0],i[1],i[2]);return null}),a=p(f),n.getCode=function(i,n,r){if(!s)return c?void d.push([i,n,r]):(console.warn("Error : grid not initialized."),void r("Error: grid not initialized."));o.getCode(i,n,function(e,t){e?r(e,t):"*"===t?a.getCode(i,n,r):r(e,t)})},n};var n=Math.atan((Math.exp(Math.PI)-Math.exp(-Math.PI))/2)/Math.PI*180;function v(e,t){return Math.abs(e)>=n?-1:Math.floor((1-Math.log(Math.tan(e*Math.PI/180)+1/Math.cos(e*Math.PI/180))/Math.PI)/2*Math.pow(2,t))}function _(n,r){if(i)if(i.XMLHttpRequest&&"undefined"!=typeof JSON){var t=new XMLHttpRequest;t&&(t.open("GET",n,!0),t.setRequestHeader("X-Requested-With","XMLHttpRequest"),t.setRequestHeader("Content-type","application/json"),t.onreadystatechange=function(){if(4===t.readyState&&200===t.status){var e=JSON.parse(t.responseText);r(null,e)}else 4===t.readyState&&r("HTTP request returned "+t.status.toString())},t.send())}else r("JSON request not supported.");else u&&u.readFile(n,function(e,t){if(e)"ENOENT"===e.code?(console.warn("File "+n+" not found."),r("File "+n+" not found.")):(console.warn(e.message),r(e.message));else{var i=JSON.parse(t);r(null,i)}})}return e});
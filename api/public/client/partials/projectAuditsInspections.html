<div class="project-auditsandinspections">

    <div class="row">
        <div class="col-md-6">
            <div class="element-dropdown" dropdown ng-show="data.auditsinspections.length">
                <button class="btn btn-default dropdown-toggle" type="button" dropdown-toggle ng-disabled="isLoading()">
                    {{data.getAuditInspectionSummary()}}
                    <span class="caret"></span>
                </button>
                <ul class="dropdown-menu" role="menu">
                    <li ng-repeat="ai in data.auditsinspections" role="presentation">
                        <a role="menuitem" ng-href="#/projects/{{data.project.id}}/auditsinspections/{{ai.id}}">{{data.getAuditInspectionSummary(ai)}}</a>
                    </li>
                </ul>
            </div>

        </div>
        <div class="col-md-6">
            <div class="btn-group new-button pull-right" dropdown auto-close="disabled" is-open="newButton.isopen">
                <button type="button" class="btn btn-success" dropdown-toggle ng-disabled="isLoading()">
                    New Audit and Inspection <span class="caret"></span>
                </button>
                <ul class="dropdown-menu" role="menu">
                    <li role="menuitem">
                        <form role="form" name="newButton.form" novalidation>
                            <div class="rowzzz">
                                <div class="col-md-3">
                                    <label for="newButton.year">Year</label>
                                    <input type="text" integer
                                            id="newButton.year"
                                            ng-required="true"
                                            ng-model="newButton.year"
                                            class="form-control input-sm"/>
                                </div>
                                <div class="col-md-6">
                                    <label for="newButton.type">Type</label>
                                    <select ui-select2 id="newButton.type" class="form-control input-sm"
                                            ng-required="true"
                                            ng-model="newButton.type">
                                        <option ng-repeat="v in valuelists.auditinspectiontype" value="{{v.id}}">
                                            {{v.description1}}
                                        </option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="newButton.create">&nbsp;</label>
                                    <button type="button" class="btn btn-sm btn-primary use-button pull-right"
                                            id="newButton.create"
                                            ng-disabled="newButton.form.$invalid"
                                            ng-click="newAuditInspection()">Create
                                    </button>
                                </div>
                            </div>
                        </form>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <hr/>
        </div>
    </div>
    <div class="row" ng-show="isLoading()">
        <div class="col-md-12">
            <div class="loader-standalone center-block"></div>
        </div>
    </div>
    <div class="row" ng-show="hasAuditInspection() && !isLoading() && !newButton.isopen">
        <div class="col-md-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h2 class="panel-title" title="id={{data.auditinspection.id}}">Audit and Inspection (Dirty:{{parts.auditinspection.form.$dirty}}, valid:{{parts.auditinspection.form.$valid}})
                        <span class="loader pull-right"
                                ng-show="parts.auditinspection.state == SavingStateEnum.Loading"></span>
                        <span class="saving-message-inline pull-right"
                                ng-show="parts.auditinspection.state == SavingStateEnum.Loaded">Last changed by {{data.auditinspection.updated_by}}</span>
                        <span class="saving-message-inline pull-right"
                                ng-show="parts.auditinspection.state == SavingStateEnum.SavingStarted">Saving...</span>
                        <span class="saving-message-inline pull-right"
                                ng-show="parts.auditinspection.state == SavingStateEnum.SavingFinished">All changes saved</span>
                        <span class="saving-message-inline pull-right color-error"
                                ng-show="parts.auditinspection.state == SavingStateEnum.SavingFailed">Saving failed</span>
                        <span class="saving-message-inline pull-right color-error"
                                ng-show="parts.auditinspection.state == SavingStateEnum.Invalid">All required fields must be filled out</span>
                    </h2>
                </div>
                <div class="panel-body">
                    <form role="form" name="parts.auditinspection.form" novalidation>

                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="year">Year</label>
                                    <input type="text" integer ng-blur="saveCurrentAuditInspection()"
                                            readonly class="form-control input-sm" id="year"
                                            ng-model="data.auditinspection.year"/>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="type">Type</label>
                                    <select ui-select2 id="type" class="form-control input-sm"
                                            ng-change="saveCurrentAuditInspection()"
                                            ng-required="true"
                                            ng-disabled="!auth.canSave('type')"
                                            ng-model="data.auditinspection.type">
                                        <option ng-repeat="v in valuelists.auditinspectiontype" value="{{v.id}}">
                                            {{v.description1}}
                                        </option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="users">Participants from NEMA</label>
                                    <select ui-select2 multiple="true" placeholder="Click to pick"
                                            ng-change="saveCurrentAuditInspection()"
                                            ng-disabled="!auth.canSave('personnel')" id="users"
                                            class="form-control input-sm"
                                            ng-model="data.auditinspection.user_ids">
                                        <option ng-repeat="v in valuelists.officer" value="{{v.id}}">
                                            {{v.description1}}
                                        </option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">

                                    <label for="coordinated">Coordinated</label>
                                    <input type="checkbox" class="checkbox-small form-control input-sm" id="coordinated"
                                            ng-model="fake_coordinated" ng-checked="data.auditinspection.coordinated"
                                            ng-click="data.auditinspection.coordinated = !data.auditinspection.coordinated; saveCurrentAuditInspection()"
                                            ng-readonly="!auth.canSave('coordinated')"/>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="date_carried_out">Date carried out</label>
                                    <div class="input-group container-datepicker" ng-controller="DatePickerController">
                                        <input type="text" ng-blur="saveCurrentAuditInspection()"
                                                ng-readonly="!auth.canSave('date_carried_out')" id="date_carried_out"
                                                class="form-control input-sm input-date"
                                                ng-model="data.auditinspection.date_carried_out"
                                                data-datepicker-popup="d MMM yyyy" data-is-open="opened"
                                                data-datepicker-options="datepickerOptions"
                                                data-show-button-bar="false"/>
                                            <span class="input-group-btn">
                                              <button type="button" ng-disabled="!auth.canSave('date_inspection')"
                                                      class="btn btn-default btn-sm" ng-click="open($event)"><span
                                                      class="glyphicon glyphicon-calendar"></span></button>
                                            </span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="days">Number of days</label>
                                    <input type="text" integer ng-blur="saveCurrentAuditInspection()"
                                            ng-required="true"
                                            ng-readonly="!auth.canSave('days')" class="form-control input-sm" id="days"
                                            ng-model="data.auditinspection.days"/>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="external_participants">Participants from lead agencies, facilities etc.</label>
                                    <input type="text" ng-blur="saveCurrentAuditInspection()"
                                            ng-readonly="!auth.canSave('external_participants')"
                                            class="form-control input-sm" id="external_participants"
                                            ng-model="data.auditinspection.external_participants"/>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="advance_notice">Advanced notice</label>
                                    <input type="checkbox" class="checkbox-small form-control input-sm"
                                            id="advance_notice"
                                            ng-model="fake_advance_notice"
                                            ng-checked="data.auditinspection.advance_notice"
                                            ng-click="data.auditinspection.advance_notice = !data.auditinspection.advance_notice; saveCurrentAuditInspection()"
                                            ng-readonly="!auth.canSave('advance_notice')"/>

                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="date_action_taken">Date of action taken</label>
                                    <div class="input-group container-datepicker" ng-controller="DatePickerController">
                                        <input type="text" ng-blur="saveCurrentAuditInspection()"
                                                ng-readonly="!auth.canSave('date_action_taken')" id="date_action_taken"
                                                class="form-control input-sm input-date"
                                                ng-model="data.auditinspection.date_action_taken"
                                                data-datepicker-popup="d MMM yyyy" data-is-open="opened"
                                                data-datepicker-options="datepickerOptions"
                                                data-show-button-bar="false"/>
                                            <span class="input-group-btn">
                                              <button type="button" ng-disabled="!auth.canSave('date_action_taken')"
                                                      class="btn btn-default btn-sm" ng-click="open($event)"><span
                                                      class="glyphicon glyphicon-calendar"></span></button>
                                            </span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Action taken letter</label>
                                    <div class="uploaded-file" ng-show="data.auditinspection.file_metadata_id">
                                        <a ng-href="{{downloadFileUrl(data.auditinspection.file_metadata_id)}}" ng-show="data.auditinspection.action_taken_letter">{{data.auditinspection.action_taken_letter.filename}}</a>
                                        <button type="button" class="delete btn btn-sm btn-link"
                                                ng-click="deleteActionTakenLetter()"
                                                ng-hide="!auth.canSave('delete')">delete
                                        </button>
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-default"
                                                ngf-select="uploadActionTakenLetter($files)"
                                                accept="{{fileUploadPattern}}"
                                                ngf-pattern="{{fileUploadPattern}}"
                                                ng-model="fake_action_taken_letter"
                                                name="action_taken_letter"
                                                ng-hide="data.auditinspection.file_metadata_id"
                                                ng-disabled="!auth.canSave('delete')"
                                                ngf-max-size="10MB">
                                            Select File
                                        </button>
                                        <div class="uploading-file ng-hide cssSlideUp" ng-show="showUploadingFileActionTakenLetter">
                                            <div class="file">{{actionTakenLetterFile.name}}<br/>
                                                <div class="progress">
                                                    <div class="progress-bar" role="progressbar" aria-valuenow="{{actionTakenLetterFile.progress}}" aria-valuemin="0" aria-valuemax="100"
                                                            style="width: {{actionTakenLetterFile.progress}}%;">
                                                        {{actionTakenLetterFile.progress}}%
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="errors" ng-messages="parts.auditinspection.form.action_taken_letter.$error" role="alert">
                                                <div ng-message="pattern">The file type is not supported.</div>
                                                <div ng-message="serverError">Something went wrong on the server.</div>
                                                <div ng-message="maxSize">The file is to big.</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="lead_agencies">Lead agencies</label>
                                    <select ui-select2 multiple="true" placeholder="Click to pick"
                                            ng-change="saveCurrentAuditInspection()"
                                            ng-disabled="!auth.canSave('lead_agencies')" id="lead_agencies"
                                            class="form-control input-sm"
                                            ng-model="data.auditinspection.leadagency_ids">
                                        <option ng-repeat="v in valuelists.leadagency" value="{{v.id}}">
                                            {{v.description1}}
                                        </option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="action_taken">Action taken</label>
                                    <select ui-select2 ng-change="saveCurrentAuditInspection()"
                                            ng-disabled="!auth.canSave('action_taken')" id="action_taken" class="form-control input-sm"
                                            ng-model="data.auditinspection.action_taken">
                                        <option ng-repeat="v in valuelists.actiontaken" value="{{v.id}}">
                                            {{v.description1}}
                                        </option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="findings">Description of findings</label>
                                    <textarea class="form-control input-sm" rows="2" id="findings"
                                            ng-blur="saveCurrentAuditInspection()"
                                            ng-readonly="!auth.canSave('findings')"
                                            ng-model="data.auditinspection.findings"></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="timeframe">Timeframe for correcting deviations</label>
                                    <input type="text" integer class="form-control input-sm" id="timeframe"
                                            ng-blur="saveCurrentAuditInspection()"
                                            ng-required="false"
                                            ng-readonly="!auth.canSave('timeframe')"
                                            ng-model="data.auditinspection.timeframe"/>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="date_deadline">Deadline to correct deviations</label>
                                    <div class="input-group container-datepicker" ng-controller="DatePickerController">
                                        <input type="text" ng-blur="saveCurrentAuditInspection()"
                                                ng-readonly="!auth.canSave('date_deadline')" id="date_deadline"
                                                class="form-control input-sm input-date"
                                                ng-model="data.auditinspection.date_deadline"
                                                data-datepicker-popup="d MMM yyyy" data-is-open="opened"
                                                data-datepicker-options="datepickerOptions"
                                                data-show-button-bar="false"/>
                                            <span class="input-group-btn">
                                              <button type="button" ng-disabled="!auth.canSave('date_deadline')"
                                                      class="btn btn-default btn-sm" ng-click="open($event)"><span
                                                      class="glyphicon glyphicon-calendar"></span></button>
                                            </span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="recommendations">Recommendations</label>
                                    <textarea class="form-control input-sm" rows="2" id="recommendations"
                                            ng-blur="saveCurrentAuditInspection()"
                                            ng-readonly="!auth.canSave('recommendations')"
                                            ng-model="data.auditinspection.recommendations"></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="date_received">Date for receiving corrections</label>
                                    <div class="input-group container-datepicker" ng-controller="DatePickerController">
                                        <input type="text" ng-blur="saveCurrentAuditInspection()"
                                                ng-readonly="!auth.canSave('date_received')" id="date_received"
                                                class="form-control input-sm input-date"
                                                ng-model="data.auditinspection.date_received"
                                                data-datepicker-popup="d MMM yyyy" data-is-open="opened"
                                                data-datepicker-options="datepickerOptions"
                                                data-show-button-bar="false"/>
                                            <span class="input-group-btn">
                                              <button type="button" ng-disabled="!auth.canSave('date_received')"
                                                      class="btn btn-default btn-sm" ng-click="open($event)"><span
                                                      class="glyphicon glyphicon-calendar"></span></button>
                                            </span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="date_closing">Closing date</label>
                                    <div class="input-group container-datepicker" ng-controller="DatePickerController">
                                        <input type="text" ng-blur="saveCurrentAuditInspection()"
                                                ng-readonly="!auth.canSave('date_closing')" id="date_closing"
                                                class="form-control input-sm input-date"
                                                ng-model="data.auditinspection.date_closing"
                                                data-datepicker-popup="d MMM yyyy" data-is-open="opened"
                                                data-datepicker-options="datepickerOptions"
                                                data-show-button-bar="false"/>
                                            <span class="input-group-btn">
                                              <button type="button" ng-disabled="!auth.canSave('date_closing')"
                                                      class="btn btn-default btn-sm" ng-click="open($event)"><span
                                                      class="glyphicon glyphicon-calendar"></span></button>
                                            </span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="remarks">Remarks</label>
                                    <textarea class="form-control input-sm" rows="2" id="remarks"
                                            ng-blur="saveCurrentAuditInspection()"
                                            ng-readonly="!auth.canSave('remarks')"
                                            ng-model="data.auditinspection.remarks"></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Documentation</label>
                                    <div class="uploaded-files" ng-show="data.auditinspection.documentation">
                                        <div class="file" ng-repeat="d in data.auditinspection.documentation">
                                            <a ng-href="{{downloadFileUrl(d.id)}}">{{d.filename}}</a>
                                            <button type="button" class="delete btn btn-sm btn-link"
                                                    ng-click="deleteDocumentation(d.id)"
                                                    ng-hide="!auth.canSave('delete')">delete
                                            </button>
                                        </div>
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-default"
                                                ngf-select="uploadDocumentation($files)"
                                                accept="{{fileUploadPattern}}"
                                                ngf-pattern="{{fileUploadPattern}}"
                                                ng-model="fake_documentation"
                                                name="documentation"
                                                ng-disabled="!auth.canSave('delete')"
                                                ngf-max-size="10MB">
                                            Select File
                                        </button>
                                        <div class="uploading-file ng-hide cssSlideUp" ng-show="showUploadingFileDocumentation">
                                            <div class="file">{{documentationFile.name}}<br/>
                                                <div class="progress">
                                                    <div class="progress-bar" role="progressbar" aria-valuenow="{{documentationFile.progress}}" aria-valuemin="0" aria-valuemax="100"
                                                            style="width: {{documentationFile.progress}}%;">
                                                        {{documentationFile.progress}}%
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="errors" ng-messages="parts.auditinspection.form.documentation.$error" role="alert">
                                                <div ng-message="pattern">The file type is not supported.</div>
                                                <div ng-message="serverError">Something went wrong on the server.</div>
                                                <div ng-message="maxSize">The file is to big.</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <button type="button" class="btn btn-danger btn-sm pull-right"
                                        ng-click="deleteAuditInspection()" ng-hide="!auth.canSave('delete')">
                                    Delete Audit and Inspection
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

            </div>

        </div>

    </div>
</div>

